template:
  - sensor:
      - name: "House Power (excl. EV)"
        unique_id: house_power_excl_ev
        unit_of_measurement: "kW"
        state: >
          {# Power meter from your integration #}
          {% set net_power = states('sensor.power_meter_active_power') | float(0) %}
          {% set import = -net_power if net_power < 0 else 0 %}
          {% set export = net_power if net_power > 0 else 0 %}

          {# EV charger, optional via input_text #}
          {% set ev_sensor_id = states('input_text.ev_sensor') %}
          {% set ev_raw = states(ev_sensor_id) | float(0) if ev_sensor_id else 0 %}
          {% set ev = ev_raw / 1000 if ev_raw > 100 else ev_raw %}

          {# Solar production, optional via input_text #}
          {% set solar_sensor_id = states('input_text.solar_sensor') %}
          {% set solar_raw = states(solar_sensor_id) | float(0) if solar_sensor_id else 0 %}
          {% set solar = solar_raw / 1000 if solar_raw > 100 else solar_raw %}

          {# Battery from your integration #}
          {% set batt = states('sensor.batteries_charge_discharge_power') | float(0) %}
          {% set batt_out = -batt if batt < 0 else 0 %}
          {% set batt_in = batt if batt > 0 else 0 %}

          {# Calculate house power #}
          {% set house_power = (solar + import + batt_out) - (export + ev + batt_in) %}

          {{ [house_power, 0] | max | round(2) }}
