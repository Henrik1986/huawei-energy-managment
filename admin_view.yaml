type: sections
max_columns: 3
title: Smart Energy System
path: smart-energy-system
icon: mdi:dots-circle
sections:
  - type: grid
    cards:
      - type: heading
        heading: Energifl√∂de
        heading_style: subtitle
        icon: mdi:home-lightning-bolt
        badges: []
      - type: custom:energy-flow-card-plus
        entities:
          grid:
            entity:
              consumption: sensor.sem_import
              production: sensor.sem_export
          solar:
            entity: sensor.sem_solar_production
            display_zero_state: true
          battery:
            entity:
              consumption: sensor.batteries_day_discharge
              production: sensor.batteries_day_charge
          individual1:
            entity: sensor.sem_ev_charge
            name: Laddbox
            color: teal
        clickable_entities: false
        display_zero_lines: true
        use_new_flow_rate_model: false
        energy_date_selection: false
        wh_decimals: 2
        kwh_decimals: 1
        min_flow_rate: 1
        max_flow_rate: 6
        max_expected_energy: 2000
        min_expected_energy: 10
        wh_kwh_threshold: 1000
        grid_options:
          columns: 60
          rows: auto
        column_span: 2
      - type: heading
        heading: Systemets driftplan
        heading_style: subtitle
        icon: mdi:calendar-clock
        badges:
          - type: entity
            show_state: true
            show_icon: true
            entity: sensor.sem_nordpool_active
            name: Elpris
            icon: mdi:transmission-tower-import
            state_content:
              - name
              - state
        tap_action:
          action: navigate
          navigation_path: "#system_plan"
      - type: custom:vertical-stack-in-card
        cards:
          - type: custom:apexcharts-card
            update_interval: 1 min
            graph_span: 48h
            cache: false
            span:
              start: day
              offset: +0H
            header:
              title: Systemets driftplan
              show: false
              show_states: false
              colorize_states: true
            hours_12: false
            stacked: false
            experimental:
              color_threshold: true
            yaxis:
              - id: spotpris
                opposite: false
                show: true
                decimals: 1
                min: 0
                apex_config:
                  title:
                    text: Elpris (SEK/kWh)
              - id: solar_power
                opposite: true
                show: true
                apex_config:
                  title:
                    text: Solel (kWh)
              - id: charge/expensive
                opposite: true
                show: false
            apex_config:
              chart:
                height: 320
                animations:
                  enabled: true
                  easing: easeinout
                  speed: 800
                  animateGradually:
                    enabled: true
                    delay: 150
              legend:
                show: true
                floating: false
                offsetY: 5
                position: bottom
                fontSize: 10px
              tooltip:
                enabled: true
              xaxis:
                labels:
                  show: true
                  rotate: 0
                  rotateAlways: true
                  logarithmic: false
                  datetimeUTC: false
              stroke:
                width: 1
              plotOptions:
                candlestick:
                  colors:
                    upward: "#00B746"
                    downward: "#EF403C"
                  wick:
                    useFillColor: true
            all_series_config:
              show:
                legend_value: false
                datalabels: false
                in_brush: false
              float_precision: 3
              invert: false
              fill_raw: last
            now:
              show: true
              label: NU
              color: red
            series:
              - entity: sensor.sem_solar_forecast
                yaxis_id: solar_power
                data_generator: >
                  return entity.attributes.sem.watt_hours_period.map((entry) =>
                  {
                    const value = entry.values / 1000;
                    if (value <= 0) {
                      return [new Date(entry.date), null];
                    }
                    return [new Date(entry.date), value];
                  });
                name: Solel
                extend_to: false
                type: area
                color: orange
                opacity: 0.7
                stroke_width: 3
                color_threshold:
                  - value: 0
                    color: "#fff9c4"
                  - value: 5
                    color: "#ffeb3b"
                  - value: 15
                    color: "#fbc02d"
              - entity: sensor.sem_nordpool_active
                yaxis_id: spotpris
                type: area
                name: Idag
                opacity: 0.7
                color: grey
                extend_to: false
                data_generator: >
                  const data = entity.attributes.raw_today.map((start, index) =>
                  {
                    return [new Date(start["start"]).getTime(), start["value"]];
                  });

                  const last = entity.attributes.raw_today.slice(-1)[0];

                  const lastTime = new Date(last["start"]).getTime();

                  data.push([lastTime + 3600000, last["value"]]); // 

                  return data;
                color_threshold:
                  - value: -1
                    color: 1E90FF
                  - value: 0.5
                    color: "008000"
                  - value: 1
                    color: DAA520
                  - value: 2
                    color: FF0000
                show:
                  legend_value: false
                  datalabels: false
                  extremas: true
                  in_brush: false
                  in_legend: false
              - entity: sensor.sem_nordpool_active
                yaxis_id: spotpris
                name: Imorgon
                type: area
                opacity: 0.7
                color: grey
                data_generator: >
                  const data = entity.attributes.raw_tomorrow.map((start, index)
                  => {
                    return [new Date(start["start"]).getTime(), start["value"]];
                  });

                  const last = entity.attributes.raw_tomorrow.slice(-1)[0];
                  const lastTime = new Date(last["start"]).getTime();

                  data.push([lastTime + 3600000, last["value"]]);

                  return data;
                color_threshold:
                  - value: -1
                    color: 1E90FF
                  - value: 0.5
                    color: "008000"
                  - value: 1
                    color: DAA520
                  - value: 2
                    color: FF0000
                show:
                  legend_value: false
                  datalabels: false
                  extremas: true
                  in_brush: false
                  in_legend: false
              - entity: sensor.sem_battery_cheap_interval_2_1a
                yaxis_id: charge/expensive
                name: Vilol√§ge
                opacity: 0.7
                color: "#D3D3D3"
                type: area
                data_generator: |
                  const data = [];
                  const sensorData = entity.state.split(' - ');
                  function parseLocalTime(str) {
                    const parts = str.split(/[- :T]/).map(Number);
                    const date = new Date(parts[0], parts[1] - 1, parts[2], parts[3], parts[4]);
                    return date.getTime();
                  }
                  const startTime = parseLocalTime(sensorData[0]);
                  const endTime = parseLocalTime(sensorData[1]);
                  data.push([startTime, 0.75]);
                  data.push([startTime, 0.75]);
                  data.push([endTime, 0.75]);
                  data.push([endTime, 0]);
                  return data;
                show:
                  legend_value: false
                  datalabels: false
                  extremas: false
                  in_brush: false
                  in_legend: true
              - entity: sensor.sem_battery_cheap_interval_1a_2
                yaxis_id: charge/expensive
                name: Vilol√§ge
                opacity: 0.7
                color: "#D3D3D3"
                type: area
                data_generator: |
                  const data = [];
                  const sensorData = entity.state.split(' - ');
                  function parseLocalTime(str) {
                    const parts = str.split(/[- :T]/).map(Number);
                    const date = new Date(parts[0], parts[1] - 1, parts[2], parts[3], parts[4]);
                    return date.getTime();
                  }
                  const startTime = parseLocalTime(sensorData[0]);
                  const endTime = parseLocalTime(sensorData[1]);
                  data.push([startTime, 0.75]);
                  data.push([startTime, 0.75]);
                  data.push([endTime, 0.75]);
                  data.push([endTime, 0]);
                  return data;
                show:
                  legend_value: false
                  datalabels: false
                  extremas: false
                  in_brush: false
                  in_legend: false
              - entity: sensor.sem_export_limit
                yaxis_id: charge/expensive
                name: Begr√§nsar solexport
                opacity: 0.7
                color: BBCDDD
                type: area
                data_generator: |
                  const data = [];
                  const sensorData = entity.state.split(' - ');
                  function parseLocalTime(str) {
                    const parts = str.split(/[- :T]/).map(Number);
                    const date = new Date(parts[0], parts[1] - 1, parts[2], parts[3], parts[4]);
                    return date.getTime();
                  }
                  const startTime = parseLocalTime(sensorData[0]);
                  const endTime = parseLocalTime(sensorData[1]);
                  data.push([startTime, 0.5]);
                  data.push([startTime, 0.5]);
                  data.push([endTime, 0.5]);
                  data.push([endTime, 0]);
                  return data;
                show:
                  legend_value: false
                  datalabels: false
                  extremas: false
                  in_brush: false
                  in_legend: true
              - entity: sensor.sem_battery_use_interval_1
                yaxis_id: charge/expensive
                name: Prioterad batteridrift
                opacity: 0.4
                color: lime
                type: area
                data_generator: |
                  const data = [];
                  const sensorData = entity.state.split(' - ');
                  function parseLocalTime(str) {
                    const parts = str.split(/[- :T]/).map(Number);
                    const date = new Date(parts[0], parts[1] - 1, parts[2], parts[3], parts[4]);
                    return date.getTime();
                  }
                  const startTime = parseLocalTime(sensorData[0]);
                  const endTime = parseLocalTime(sensorData[1]);
                  data.push([startTime, 0.7]);
                  data.push([startTime, 0.7]);
                  data.push([endTime, 0.7]);
                  data.push([endTime, 0]);
                  return data;
                show:
                  legend_value: false
                  datalabels: false
                  extremas: false
                  in_brush: false
                  in_legend: true
              - entity: sensor.sem_battery_use_interval_2
                yaxis_id: charge/expensive
                name: Prioterad batteridrift
                opacity: 0.4
                color: lime
                type: area
                data_generator: |
                  const data = [];
                  const sensorData = entity.state.split(' - ');
                  function parseLocalTime(str) {
                    const parts = str.split(/[- :T]/).map(Number);
                    const date = new Date(parts[0], parts[1] - 1, parts[2], parts[3], parts[4]);
                    return date.getTime();
                  }
                  const startTime = parseLocalTime(sensorData[0]);
                  const endTime = parseLocalTime(sensorData[1]);
                  data.push([startTime, 0.7]);
                  data.push([startTime, 0.7]);
                  data.push([endTime, 0.7]);
                  data.push([endTime, 0]);
                  return data;
                show:
                  legend_value: false
                  datalabels: false
                  extremas: false
                  in_brush: false
                  in_legend: false
              - entity: sensor.sem_battery_charge_window_cheapest_1a
                yaxis_id: charge/expensive
                name: Laddningsf√∂nster
                opacity: 0.7
                color: "#00406c"
                type: area
                data_generator: |
                  const data = [];
                  const sensorData = entity.state.split(' - ');
                  function parseLocalTime(str) {
                    const parts = str.split(/[- :T]/).map(Number);
                    const date = new Date(parts[0], parts[1] - 1, parts[2], parts[3], parts[4]);
                    return date.getTime();
                  }
                  const startTime = parseLocalTime(sensorData[0]);
                  const endTime = parseLocalTime(sensorData[1]);
                  data.push([startTime, 1]);
                  data.push([startTime, 1]);
                  data.push([endTime, 1]);
                  data.push([endTime, 0]);
                  return data;
                show:
                  legend_value: false
                  datalabels: false
                  extremas: false
                  in_brush: false
                  in_legend: true
              - entity: sensor.sem_battery_charge_window_cheapest_2
                yaxis_id: charge/expensive
                name: Laddningsf√∂nster 2
                opacity: 0.7
                color: "#00406c"
                type: area
                data_generator: |
                  const data = [];
                  const sensorData = entity.state.split(' - ');
                  function parseLocalTime(str) {
                    const parts = str.split(/[- :T]/).map(Number);
                    const date = new Date(parts[0], parts[1] - 1, parts[2], parts[3], parts[4]);
                    return date.getTime();
                  }
                  const startTime = parseLocalTime(sensorData[0]);
                  const endTime = parseLocalTime(sensorData[1]);
                  data.push([startTime, 1]);
                  data.push([startTime, 1]);
                  data.push([endTime, 1]);
                  data.push([endTime, 0]);
                  return data;
                show:
                  legend_value: false
                  datalabels: false
                  extremas: false
                  in_brush: false
                  in_legend: false
          - type: custom:vertical-stack-in-card
            cards: []
        grid_options:
          columns: full
          rows: auto
    column_span: 2
  - type: grid
    cards:
      - type: heading
        heading_style: subtitle
        heading: √ñversikt
        icon: mdi:account-eye
      - type: custom:vertical-stack-in-card
        cards:
          - type: custom:gap-card
            height: 10
          - type: custom:vertical-stack-in-card
            cards:
              - type: custom:vertical-stack-in-card
                cards:
                  - square: false
                    type: grid
                    cards:
                      - clock_style: analog
                        clock_size: small
                        show_seconds: true
                        no_background: false
                        border: false
                        ticks: hour
                        type: clock
                      - show_current: false
                        show_forecast: true
                        type: weather-forecast
                        entity: weather.smhi_home
                        forecast_type: daily
                        forecast_slots: 3
                        tap_action:
                          action: none
                        name: HEM
                    columns: 2
                view_layout:
                  position: sidebar
            view_layout:
              position: sidebar
          - type: tile
            entity: sensor.sem_house_power
            name: Huset
            icon: mdi:home
            color: blue-grey
            show_entity_picture: false
            hide_state: false
            vertical: false
            tap_action:
              action: navigate
              navigation_path: "#house"
            hold_action:
              action: navigate
              navigation_path: "#house"
            icon_tap_action:
              action: navigate
              navigation_path: "#house"
            features:
              - type: trend-graph
            features_position: bottom
          - square: false
            type: grid
            cards:
              - type: tile
                entity: sensor.power_meter_active_power
                name: Eln√§tet
                icon: mdi:transmission-tower
                color: red
                vertical: false
                tap_action:
                  action: navigate
                  navigation_path: "#grid"
                icon_tap_action:
                  action: navigate
                  navigation_path: "#grid"
                features_position: bottom
              - type: tile
                entity: sensor.sem_input_power_with_efficiency_loss_kw
                name: Solceller
                icon: mdi:solar-power-variant
                color: primary
                vertical: false
                tap_action:
                  action: navigate
                  navigation_path: "#solar"
                icon_tap_action:
                  action: navigate
                  navigation_path: "#solar"
                features_position: inline
              - type: conditional
                conditions:
                  - condition: state
                    entity: sensor.sem_wallbox_check
                    state: "True"
                card:
                  type: tile
                  entity: sensor.sem_ev_sensor_power
                  name: Elbil
                  icon: mdi:ev-plug-type2
                  color: blue
                  vertical: false
                  tap_action:
                    action: navigate
                    navigation_path: "#wallbox"
                  icon_tap_action:
                    action: navigate
                    navigation_path: "#wallbox"
                  features_position: inline
          - type: tile
            entity: sensor.batteries_charge_discharge_power
            name: Batteriet
            icon: mdi:battery-charging-100
            color: indigo
            vertical: false
            tap_action:
              action: navigate
              navigation_path: "#battery"
            icon_tap_action:
              action: navigate
              navigation_path: "#battery"
            features:
              - type: trend-graph
            features_position: inline
          - square: false
            type: grid
            cards:
              - type: tile
                entity: sensor.sem_battery_mode
                name: Arbetsl√§ge
                icon: mdi:auto-mode
                color: indigo
                hide_state: false
                vertical: false
                tap_action:
                  action: navigate
                  navigation_path: "#battery"
                icon_tap_action:
                  action: navigate
                  navigation_path: "#battery"
                features_position: bottom
              - type: tile
                entity: sensor.batteries_state_of_capacity
                name: Niv√•
                icon: mdi:battery
                color: indigo
                show_entity_picture: false
                hide_state: false
                vertical: false
                tap_action:
                  action: navigate
                  navigation_path: "#battery"
                icon_tap_action:
                  action: navigate
                  navigation_path: "#battery"
                features_position: inline
            columns: 2
        view_layout:
          position: sidebar
      - type: heading
        heading_style: subtitle
        heading: Kontrollpanel
        icon: mdi:cog
      - square: false
        type: grid
        cards:
          - type: tile
            grid_options:
              columns: 12
              rows: 1
            entity: input_button.sem_settings_fast
            name: Snabbval
            icon: mdi:order-bool-descending
            color: primary
            show_entity_picture: false
            hide_state: true
            vertical: true
            tap_action:
              action: navigate
              navigation_path: "#settings_fast"
            hold_action:
              action: navigate
              navigation_path: "#settings_fast"
            icon_tap_action:
              action: navigate
              navigation_path: "#settings_fast"
            features_position: bottom
          - type: tile
            grid_options:
              columns: 12
              rows: 1
            entity: input_button.sem_settings
            name: Mitt system
            icon: mdi:account
            color: primary
            hide_state: true
            vertical: true
            tap_action:
              action: navigate
              navigation_path: "#settings"
            hold_action:
              action: navigate
              navigation_path: "#settings"
            icon_tap_action:
              action: navigate
              navigation_path: "#settings"
            features_position: bottom
        columns: 2
      - type: heading
        heading_style: subtitle
        heading: N√§sta laddning
        icon: mdi:battery-clock
      - type: custom:vertical-stack-in-card
        cards:
          - type: conditional
            conditions: []
            card:
              type: conditional
              conditions:
                - condition: state
                  entity: sensor.sem_battery_charging_interval_next
                  state: "2"
              card:
                type: custom:vertical-stack-in-card
                cards:
                  - type: markdown
                    content: |2
                        {% set interval = states('sensor.sem_battery_charge_window_cheapest_2') %}
                        {% set energy = states('sensor.sem_battery_charge_energy_2_1b') %}
                        {% if ' - ' in interval %}
                          {% set start_str, end_str = interval.split(' - ') %}
                          {% set start_time = start_str | as_datetime %}
                          {% set end_time = end_str | as_datetime %}
                          {% set supercheap = state_attr('sensor.sem_battery_charge_energy_2_1b','supercheap_charge') %}
                          
                          üïõKlockan: {{ start_time.strftime('%H:%M') }} - {{ end_time.strftime('%H:%M')}}{% set sc = state_attr('sensor.sem_battery_charge_energy_2_1b', 'should_charge') %}{% if sc == true%}
                          ‚ö°Laddningsbeslut: Ladda{% else %}
                        ‚ùå Laddningsbeslut: Ladda ej {% endif %}
                        üîãBer√§knad laddning: {{ energy }} kWh
                        üí∞Extra superbillig laddning: {{ supercheap }} kWh
                        {% if is_state('input_boolean.sem_interval_2', 'on') %} ‚úÖStatus: Laddar {% else %} üí§Status: Inaktiv {% endif %}
                        {% else %}
                          Ingen tid tillg√§nglig  
                        {% endif %}
                    tap_action:
                      action: navigate
                      navigation_path: "#settings"
          - type: conditional
            conditions: []
            card:
              type: conditional
              conditions:
                - condition: state
                  entity: sensor.sem_battery_charging_interval_next
                  state: "1"
              card:
                type: custom:vertical-stack-in-card
                cards:
                  - type: markdown
                    content: >-
                      {% set interval =
                      states('sensor.sem_battery_charge_window_cheapest_1a') %}
                        {% set energy = states('sensor.sem_battery_charge_energy_1a_2') %}
                        {% if ' - ' in interval %}
                          {% set start_str, end_str = interval.split(' - ') %}
                          {% set start_time = start_str | as_datetime %}
                          {% set end_time = end_str | as_datetime %}
                          {% set supercheap = state_attr('sensor.sem_battery_charge_energy_1a_2','supercheap_charge') %}
                          üïêKlockan: {{ start_time.strftime('%H:%M') }} - {{ end_time.strftime('%H:%M') }}</b> 
                      {% set sc =
                      state_attr('sensor.sem_battery_charge_energy_1a_2',
                      'should_charge') %}{% if sc == true%}‚ö°Laddningsbeslut:
                      Ladda{% else %} ‚ùå Laddningsbeslut: Ladda ej {% endif %}
                          üîãBer√§knad laddning: {{ energy }} kWh
                          üí∞Extra superbillig laddning: {{ supercheap }} kWh
                          {% if is_state('input_boolean.sem_interval_1a', 'on') %} ‚úÖStatus: Laddar {% else %} üí§Status: Inaktiv {% endif %}
                        {% else %}
                          Ingen tid tillg√§nglig  
                        {% endif %}
                    tap_action:
                      action: navigate
                      navigation_path: "#settings"
            grid_options:
              columns: 12
              rows: 1
  - type: grid
    cards:
      - type: vertical-stack
        cards:
          - type: custom:bubble-card
            card_type: pop-up
            hash: "#config_1"
            show_header: false
            background_update: false
            width_desktop: 600px
            close_action:
              navigation_path: "#settings"
          - type: custom:vertical-stack-in-card
            cards:
              - type: heading
                icon: ""
                heading_style: title
                heading: Konfiguration
              - type: picture-elements
                elements: []
                image: /api/image/serve/e83b35c09064e00c5f35034371a70519/512x512
                style:
                  top: 5%
                  left: 5%
                  width: 3%
              - type: entities
                entities:
                  - entity: input_text.sem_user_access_code
                    tap_action:
                      action: nothing
                    icon_tap_action:
                      action: nothing
              - type: markdown
                content: >+
                  {% set user_code = states('input_text.sem_user_access_code') |
                  trim %}

                  {% set codes_raw = states('sensor.sem_sys_state') %}

                  {% set codes_list = codes_raw.split(',') | map('trim') | list
                  %}

                  {% if user_code in codes_list %}
                    **Anv√§ndarID**
                    ‚úÖ OK
                  {% else %}
                    **Anv√§ndarID**
                    ‚ùå Ogiltlig kod
                  {% endif %}



                  {# Lista √∂ver entiteter att kontrollera #}

                  {% set e1 = 'sensor.batteries_state_of_capacity' %}

                  {% set e2 = 'input_number.sem_batteries_end_of_discharge_soc'
                  %}

                  {% set e3 = 'sensor.inverter_input_power' %}

                  {% set e4 = 'sensor.power_meter_active_power' %}

                  {% set e5 = 'sensor.batteries_charge_discharge_power' %}

                  {% set e6 = 'select.batteries_working_mode' %}

                  {% set e7 = 'number.batteries_grid_charge_maximum_power' %}

                  {% set e8 = 'number.batteries_maximum_discharging_power' %}


                  {# H√§mta states #}

                  {% set s1 = states(e1) %}

                  {% set s2 = states(e2) %}

                  {% set s3 = states(e3) %}

                  {% set s4 = states(e4) %}

                  {% set s5 = states(e5) %}

                  {% set s6 = states(e6) %}

                  {% set s7 = states(e7) %}

                  {% set s8 = states(e8) %}


                  {# Definiera vad som r√§knas som otillg√§ngligt #}

                  {% set bad = ['unknown', 'unavailable', '', None] %}


                  {# R√§kna antal otillg√§ngliga #}

                  {% set cnt =
                    ((s1 in bad) | int) +
                    ((s2 in bad) | int) +
                    ((s3 in bad) | int) +
                    ((s4 in bad) | int) +
                    ((s5 in bad) | int) +
                    ((s6 in bad) | int) +
                    ((s7 in bad) | int) +
                    ((s8 in bad) | int)
                  %}


                  {# Utdatat #}

                  {% if cnt == 0 %}

                  **Huawei**

                  ‚úÖ OK

                  {% else %}

                  **Huawei**

                  ‚ùå Enheter saknas eller har felaktigt namn ({{ cnt }})

                  {% if s1 in bad %}- {{ e1 }}{% endif %}

                  {% if s2 in bad %}- {{ e2 }}{% endif %}

                  {% if s3 in bad %}- {{ e3 }}{% endif %}

                  {% if s4 in bad %}- {{ e4 }}{% endif %}

                  {% if s5 in bad %}- {{ e5 }}{% endif %}

                  {% if s6 in bad %}- {{ e6 }}{% endif %}

                  {% if s7 in bad %}- {{ e7 }}{% endif %}

                  {% if s8 in bad %}- {{ e8 }}{% endif %}

                  {% endif %}



                  {% if states('weather.smhi_home') not in ['unknown',
                  'unavailable', ''] %}

                  **SMHI**
                    ‚úÖ OK
                  {% else %}

                  **SMHI**
                    ‚ùå weather.smhi_home saknas
                  {% endif %}


                  {% if integration_entities('nordpool') | count > 0 %}

                  **Nordpool**
                    ‚úÖ OK
                  {% else %}

                  **Nordpool**
                    ‚ùå Nordpool saknas
                  {% endif %}


                  {% set missing = [] %}


                  {% if states('sensor.sem_hacs_apexcharts_card') != 'OK' %}
                    {% set missing = missing + ['ApexCharts Card'] %}
                  {% endif %}


                  {% if states('sensor.sem_hacs_bubble_card') != 'OK' %}
                    {% set missing = missing + ['Bubble Card'] %}
                  {% endif %}


                  {% if states('sensor.sem_hacs_energy_flow_card_plus') != 'OK'
                  %}
                    {% set missing = missing + ['Energy Flow Card Plus'] %}
                  {% endif %}


                  {% if states('sensor.sem_hacs_lovelace_layout_card') != 'OK'
                  %}
                    {% set missing = missing + ['Lovelace Layout Card'] %}
                  {% endif %}


                  {% if states('sensor.sem_hacs_vertical_stack_in_card') != 'OK'
                  %}
                    {% set missing = missing + ['Vertical Stack In Card'] %}
                  {% endif %}

                  **HACS**

                  {{ '‚úÖ OK' if missing | length == 0 else '‚ùå Saknas: ' ~
                  (missing | join(', ')) }}



                  **‚ö†Ô∏è VARNING!**

                  Detta √§r ett hobbyprojekt ‚Äì anv√§nd p√• eget ansvar. 

              - type: tile
                entity: input_button.sem_config_2
                name: Starta konfigurationen
                icon: mdi:arrow-right
                color: green
                hide_state: true
                vertical: true
                tap_action:
                  action: navigate
                  navigation_path: "#config_2"
                icon_tap_action:
                  action: navigate
                  navigation_path: "#config_2"
                features_position: bottom
      - type: vertical-stack
        cards:
          - type: custom:bubble-card
            card_type: pop-up
            hash: "#config_2"
            show_header: false
            background_update: false
            width_desktop: 600px
            close_action:
              navigation_path: "#settings"
          - type: custom:vertical-stack-in-card
            cards:
              - type: heading
                icon: ""
                heading_style: title
                heading: Generell information
              - type: heading
                icon: ""
                heading: Nordpool
                heading_style: subtitle
              - type: tile
                entity: input_boolean.sem_use_official_nordpool
                name: Officiella integrationen
                icon: mdi:dots-horizontal
                color: green
                hide_state: true
                vertical: false
                tap_action:
                  action: none
                icon_tap_action:
                  action: none
                features:
                  - type: toggle
                features_position: inline
              - type: conditional
                conditions:
                  - condition: state
                    entity: input_boolean.sem_use_official_nordpool
                    state: "off"
                card:
                  type: markdown
                  content: >-
                    **‚ÑπÔ∏èInformation**

                    Aktivera reglaget om du anv√§nder den officiella
                    integrationen ‚Äì annars l√§mna det avst√§ngt.
                  text_only: true
              - type: conditional
                conditions:
                  - condition: state
                    entity: input_boolean.sem_use_official_nordpool
                    state: "on"
                card:
                  type: vertical-stack
                  cards:
                    - type: entities
                      entities:
                        - entity: input_text.sem_nordpool_config_entry_official
                          name: Config Entry
                          tap_action:
                            action: none
                          icon_tap_action:
                            action: none
                        - entity: input_text.sem_nordpool_area_official
                          name: Ditt elomr√•de
                          tap_action:
                            action: none
                          icon_tap_action:
                            action: none
                    - type: markdown
                      content: >
                        **‚ÑπÔ∏èInformation**

                        Du hittar config entry s√• h√§r: 

                        Utvecklarverktyg - √Ötg√§rder - klicka p√• g√• ill UI-l√§get
                        - V√§lj nordpool.get_prices under √•tg√§rd - klicka p√• g√•
                        till yaml-l√§ge.
              - type: conditional
                conditions:
                  - condition: state
                    entity: input_boolean.sem_use_official_nordpool
                    state: "off"
                card:
                  type: vertical-stack
                  cards:
                    - type: entities
                      entities:
                        - entity: input_text.sem_nordpool_sensor_inofficial
                          name: Din inofficiella Nordpool sensor
                          tap_action:
                            action: none
                          icon_tap_action:
                            action: none
              - type: heading
                icon: ""
                heading_style: subtitle
                heading: Huawei batteri ID
              - type: entities
                entities:
                  - entity: input_text.sem_device_id
                    tap_action:
                      action: none
                    icon_tap_action:
                      action: none
              - type: markdown
                content: >-
                  **‚ÑπÔ∏èInformation**

                  Ditt Huawei batteri ID: 

                  Utvecklarverktyg -> √Ötg√§rder -> Klicka p√• √•tg√§rd -> Skriv
                  huawei -> V√§lj forcible charge -> Klicka p√• g√• till UI-l√§ge ->
                  V√§lj Batteries i rullgardinen p√• raden battery -> Klicka p√• g√•
                  till YAML-l√§ge 
              - type: heading
                icon: ""
                heading_style: subtitle
                heading: Huawei inverter ID
              - type: entities
                entities:
                  - entity: input_text.sem_device_id_inverter
                    tap_action:
                      action: none
                    icon_tap_action:
                      action: none
              - type: markdown
                content: >-
                  **‚ÑπÔ∏èInformation**

                  Ditt Huawei inverter ID: 

                  Utvecklarverktyg -> √Ötg√§rder -> Klicka p√• √•tg√§rd -> Skriv
                  huawei -> V√§lj limit the power fed to grid -> Klicka p√• g√•
                  till UI-l√§ge -> V√§lj Inverter i rullgardinen p√• raden inverter
                  -> Klicka p√• g√• till YAML-l√§ge 
              - type: heading
                heading_style: subtitle
                heading: V√§derprognos
              - type: entities
                entities:
                  - entity: input_text.sem_weather_sensor
                    name: Din SMHI sensor
                    icon: mdi:weather-partly-cloudy
                    tap_action:
                      action: none
                    icon_tap_action:
                      action: none
              - type: markdown
                content: >-
                  **‚ÑπÔ∏èInformation**

                  Du kan anv√§nda din befintliga v√§rder sensor fr√•n SMHI, men d√•
                  f√•r du √§ndra v√§rderkortet i hemvyn. Anv√§nd weather.smhi_home
                  f√∂r att slippa √§ndra i hemvyn. Om du inte redan skapa en ny
                  v√§dersensor kan det vara bra att g√∂ra det nu. 
              - square: false
                type: grid
                cards:
                  - type: tile
                    entity: input_boolean.sem_step_0
                    name: Tillbaka
                    icon: mdi:arrow-left
                    color: disabled
                    hide_state: true
                    vertical: false
                    tap_action:
                      action: navigate
                      navigation_path: "#config_1"
                    icon_tap_action:
                      action: navigate
                      navigation_path: "#config_1"
                    features_position: bottom
                  - type: tile
                    entity: input_boolean.sem_step_1
                    name: Forts√§tt
                    icon: mdi:arrow-right
                    color: disabled
                    hide_state: true
                    vertical: false
                    tap_action:
                      action: navigate
                      navigation_path: "#config_3"
                    icon_tap_action:
                      action: navigate
                      navigation_path: "#config_3"
                    features_position: bottom
                columns: 2
              - type: markdown
                content: |
                  <center> 1 av 4 </center>
      - type: vertical-stack
        cards:
          - type: custom:bubble-card
            card_type: pop-up
            hash: "#config_3"
            show_header: false
            background_update: false
            width_desktop: 600px
            close_action:
              navigation_path: "#settings"
          - type: custom:vertical-stack-in-card
            cards:
              - type: heading
                icon: mdi:solar-power-variant
                heading_style: title
                heading: Solceller
              - type: heading
                icon: ""
                heading: Din plats
                heading_style: subtitle
              - type: entities
                entities:
                  - entity: input_number.sem_solar_lat
                    name: Latitud
                    icon: mdi:earth
                  - entity: input_number.sem_solar_lon
                    icon: mdi:earth
                    name: Longitud
              - type: markdown
                content: |-
                  **‚ÑπÔ∏èInformation**
                  Latitud: s√∂der= -90 och norr= 90.
                  Longitud: v√§st= -180 och √∂st= 180. 
                  https://www.gps-coordinates.net/ 
              - type: tile
                entity: input_boolean.sem_solar_2
                name: Tv√• anl√§ggningar
                icon: mdi:solar-power
                color: green
                hide_state: true
                vertical: false
                tap_action:
                  action: toggle
                features:
                  - type: toggle
                features_position: inline
              - type: heading
                icon: ""
                heading: "Din installation "
                heading_style: subtitle
              - type: conditional
                conditions:
                  - condition: state
                    entity: input_boolean.sem_solar_2
                    state: "off"
                card:
                  type: custom:vertical-stack-in-card
                  cards:
                    - type: heading
                      icon: mdi:solar-panel
                      heading: Anl√§ggning 1
                      heading_style: subtitle
                    - type: conditional
                      conditions:
                        - condition: state
                          entity: input_boolean.sem_solar_2
                          state: "off"
                      card:
                        type: entities
                        entities:
                          - entity: input_number.sem_solar_dec
                            name: Lutning
                            icon: mdi:angle-acute
                          - entity: input_number.sem_solar_az
                            name: Riktning
                            icon: mdi:compass
                          - entity: input_number.sem_solar_kwp
                            name: Kapacitet
                            icon: mdi:solar-panel
                    - type: heading
                      icon: ""
                      heading: D√§mpingsfaktor
                      heading_style: subtitle
                    - type: entities
                      entities:
                        - entity: input_number.sem_solar_damping_morning
                          icon: mdi:weather-sunset-up
                          name: Morgon
                        - entity: input_number.sem_solar_damping_evening
                          icon: mdi:weather-sunset-down
                          name: Kv√§ll
                    - type: markdown
                      content: >-
                        **‚ÑπÔ∏èInformation**

                        Lutning

                        0¬∞ = helt plant (horisontellt)

                        90¬∞ = rakt upp (vertikalt)


                        Riktning 

                        180¬∞ = norr

                        -90¬∞ = √∂st

                        0¬∞ = syd

                        90¬∞ = v√§st


                        Kapacitet (kWp)

                        Den totala installerade effekten f√∂r panelgruppen.

                        L√§s mer: https://doc.forecast.solar/api:estimate


                        Om laddningen fr√•n solen underskattas h√∂j v√§rdet. Om
                        laddningen √∂verskattas s√§nk v√§rdet


                        Rekommenderat startv√§rde: 0.6

                        L√§s mer: https://doc.forecast.solar/damping
              - type: conditional
                conditions:
                  - condition: state
                    entity: input_boolean.sem_solar_2
                    state: "on"
                card:
                  type: custom:vertical-stack-in-card
                  cards:
                    - type: heading
                      icon: mdi:solar-panel
                      heading: Anl√§ggning 1
                      heading_style: subtitle
                    - type: entities
                      entities:
                        - entity: input_number.sem_solar_dec
                          name: Lutning
                          icon: mdi:angle-acute
                        - entity: input_number.sem_solar_az
                          name: Riktning
                          icon: mdi:compass
                        - entity: input_number.sem_solar_kwp
                          name: Kapacitet
                          icon: mdi:solar-panel
                    - type: heading
                      icon: ""
                      heading: D√§mpingsfaktor
                      heading_style: subtitle
                    - type: entities
                      entities:
                        - entity: input_number.sem_solar_damping_morning
                          icon: mdi:weather-sunset-up
                          name: Morgon
                        - entity: input_number.sem_solar_damping_evening
                          icon: mdi:weather-sunset-down
                          name: Kv√§ll
                    - type: divider
                    - type: heading
                      icon: mdi:solar-panel
                      heading: Anl√§ggning 2
                      heading_style: subtitle
                    - type: entities
                      entities:
                        - entity: input_number.sem_solar_dec_2
                          name: Lutning
                          icon: mdi:angle-acute
                        - entity: input_number.sem_solar_az_2
                          name: Riktning
                          icon: mdi:compass
                        - entity: input_number.sem_solar_kwp_2
                          name: Kapacitet
                          icon: mdi:solar-panel
                    - type: heading
                      icon: ""
                      heading: D√§mpingsfaktor
                      heading_style: subtitle
                    - type: entities
                      entities:
                        - entity: input_number.sem_solar_damping_morning_2
                          icon: mdi:weather-sunset-up
                          name: Morgon
                        - entity: input_number.sem_solar_damping_evening_2
                          icon: mdi:weather-sunset-down
                          name: Kv√§ll
                    - type: markdown
                      content: >-
                        **‚ÑπÔ∏èInformation**

                        Lutning

                        0¬∞ = helt plant (horisontellt)

                        90¬∞ = rakt upp (vertikalt)


                        Riktning 

                        180¬∞ = norr

                        -90¬∞ = √∂st

                        0¬∞ = syd

                        90¬∞ = v√§st


                        Kapacitet (kWp)

                        Den totala installerade effekten f√∂r panelgruppen.

                        L√§s mer: https://doc.forecast.solar/api:estimate


                        Om laddningen fr√•n solen underskattas h√∂j v√§rdet. Om
                        laddningen √∂verskattas s√§nk v√§rdet


                        Rekommenderat startv√§rde: 0.6

                        L√§s mer: https://doc.forecast.solar/damping
              - type: markdown
                content: >-
                  **‚ö†Ô∏è VARNING!**

                  Det publika API:et till√•ter max 12 anrop per rullande timme. I
                  denna setup g√∂rs endast ett anrop per timme.
              - square: false
                type: grid
                cards:
                  - type: tile
                    entity: input_boolean.sem_step_1
                    name: Tillbaka
                    icon: mdi:arrow-left
                    color: disabled
                    hide_state: true
                    vertical: false
                    tap_action:
                      action: navigate
                      navigation_path: "#config_2"
                    icon_tap_action:
                      action: navigate
                      navigation_path: "#config_2"
                    features_position: bottom
                  - type: tile
                    entity: input_boolean.sem_step_2
                    name: Forts√§tt
                    icon: mdi:arrow-right
                    color: disabled
                    hide_state: true
                    vertical: false
                    tap_action:
                      action: navigate
                      navigation_path: "#config_4"
                    icon_tap_action:
                      action: navigate
                      navigation_path: "#config_4"
                    features_position: bottom
                columns: 2
              - type: markdown
                content: |
                  <center> 2 av 4 </center>
      - type: vertical-stack
        cards:
          - type: custom:bubble-card
            card_type: pop-up
            hash: "#config_4"
            show_header: false
            background_update: false
            width_desktop: 600px
            close_action:
              navigation_path: "#settings"
          - type: custom:vertical-stack-in-card
            cards:
              - type: heading
                icon: ""
                heading_style: title
                heading: Smart styrning 1/2
              - type: heading
                icon: ""
                heading_style: subtitle
                heading: Batteri och laddning
              - type: entities
                entities:
                  - entity: input_number.sem_battery_total_capacity_kwh
                    name: Total kapacitet
                    icon: mdi:battery
                  - entity: input_number.sem_max_charge_power_window_1
                    name: Laddningseffekt (9-16)
                    icon: mdi:flash
                  - entity: input_number.sem_max_charge_power_window_2
                    name: Laddningseffekt (23-05)
                    icon: mdi:flash
                  - entity: input_number.sem_max_charge_manual_charging
                    name: Manuell laddningseffekt
                    icon: mdi:flash
                  - entity: input_number.sem_battery_discharge_power_ev_limit
                    name: Max urladdningseffekt
                    icon: mdi:flash
                  - entity: input_number.sem_charge_profit_threshold
                    name: Laddningsvinst
                    icon: mdi:finance
              - type: markdown
                content: >-
                  **‚ÑπÔ∏èInformation**

                  Ange din totala lagringskapacitet under **total kapacitet**.
                  Ange den maximala till√•tna **laddningseffekt** vid de olika
                  laddningstillf√§llena. **Laddningsvinst** styr gr√§nsv√§rdet f√∂r
                  att laddningen genomf√∂ras. Detta hindrar att batteriet laddas
                  d√• elpriset √§r j√§mnt. 
              - type: entities
                entities:
                  - entity: input_number.sem_price_limit_supercheap
                    name: Superbilligt
                    icon: mdi:finance
                  - entity: input_number.sem_low_price_threshold
                    name: L√•gt elpris
                    icon: mdi:finance
              - type: markdown
                content: >-
                  **‚ÑπÔ∏èInformation**

                  Ange gr√§nsen f√∂r vad som r√§knas som **superbillig el**. Detta
                  v√§rde anv√§nds f√∂r att ladda batteriet extra n√§r elpriset √§r
                  v√§ldigt l√•gt. **L√•gt elpris** avg√∂r gr√§sv√§rdet d√• batteriet
                  s√§tts i vilol√§ge och elen k√∂ps fr√•n eln√§tet f√∂r att spara p√•
                  batteriet. 
              - type: heading
                icon: ""
                heading_style: subtitle
                heading: S√§lja
              - features:
                  - type: toggle
                type: tile
                features_position: inline
                vertical: false
                entity: input_boolean.sem_discharge_high_prices
                name: S√§lj batteri√∂verskott
                icon: mdi:transmission-tower-export
                tap_action:
                  action: toggle
                icon_tap_action:
                  action: toggle
                color: green
                hide_state: true
              - type: conditional
                conditions:
                  - condition: state
                    entity: input_boolean.sem_discharge_high_prices
                    state: "on"
                card:
                  type: custom:vertical-stack-in-card
                  cards:
                    - type: entities
                      entities:
                        - entity: input_number.sem_max_export_power
                          name: Urladdningseffekt
                          icon: mdi:flash
                        - entity: input_number.sem_battery_discharge_power_ev_limit
                          name: √Öterst√§llningseffekt
                          icon: mdi:flash
                        - entity: input_number.sem_expensive_electricity
                          icon: mdi:finance
                          name: S√§ljgr√§ns
                        - entity: input_number.sem_battery_charge_price
                          name: Laddgr√§ns
                          icon: mdi:finance
                    - type: markdown
                      content: >-
                        **‚ÑπÔ∏èInformation**

                        **Urladdningseffekt** styr vilken effekt batteriet ska
                        kunna exportera el. **√Öterst√§llningseffekt** anger
                        vilken effekt batteriet ska √•terg√• till efter export.
                        **S√§ljgr√§ns** anger hur h√∂gt elpriset m√•ste vara f√∂r att
                        batteriet ska s√§lja sitt √∂verskott. **Laddgr√§ns** anger
                        elprisniv√•n f√∂r n√§sta laddning. B√•da villkoren m√•ste
                        uppfyllas f√∂r att batteriet ska s√§lja √∂verskott.
              - type: conditional
                conditions:
                  - condition: state
                    entity: input_boolean.sem_discharge_high_prices
                    state: "off"
                card:
                  type: markdown
                  content: >-
                    **‚ÑπÔ∏èInformation**

                    Aktivera **s√§lj batteri√∂verskott** om du vill s√§lja
                    batteriets √∂verskott. 
              - square: false
                type: grid
                cards:
                  - type: tile
                    entity: input_boolean.sem_step_2
                    name: Tillbaka
                    icon: mdi:arrow-left
                    color: disabled
                    hide_state: true
                    vertical: false
                    tap_action:
                      action: navigate
                      navigation_path: "#config_3"
                    icon_tap_action:
                      action: navigate
                      navigation_path: "#config_3"
                    features_position: bottom
                  - type: tile
                    entity: input_boolean.sem_step_3
                    name: Forts√§tt
                    icon: mdi:arrow-right
                    color: disabled
                    hide_state: true
                    vertical: false
                    tap_action:
                      action: navigate
                      navigation_path: "#config_5"
                    icon_tap_action:
                      action: navigate
                      navigation_path: "#config_5"
                    features_position: bottom
                columns: 2
              - type: markdown
                content: |
                  <center> 3 av 4 </center>
      - type: vertical-stack
        cards:
          - type: custom:bubble-card
            card_type: pop-up
            hash: "#config_5"
            show_header: false
            background_update: false
            width_desktop: 600px
            close_action:
              navigation_path: "#settings"
          - type: custom:vertical-stack-in-card
            cards:
              - type: heading
                icon: ""
                heading_style: title
                heading: Smart styrning 2/2
              - type: heading
                icon: ""
                heading: Export av sol√∂verskottet
                heading_style: subtitle
              - type: tile
                entity: input_boolean.sem_export_limit_active
                features_position: inline
                vertical: false
                name: Begr√§nsa export
                icon: mdi:transmission-tower-export
                hide_state: true
                color: green
                tap_action:
                  action: toggle
                icon_tap_action:
                  action: toggle
                features:
                  - type: toggle
              - type: markdown
                content: >-
                  **‚ÑπÔ∏èInformation**

                  Aktivera reglaget om du vill att export av solel automatiskt
                  ska stoppas n√§r elpriset √§r 0 eller l√§gre.
              - type: heading
                icon: ""
                heading_style: subtitle
                heading: Laddbox och elbil
              - type: tile
                entity: input_boolean.sem_ev_wallbox_multi
                name: Tv√• laddboxar
                icon: mdi:checkbox-multiple-blank
                color: green
                hide_state: true
                vertical: false
                features:
                  - type: toggle
                features_position: inline
              - type: conditional
                conditions:
                  - condition: state
                    entity: input_boolean.sem_ev_wallbox_multi
                    state: "on"
                card:
                  type: entities
                  entities:
                    - entity: input_text.sem_ev_sensor
                      icon: mdi:ev-plug-type2
                      name: Laddbox 1
                    - entity: input_text.sem_ev_sensor_2
                      icon: mdi:ev-plug-type2
                      name: Laddbox 2
              - type: conditional
                conditions:
                  - condition: state
                    entity: input_boolean.sem_ev_wallbox_multi
                    state: "off"
                card:
                  type: entities
                  entities:
                    - entity: input_text.sem_ev_sensor
                      icon: mdi:ev-plug-type2
                      name: Laddbox 1
              - type: markdown
                content: >-
                  **‚ÑπÔ∏èInformation**

                  Ange namnet p√• sensorn som m√§ter effekten p√• din laddbox. Fyll
                  i f√∂rsta f√§ltet om du har tv√• laddboxar. Har du tv√• laddboxar
                  fyller du √§ven i andra f√§ltet. L√§mna b√•da f√§lten tomma om du
                  inte har n√•gon laddbox. Har du tv√• laddboxar aktiverar du
                  reglaget **tv√• laddboxar**
              - features:
                  - type: toggle
                type: tile
                entity: input_boolean.sem_ev_charging_protection_enabled
                features_position: inline
                vertical: false
                icon: mdi:ev-plug-type2
                color: green
                hide_state: true
                name: Urladdningskydd
                tap_action:
                  action: toggle
                icon_tap_action:
                  action: toggle
              - type: conditional
                conditions:
                  - condition: state
                    entity: input_boolean.sem_ev_charging_protection_enabled
                    state: "off"
                card:
                  type: custom:vertical-stack-in-card
                  cards:
                    - type: markdown
                      content: >-
                        **‚ÑπÔ∏èInformation**

                        Aktivera **urladdningskydd** om du inte vill att
                        batteriet ska ladda elbilen.
              - type: conditional
                conditions:
                  - condition: state
                    entity: input_boolean.sem_ev_charging_protection_enabled
                    state: "on"
                card:
                  type: custom:vertical-stack-in-card
                  cards:
                    - type: conditional
                      conditions:
                        - condition: state
                          entity: input_boolean.sem_ev_wallbox_multi
                          state: "off"
                      card:
                        type: entities
                        entities:
                          - entity: input_text.sem_ev_sensor_state
                            name: Laddbox 1
                          - entity: input_text.sem_ev_charging_state
                            name: Laddningsl√§ge laddbox 1
                            icon: mdi:format-list-bulleted-square
                          - entity: input_number.sem_battery_discharge_power_ev_limit
                            name: Urladdningseffekt
                    - type: conditional
                      conditions:
                        - condition: state
                          entity: input_boolean.sem_ev_wallbox_multi
                          state: "on"
                      card:
                        type: entities
                        entities:
                          - entity: input_text.sem_ev_sensor_state
                            name: Laddbox 1
                          - entity: input_text.sem_ev_charging_state
                            name: Laddningsl√§ge laddbox 1
                            icon: mdi:format-list-bulleted-square
                          - entity: input_text.sem_ev_sensor_state_2
                            name: Laddbox 2
                          - entity: input_text.sem_ev_charging_state_2
                            name: Laddningsl√§ge laddbox 2
                            icon: mdi:format-list-bulleted-square
                          - entity: input_number.sem_battery_discharge_power_ev_limit
                    - type: markdown
                      content: >-
                        **‚ÑπÔ∏èInformation**

                        I **laddboxsensor** anger du vilken sensor som √∂vervakar
                        laddboxens aktuella l√§ge (om den laddar eller √§r l√•st).
                        Under **laddningsl√§ge** fyller du i det l√§ge som
                        motsvarar n√§r laddboxen faktiskt laddar bilen (t.ex
                        charging). Slutligen anger du under
                        **urladdningseffekt** den effekt (kW) som batteriet ska
                        √•terg√• till efter att elbilen √§r f√§rdigladdad. 
              - square: false
                type: grid
                cards:
                  - type: tile
                    entity: input_boolean.sem_step_3
                    name: Tillbaka
                    icon: mdi:arrow-left
                    color: disabled
                    hide_state: true
                    vertical: false
                    tap_action:
                      action: navigate
                      navigation_path: "#config_4"
                    icon_tap_action:
                      action: navigate
                      navigation_path: "#config_4"
                    features_position: bottom
                  - type: tile
                    entity: input_boolean.sem_step_4
                    name: Forts√§tt
                    icon: mdi:arrow-right
                    color: disabled
                    hide_state: true
                    vertical: false
                    tap_action:
                      action: navigate
                      navigation_path: "#config_6"
                    icon_tap_action:
                      action: navigate
                      navigation_path: "#config_6"
                    features_position: bottom
                columns: 2
              - type: markdown
                content: |
                  <center> 4 av 4 </center>
      - type: vertical-stack
        cards:
          - type: custom:bubble-card
            card_type: pop-up
            hash: "#config_6"
            show_header: false
            background_update: false
            width_desktop: 600px
            close_action:
              navigation_path: "#settings"
          - type: custom:vertical-stack-in-card
            cards:
              - type: heading
                icon: ""
                heading_style: title
                heading: "ü•≥ Konfigurationen √§r klar! "
              - type: markdown
                content: >-
                  **üíæ √Ñr det f√∂rsta g√•ngen du konfiguerarar systemet?** 

                  D√• beh√∂ver systemet **minst sju dagar** att l√§ra sig dina
                  energim√∂nster. Under denna tid kan du ladda batteriet manuellt
                  via knappen snabbval i hemvy om det skulle beh√∂vas.


                  **‚öôÔ∏è √Ñndra dina inst√§llningar**

                  Detta g√∂r du genom att k√∂ra om hela konfigurationen. √Ñndringar
                  startar **INTE** om systemets inl√§rningsprocess p√• sju dagar. 
              - type: tile
                entity: input_boolean.sem_step_5
                name: Avsluta konfigurationen
                icon: mdi:arrow-right
                color: disabled
                hide_state: true
                vertical: true
                tap_action:
                  action: navigate
                  navigation_path: /lovelace/smart-energy-system
                icon_tap_action:
                  action: navigate
                  navigation_path: /lovelace/smart-energy-system
                features_position: bottom
  - type: grid
    cards:
      - type: vertical-stack
        cards:
          - type: custom:bubble-card
            card_type: pop-up
            hash: "#battery"
            show_header: false
          - type: heading
            icon: mdi:home-battery
            heading_style: title
            heading: Batteriet
          - type: custom:vertical-stack-in-card
            cards:
              - type: heading
                icon: mdi:clock
                heading_style: subtitle
                heading: Senaste dygnet
              - type: custom:apexcharts-card
                update_interval: 5 min
                graph_span: 24h
                header:
                  title: Batteri
                  show: false
                  show_states: true
                  colorize_states: true
                hours_12: false
                stacked: false
                experimental:
                  color_threshold: true
                yaxis:
                  - id: batteri_capacity
                    opposite: false
                    show: true
                    decimals: 1
                    min: 0
                    apex_config:
                      title:
                        text: Procent
                series:
                  - entity: sensor.batteries_state_of_capacity
                    type: area
                    name: SOC
                    stroke_width: 1
                    opacity: 0.6
                    yaxis_id: batteri_capacity
                    color: blue
                    color_threshold:
                      - value: 0
                        color: "#cce5ff"
                      - value: 2
                        color: "#3399ff"
                      - value: 5
                        color: "#003366"
                    group_by:
                      duration: 15m
                      func: last
                apex_config:
                  chart:
                    height: 190px
                    animations:
                      enabled: true
                      easing: easeinout
                      speed: 800
                      animateGradually:
                        enabled: true
                        delay: 150
                  legend:
                    show: true
                    floating: false
                    offsetY: 5
                    position: bottom
                    fontSize: 10px
                  tooltip:
                    enabled: false
                  xaxis:
                    labels:
                      show: true
                      rotate: 0
                      rotateAlways: true
                      logarithmic: false
                  stroke:
                    width: 1
                  plotOptions:
                    candlestick:
                      colors:
                        upward: "#00B746"
                        downward: "#EF403C"
                      wick:
                        useFillColor: true
                  grid:
                    show: true
                    strokeDashArray: 1
                    position: front
                    xaxis:
                      lines:
                        show: false
                all_series_config:
                  show:
                    legend_value: false
                    datalabels: false
                    in_brush: false
                  float_precision: 3
                  invert: false
                  fill_raw: last
          - type: custom:vertical-stack-in-card
            cards:
              - type: entities
                entities:
                  - entity: select.batteries_working_mode
                    name: Arbetsl√§ge
                  - entity: number.batteries_maximum_discharging_power
                    name: Max urladdning
                  - entity: number.batteries_grid_charge_maximum_power
                    name: Max laddning
                    icon: mdi:transmission-tower-import
              - type: markdown
                content: >-
                  **‚ÑπÔ∏èInformation**

                  Alternativen ovan ger dig m√∂jlighet att st√§lla in vad
                  batteriet f√•r ladda ur med, men √§ven maximala effekten vid
                  laddning fr√•n eln√§tet. Du kan √§ven v√§lja arbetsl√§ge p√• ditt
                  batteri.
                text_only: true
          - type: custom:vertical-stack-in-card
            cards:
              - type: heading
                icon: mdi:battery-charging-60
                heading: Ladda nu
                heading_style: subtitle
              - type: entities
                entities:
                  - entity: input_number.sem_max_charge_manual_charging
                    name: Laddningseffekt
                    icon: mdi:flash
                  - entity: input_number.sem_manual_charge_duration
                    name: Tid
                    icon: mdi:clock-time-eight
                  - entity: input_boolean.sem_manual_charge
                    icon: mdi:play-circle
                    name: Ladda nu
              - type: markdown
                content: >-
                  **‚ÑπÔ∏èInformation**

                  St√§ll in till√•ten effekt och tid f√∂r laddningen. Aktivera
                  laddningen via reglaget **ladda nu**. 
                text_only: true
          - type: custom:vertical-stack-in-card
            cards:
              - type: heading
                icon: mdi:cog
                heading_style: subtitle
                heading: Aktiverade smarta funktioner
              - type: entities
                entities:
                  - entity: input_boolean.sem_ev_charging_protection_enabled
                    name: Ladda inte elbilen med batteriet
                    icon: mdi:car-electric
                  - entity: input_boolean.sem_discharge_high_prices
                    name: S√§lj √∂verskott vid h√∂gt elpris
                    icon: mdi:transmission-tower-export
              - type: markdown
                content: >-
                  **‚ÑπÔ∏èInformation**

                  Ovan visas vilka smarta funktioner som √§r **aktiverade i ditt
                  system**. P√• hemsk√§rmens kan du se om den smarta funktionen √§r
                  aktiv. 
                text_only: true
          - type: custom:vertical-stack-in-card
            cards:
              - type: heading
                icon: mdi:battery-plus
                heading_style: subtitle
                heading: Extra laddning
              - type: entities
                entities:
                  - entity: input_number.extra_1
                    name: Dagen (9-16)
                    icon: mdi:battery-clock
                  - entity: input_number.extra_2
                    name: Natten (23-05)
                    icon: mdi:battery-clock
              - type: markdown
                content: >-
                  **‚ÑπÔ∏èInformation**

                  Alternativen ovan ger dig m√∂jlighet att l√§gga till **extra
                  kwh** p√• ett laddningstillf√§lle.
                text_only: true
        view_layout:
          position: main
      - type: vertical-stack
        cards:
          - type: custom:bubble-card
            card_type: pop-up
            hash: "#grid"
            show_header: false
          - type: heading
            icon: mdi:transmission-tower
            heading_style: title
            heading: Eln√§tet
          - type: custom:vertical-stack-in-card
            cards:
              - type: heading
                icon: mdi:clock
                heading_style: subtitle
                heading: Senaste dygnet
              - type: custom:apexcharts-card
                update_interval: 5 min
                graph_span: 24h
                header:
                  title: Spotpris 48h ink moms
                  show: false
                  show_states: true
                  colorize_states: true
                hours_12: false
                stacked: false
                experimental:
                  color_threshold: true
                yaxis:
                  - id: grid
                    opposite: false
                    show: true
                    decimals: 1
                    apex_config:
                      title:
                        text: kWh
                series:
                  - entity: sensor.sem_export_power_tot
                    type: area
                    yaxis_id: grid
                    name: S√•lt
                    color: green
                    opacity: 0.6
                    color_threshold:
                      - value: 0
                        color: "#ccffcc"
                      - value: 2
                        color: "#66ff66"
                      - value: 5
                        color: "#009900"
                    group_by:
                      func: delta
                      duration: 1h
                    invert: true
                  - entity: sensor.sem_import_power_tot
                    type: area
                    name: K√∂pt
                    color: red
                    yaxis_id: grid
                    opacity: 0.6
                    color_threshold:
                      - value: 0
                        color: "#ffcccc"
                      - value: 2
                        color: "#ff6666"
                      - value: 5
                        color: "#cc0000"
                    group_by:
                      func: delta
                      duration: 1h
                apex_config:
                  chart:
                    height: 190px
                    animations:
                      enabled: true
                      easing: easeinout
                      speed: 800
                      animateGradually:
                        enabled: true
                        delay: 150
                  legend:
                    show: true
                    floating: false
                    offsetY: 5
                    position: bottom
                    fontSize: 10px
                  tooltip:
                    enabled: false
                  xaxis:
                    labels:
                      show: true
                      rotate: 0
                      rotateAlways: true
                      logarithmic: false
                  stroke:
                    show: true
                    colors: undefined
                  plotOptions:
                    candlestick:
                      colors:
                        upward: "#00B746"
                        downward: "#EF403C"
                      wick:
                        useFillColor: true
                all_series_config:
                  show:
                    legend_value: false
                    datalabels: false
                    in_brush: false
                  float_precision: 3
                  invert: false
                  fill_raw: last
          - type: custom:vertical-stack-in-card
            cards:
              - type: heading
                icon: mdi:calendar-today
                heading: Idag
                heading_style: subtitle
              - square: false
                type: grid
                cards:
                  - type: tile
                    features_position: bottom
                    vertical: false
                    entity: sensor.sem_import
                    name: K√∂pt
                    icon: mdi:transmission-tower-import
                  - type: tile
                    features_position: bottom
                    vertical: false
                    entity: sensor.sem_export
                    icon: mdi:transmission-tower-export
                    name: S√•lt
                columns: 2
          - type: tile
            entity: sensor.sem_nordpool_active
            name: Elpriset
            icon: mdi:flash
            vertical: false
            features_position: bottom
          - type: custom:vertical-stack-in-card
            cards: []
      - type: vertical-stack
        cards:
          - type: custom:bubble-card
            card_type: pop-up
            hash: "#solar"
            show_header: false
          - type: heading
            icon: mdi:solar-power-variant
            heading_style: title
            heading: Solceller
          - type: custom:vertical-stack-in-card
            cards:
              - type: heading
                icon: mdi:clock
                heading_style: subtitle
                heading: Senaste dygnet
              - type: custom:apexcharts-card
                update_interval: 5 min
                graph_span: 24h
                header:
                  title: Spotpris 48h ink moms
                  show: false
                  show_states: true
                  colorize_states: true
                hours_12: false
                stacked: false
                experimental:
                  color_threshold: true
                yaxis:
                  - id: solar
                    opposite: false
                    show: true
                    decimals: 1
                    min: 0
                    apex_config:
                      title:
                        text: kWh
                series:
                  - entity: sensor.sem_input_power_with_efficiency_loss_kw_tot
                    type: area
                    yaxis_id: solar
                    name: Producerad solel
                    color: orange
                    stroke_width: 1
                    opacity: 0.6
                    color_threshold:
                      - value: 0
                        color: "#fff066"
                      - value: 2
                        color: "#ffd700"
                      - value: 5
                        color: "#ffb300"
                    group_by:
                      func: delta
                      duration: 1h
                    show:
                      in_legend: true
                  - entity: sensor.sem_consumed_solar_energy_today
                    type: area
                    name: Anv√§nd solel
                    stroke_width: 1
                    opacity: 0.6
                    yaxis_id: solar
                    color: blue
                    color_threshold:
                      - value: 0
                        color: "#cce5ff"
                      - value: 2
                        color: "#3399ff"
                      - value: 5
                        color: "#003366"
                    group_by:
                      duration: 1h
                      func: delta
                apex_config:
                  chart:
                    height: 190px
                    animations:
                      enabled: true
                      easing: easeinout
                      speed: 800
                      animateGradually:
                        enabled: true
                        delay: 150
                  legend:
                    show: true
                    floating: false
                    offsetY: 5
                    position: bottom
                    fontSize: 10px
                  tooltip:
                    enabled: false
                  xaxis:
                    labels:
                      show: true
                      rotate: 0
                      rotateAlways: true
                      logarithmic: false
                  stroke:
                    width: 1
                  plotOptions:
                    candlestick:
                      colors:
                        upward: "#00B746"
                        downward: "#EF403C"
                      wick:
                        useFillColor: true
                  grid:
                    show: true
                    strokeDashArray: 1
                    position: front
                    xaxis:
                      lines:
                        show: false
                all_series_config:
                  show:
                    legend_value: false
                    datalabels: false
                    in_brush: false
                  float_precision: 3
                  invert: false
                  fill_raw: last
          - type: custom:vertical-stack-in-card
            cards:
              - type: heading
                icon: mdi:solar-panel-large
                heading: Idag
                heading_style: subtitle
              - square: false
                type: grid
                cards:
                  - type: tile
                    entity: sensor.sem_solar_production
                    name: Producerat
                    icon: mdi:solar-power-variant
                    vertical: false
                    features_position: bottom
                  - type: tile
                    entity: sensor.sem_consumed_solar_energy_today
                    name: F√∂rbrukat
                    icon: mdi:solar-power-variant
                    vertical: false
                    features_position: bottom
                  - type: tile
                    entity: sensor.sem_export
                    name: S√•lt
                    icon: mdi:solar-power-variant
                    vertical: false
                    features_position: bottom
                columns: 3
          - type: custom:vertical-stack-in-card
            cards: []
          - type: custom:vertical-stack-in-card
            cards:
              - type: heading
                icon: mdi:cog
                heading_style: subtitle
                heading: Aktiverade smarta funktioner
              - type: entities
                entities:
                  - entity: input_boolean.sem_export_limit_active
                    name: S√§lj inte solel vid l√•gt elpris
                    icon: mdi:weather-sunny-off
              - type: markdown
                content: >-
                  **‚ÑπÔ∏èInformation**

                  Ovan visas vilka smarta funktioner som √§r **aktiverade i ditt
                  system**. P√• hemsk√§rmens kan du se om den smarta funktionen √§r
                  aktiv. 
                text_only: true
      - type: vertical-stack
        cards:
          - type: custom:bubble-card
            card_type: pop-up
            hash: "#charge_information_1"
            show_header: false
          - type: heading
            icon: mdi:battery-clock
            heading: N√§sta laddning
            heading_style: title
          - type: custom:vertical-stack-in-card
            cards:
              - type: custom:mushroom-template-card
                primary: >
                  {% set raw =
                  states('sensor.sem_battery_charge_window_cheapest_1a') %}

                  {% set start, end = (raw.split(' - ') if raw and ' - ' in raw
                  else [None, None]) %}

                  {% if start and end %}
                    N√§sta laddning {{ start[11:16] }}‚Äì{{ end[11:16] }}
                  {% else %}
                    Ingen giltig laddningstid
                  {% endif %}
                icon: mdi:battery-clock
                icon_color: >
                  {% set now = now() %}

                  {% set raw =
                  states('sensor.sem_battery_charge_window_cheapest_1a') %}

                  {% set start, end = (raw.split(' - ') if raw and ' - ' in raw
                  else [None, None]) %}

                  {% set end_dt = as_datetime(end) if end else none %}


                  {% set energy = 0 %}

                  {% if end_dt and now <= (end_dt + timedelta(minutes=30)) %}
                    {% set energy = states('sensor.sem_battery_charge_energy_1a_2') | float %}
                  {% endif %}


                  {% if energy <= 5 %}
                    green
                  {% elif energy <= 10 %}
                    orange
                  {% else %}
                    red
                  {% endif %}
                grid_options:
                  columns: 12
                  rows: 2
                secondary: >+
                  {% set now = now() %}

                  {% set raw =
                  states('sensor.sem_battery_charge_window_cheapest_1a') %}

                  {% set start, end = (raw.split(' - ') if raw and ' - ' in raw
                  else [None, None]) %}

                  {% set end_dt = as_datetime(end) if end else none %}

                  {% set tomorrow_prices =
                  states('binary_sensor.sem_nordpool_tomorrow_prices_available')
                  %}


                  {% if end_dt and now <= (end_dt + timedelta(minutes=30)) %}
                    {{ states('sensor.sem_battery_charge_energy_1a_2') }} kWh
                  {% elif tomorrow_prices == 'off' %}
                    Ber√§knar energibehovet
                  {% else %}
                    {{ states('sensor.sem_battery_charge_energy_1a_2') }} kWh
                  {% endif %}

                layout: vertical
                multiline_secondary: true
                fill_container: false
                tap_action:
                  action: none
                hold_action:
                  action: none
                double_tap_action:
                  action: none
              - type: markdown
                content: >+
                  <center><ha-icon icon="mdi:battery-charging"></ha-icon>
                  Energibehov:
                  {{(state_attr('sensor.sem_battery_charge_energy_1a_2','estimated_energy_sun_interval')
                  +
                  state_attr('sensor.sem_battery_charge_energy_1a_2','estimated_energy_no_sun_interval')
                  +
                  state_attr('sensor.sem_battery_charge_energy_1a_2','battery_capacity')
                  +
                  state_attr('sensor.sem_battery_charge_energy_1a_2','supercheap_charge'))
                  | round(2) }} kWh


                  <i>Soltimmar:
                  {{state_attr('sensor.sem_battery_charge_energy_1a_2','estimated_energy_sun_interval')
                  }} kWh </i>

                  <i>Solfria timmar:
                  {{state_attr('sensor.sem_battery_charge_energy_1a_2','estimated_energy_no_sun_interval')
                  }} kWh </i>

                  <i>Superbilligt:
                  {{state_attr('sensor.sem_battery_charge_energy_1a_2','supercheap_charge')
                  }} kWh </i>

                  <i>Buffert:
                  {{state_attr('sensor.sem_battery_charge_energy_1a_2','battery_capacity')
                  }} kWh </i>


                  <ha-icon icon="mdi:solar-power-variant"></ha-icon> Solel:
                  {{state_attr('sensor.sem_battery_charge_energy_1a_2',
                  'estimated_solar_energy') | round(2) }} kWh 


                  <ha-icon icon="mdi:home-battery"></ha-icon> Batterikapacitet:
                  {{state_attr('sensor.sem_battery_charge_energy_1a_2',
                  'battery_capacity') | round(2) }} kWh


                  ---------------------------------------------

                  <ha-icon icon="mdi:calculator"></ha-icon>  Ber√§kning n√§sta
                  laddning (kWh)

                  =
                  ({{state_attr('sensor.sem_battery_charge_energy_1a_2','estimated_energy_no_sun_interval')
                  }} + (
                  {{state_attr('sensor.sem_battery_charge_energy_1a_2','estimated_energy_sun_interval')
                  }}  - {{state_attr('sensor.sem_battery_charge_energy_1a_2',
                  'estimated_solar_energy') | round(2) }} )  +
                  {{state_attr('sensor.sem_battery_charge_energy_1a_2',
                  'battery_capacity') | round(2) }} -
                  {{state_attr('sensor.sem_battery_charge_energy_1a_2',
                  'battery_capacity') | round(2) }}) +
                  {{state_attr('sensor.sem_battery_charge_energy_1a_2','supercheap_charge')
                  }}


                  <b>F√∂rklaring</b>

                  <i> Energibehovet f√∂r solfria timmar isoleras och
                  energibehovet f√∂r soltimmar ber√§knas i relation till prognosen
                  f√∂r solel. √Ñr solelen st√∂rre √§n energibehovet f√∂r soltimmarna
                  √§r summan 0 kWh. Bufferten l√§ggs till och slutligen dras
                  aktuell batteriniv√• av vilket inkluderar den totala m√§ngden
                  sparad el f√∂r att ber√§kna n√§sta laddning.</i>  



  - type: grid
    cards:
      - type: vertical-stack
        cards:
          - type: heading
            icon: mdi:account
            heading: Mitt system
            heading_style: title
          - type: custom:bubble-card
            card_type: pop-up
            hash: "#settings"
            show_header: false
            background_update: false
            width_desktop: 600px
          - type: custom:vertical-stack-in-card
            cards:
              - type: heading
                icon: mdi:text-box
                heading_style: subtitle
                heading: Version
              - type: tile
                entity: sensor.sem_version
                name: Installerad version
                icon: mdi:laptop
                vertical: false
                tap_action:
                  action: none
                icon_tap_action:
                  action: none
                features_position: bottom
              - type: tile
                entity: sensor.sem_github_latest_release
                name: Senaste version p√• Github
                icon: mdi:github
                vertical: false
                tap_action:
                  action: none
                icon_tap_action:
                  action: none
                features_position: bottom
              - type: markdown
                content: >-
                  L√§s mer om den senaste versionen
                  [h√§r](https://github.com/Henrik1986/huawei-energy-managment/releases).
          - type: conditional
            conditions:
              - condition: state
                entity: input_boolean.manual_update_packages
                state: "off"
            card:
              type: custom:vertical-stack-in-card
              cards:
                - type: heading
                  icon: mdi:update
                  heading: Uppdatera
                  heading_style: subtitle
                - type: tile
                  entity: input_boolean.manual_update_packages
                  name: Uppdatera
                  icon: mdi:cloud-download
                  color: indigo
                  hide_state: true
                  vertical: true
                  tap_action:
                    action: toggle
                  icon_tap_action:
                    action: toggle
                  features_position: bottom
                - type: markdown
                  content: >-
                    **‚ÑπÔ∏èInformation**

                    Uppdatera systemet genom att klicka p√• uppdatera. D√• laddas
                    och installeras den senste versionen. **Starta om Home
                    Assistant efter installationen.**
                  text_only: true
          - type: conditional
            conditions:
              - condition: state
                entity: input_boolean.sem_download
                state: "on"
            card:
              type: custom:vertical-stack-in-card
              cards:
                - type: heading
                  icon: mdi:update
                  heading: Uppdatera
                  heading_style: subtitle
                - type: tile
                  entity: input_boolean.sem_download
                  name: V√§nligen v√§nta ...
                  icon: mdi:clock-time-eight-outline
                  color: amber
                  hide_state: true
                  vertical: true
                  tap_action:
                    action: none
                  icon_tap_action:
                    action: none
                  features_position: bottom
                - type: markdown
                  content: >-
                    **‚ÑπÔ∏èInformation**

                    Den senaste versionen laddas hem och installeras - V√§nligen
                    v√§nta ...
                  text_only: true
          - type: conditional
            conditions:
              - condition: state
                entity: input_boolean.sem_download_finished
                state: "on"
            card:
              type: custom:vertical-stack-in-card
              cards:
                - type: heading
                  icon: mdi:update
                  heading: Uppdatera
                  heading_style: subtitle
                - type: tile
                  entity: input_boolean.sem_download_finished
                  name: F√§rdigt
                  icon: mdi:check-circle-outline
                  color: green
                  hide_state: true
                  vertical: true
                  tap_action:
                    action: none
                  icon_tap_action:
                    action: none
                  features_position: bottom
                - type: markdown
                  content: >-
                    **‚ÑπÔ∏èInformation**

                    Uppdateringen f√§rdig ‚úÖ 


                    F√∂r att slutf√∂ra m√•ste du starta om Home Assistant. 


                    üíª Uppdatera √§ven hemvyn genom att klistra in koden fr√•n
                    filen admin_view via github. 
                  text_only: true
          - type: custom:vertical-stack-in-card
            cards:
              - type: heading
                icon: mdi:account-cog
                heading: "Konfigurera "
                heading_style: subtitle
              - type: tile
                entity: input_button.sem_config_1
                name: Konfiguera
                icon: mdi:cog
                color: green
                hide_state: true
                vertical: true
                tap_action:
                  action: navigate
                  navigation_path: "#config_1"
                icon_tap_action:
                  action: navigate
                  navigation_path: "#config_1"
                features_position: bottom
              - type: markdown
                content: >-
                  **‚ÑπÔ∏èInformation**

                  Anpassa systemet till din anl√§ggning och din plats. Observera
                  att systemet beh√∂ver minst **sju dagar** f√∂r att
                  energiber√§kningarna ska st√• i relation till  verkligheten.   
                text_only: true
          - type: heading
            icon: mdi:face-agent
            heading_style: title
            heading: Support
          - type: custom:vertical-stack-in-card
            cards:
              - type: heading
                icon: mdi:account-tag
                heading: Anv√§ndarkod
                heading_style: subtitle
              - type: tile
                entity: input_button.sem_buy_key
                name: K√∂p anv√§ndarkod
                icon: mdi:key-chain-variant
                color: deep-orange
                hide_state: true
                vertical: true
                tap_action:
                  action: navigate
                  navigation_path: "#buy_key"
                icon_tap_action:
                  action: navigate
                  navigation_path: "#buy_key"
                features_position: bottom
              - type: markdown
                content: >-
                  **‚ÑπÔ∏èInformation**  

                  K√∂p din anv√§ndarkod genom att klicka p√• knappen **k√∂p
                  anv√§ndarkod**.
                text_only: true
          - type: custom:vertical-stack-in-card
            cards:
              - type: heading
                icon: mdi:code-json
                heading_style: subtitle
                heading: Kontakta utvecklaren
              - type: markdown
                content: >-
                  ü™≤[Anm√§l ett
                  fel](https://github.com/Henrik1986/huawei-energy-managment/issues)
                  p√• Github. 

                  ‚ú®√ñnska [ny
                  funktion](https://github.com/Henrik1986/huawei-energy-managment/discussions)
                  p√• Github
      - type: vertical-stack
        cards:
          - type: custom:bubble-card
            card_type: pop-up
            hash: "#buy_key"
            show_header: false
            background_update: false
            width_desktop: 600px
            close_action:
              action: navigate
              navigation_path: "#settings"
          - type: custom:vertical-stack-in-card
            cards:
              - type: heading
                icon: mdi:key-chain
                heading: K√∂p anv√§ndarkod
                heading_style: title
              - type: markdown
                content: >-
                  **Hej,**


                  Kul att du vill prova mitt paket f√∂r att styra ditt
                  Huawei-system.

                  Detta √§r ett hobbyprojekt, men f√∂r att kunna vidareutveckla
                  systemet och erbjuda ett modernt och lokalt s√§tt att styra
                  ditt Huawei-system kr√§vs en anv√§ndarkod. Priset √§r **399 kr
                  per √•r.**


                  F√∂r att f√• en anv√§ndarkod fyller du i f√∂r- och efternamn samt
                  din epost och klickar p√• ans√∂k. N√§r jag f√•tt din ans√∂kan
                  kommer jag h√∂ra av mig till dig. 


                  √Ñr du os√§ker p√• om paketet passar dig? D√• kan du f√• en demokod
                  som g√§ller i 30 dagar. 


                  V√§nligen,

                  Henrik
              - type: conditional
                conditions:
                  - condition: state
                    entity: input_boolean.sem_submit_user_info
                    state: "off"
                card:
                  type: custom:vertical-stack-in-card
                  cards:
                    - type: heading
                      icon: mdi:form-select
                      heading: Ans√∂k om anv√§ndarkod
                      heading_style: subtitle
                    - type: conditional
                      conditions:
                        - condition: state
                          entity: input_boolean.sem_submit_user_info
                          state: "off"
                      card:
                        type: entities
                        entities:
                          - entity: input_text.sem_name
                            name: F√∂r- och efternamn
                            icon: mdi:account
                          - entity: input_text.sem_epost
                            icon: mdi:email
                    - type: tile
                      entity: input_boolean.sem_submit_user_info
                      name: Ans√∂k
                      icon: mdi:email-fast
                      hide_state: true
                      vertical: true
                      features_position: bottom
              - type: conditional
                conditions:
                  - condition: state
                    entity: input_boolean.sem_submit_user_info
                    state: "on"
                card:
                  type: custom:vertical-stack-in-card
                  cards:
                    - type: heading
                      icon: mdi:check-circle
                      heading: Din ans√∂kan √§r inskickad
                      heading_style: title
                    - type: markdown
                      content: >-
                        Vidare instruktioner kommer att skickas till din angivna
                        epost. Tack f√∂r att du st√∂ttar mitt arbete. 


                        V√§nligen, 

                        Henrik
                      text_only: true
      - type: vertical-stack
        cards:
          - type: custom:bubble-card
            card_type: pop-up
            hash: "#settings_fast"
            show_header: false
            background_update: false
            width_desktop: 600px
            close_action:
              navigation_path: "#settings"
          - type: heading
            icon: mdi:order-bool-descending
            heading: Snabbval
            heading_style: title
          - type: custom:vertical-stack-in-card
            cards:
              - type: heading
                icon: ""
                heading_style: subtitle
                heading: "Ladda manuellt "
              - type: entities
                entities:
                  - entity: input_number.sem_max_charge_manual_charging
                    name: Laddningseffekt
                    icon: mdi:lightning-bolt-circle
                    secondary_info: none
                    tap_action:
                      action: nothing
                    icon_tap_action:
                      action: nothing
                  - entity: input_number.sem_manual_charge_duration
                    icon: mdi:clock
                    tap_action:
                      action: nothing
                    icon_tap_action:
                      action: nothing
                  - entity: input_boolean.sem_manual_charge
                    icon: mdi:power-plug-battery
                    name: Ladda nu
                    tap_action:
                      action: nothing
                    icon_tap_action:
                      action: nothing
                show_header_toggle: false
              - type: markdown
                content: >-
                  **‚ÑπÔ∏èInformation**

                  Under **ladda manuellt** kan du starta en laddning p√• egen
                  hand. V√§lj laddningseffekt och tid f√∂r att sen aktivera
                  laddningen genom reglaget p√• **ladda nu**.
              - type: heading
                icon: ""
                heading_style: subtitle
                heading: Extra kWh
              - type: entities
                entities:
                  - entity: input_number.extra_1
                    name: Tillf√§lle 1 (9-16)
                    icon: mdi:battery-plus
                    secondary_info: none
                    tap_action:
                      action: nothing
                    icon_tap_action:
                      action: nothing
                  - entity: input_number.extra_2
                    name: Tillf√§lle 2 (23-05)
                    icon: mdi:battery-plus
                    tap_action:
                      action: nothing
                    icon_tap_action:
                      action: nothing
              - type: markdown
                content: >-
                  **‚ÑπÔ∏èInformation**

                  Under **extra kWh** kan du l√§gga till extra kWh p√• ett
                  laddningstillf√§lle. Detta kan vara anv√§ndbart om du vill ladda
                  mer √§n vad systemet f√∂resl√•r. 
      - type: vertical-stack
        cards:
          - type: custom:bubble-card
            card_type: pop-up
            hash: "#system_plan"
            show_header: false
            width_desktop: 700px
          - type: heading
            icon: mdi:calendar-clock
            heading_style: title
            heading: Systemets driftplan
          - type: custom:vertical-stack-in-card
            cards:
              - type: custom:apexcharts-card
                update_interval: 1 min
                graph_span: 48h
                cache: false
                span:
                  start: day
                  offset: +0H
                header:
                  title: Systemets driftplan
                  show: false
                  show_states: false
                  colorize_states: true
                hours_12: false
                stacked: false
                experimental:
                  color_threshold: true
                yaxis:
                  - id: spotpris
                    opposite: false
                    show: false
                    decimals: 1
                    min: 0
                    apex_config:
                      title:
                        text: Elpris (SEK/kWh)
                  - id: solar_power
                    opposite: true
                    show: true
                    apex_config:
                      title:
                        text: Solel (kWh)
                  - id: charge/expensive
                    opposite: true
                    show: false
                apex_config:
                  chart:
                    height: 320
                    animations:
                      enabled: true
                      easing: easeinout
                      speed: 800
                      animateGradually:
                        enabled: true
                        delay: 150
                  legend:
                    show: true
                    floating: false
                    offsetY: 5
                    position: bottom
                    fontSize: 10px
                  tooltip:
                    enabled: true
                  xaxis:
                    labels:
                      show: true
                      rotate: 0
                      rotateAlways: true
                      logarithmic: false
                      datetimeUTC: false
                  stroke:
                    width: 1
                  plotOptions:
                    candlestick:
                      colors:
                        upward: "#00B746"
                        downward: "#EF403C"
                      wick:
                        useFillColor: true
                all_series_config:
                  show:
                    legend_value: false
                    datalabels: false
                    in_brush: false
                  float_precision: 3
                  invert: false
                  fill_raw: last
                now:
                  show: true
                  label: NU
                  color: red
                series:
                  - entity: sensor.sem_battery_charge_window_cheapest_1a
                    yaxis_id: charge/expensive
                    name: Laddningsf√∂nster
                    opacity: 0.7
                    color: "#00406c"
                    type: area
                    data_generator: |
                      const data = [];
                      const sensorData = entity.state.split(' - ');
                      function parseLocalTime(str) {
                        const parts = str.split(/[- :T]/).map(Number);
                        const date = new Date(parts[0], parts[1] - 1, parts[2], parts[3], parts[4]);
                        return date.getTime();
                      }
                      const startTime = parseLocalTime(sensorData[0]);
                      const endTime = parseLocalTime(sensorData[1]);
                      data.push([startTime, 1]);
                      data.push([startTime, 1]);
                      data.push([endTime, 1]);
                      data.push([endTime, 0]);
                      return data;
                    show:
                      legend_value: false
                      datalabels: false
                      extremas: false
                      in_brush: false
                      in_legend: true
                  - entity: sensor.sem_battery_charge_window_cheapest_2
                    yaxis_id: charge/expensive
                    name: Laddningsf√∂nster 2
                    opacity: 0.7
                    color: "#00406c"
                    type: area
                    data_generator: |
                      const data = [];
                      const sensorData = entity.state.split(' - ');
                      function parseLocalTime(str) {
                        const parts = str.split(/[- :T]/).map(Number);
                        const date = new Date(parts[0], parts[1] - 1, parts[2], parts[3], parts[4]);
                        return date.getTime();
                      }
                      const startTime = parseLocalTime(sensorData[0]);
                      const endTime = parseLocalTime(sensorData[1]);
                      data.push([startTime, 1]);
                      data.push([startTime, 1]);
                      data.push([endTime, 1]);
                      data.push([endTime, 0]);
                      return data;
                    show:
                      legend_value: false
                      datalabels: false
                      extremas: false
                      in_brush: false
                      in_legend: false
                  - entity: sensor.sem_battery_cheap_interval_2_1a
                    yaxis_id: charge/expensive
                    name: Vilol√§ge
                    opacity: 0.7
                    color: "#D3D3D3"
                    type: area
                    data_generator: |
                      const data = [];
                      const sensorData = entity.state.split(' - ');
                      function parseLocalTime(str) {
                        const parts = str.split(/[- :T]/).map(Number);
                        const date = new Date(parts[0], parts[1] - 1, parts[2], parts[3], parts[4]);
                        return date.getTime();
                      }
                      const startTime = parseLocalTime(sensorData[0]);
                      const endTime = parseLocalTime(sensorData[1]);
                      data.push([startTime, 0.8]);
                      data.push([startTime, 0.8]);
                      data.push([endTime, 0.8]);
                      data.push([endTime, 0]);
                      return data;
                    show:
                      legend_value: false
                      datalabels: false
                      extremas: false
                      in_brush: false
                      in_legend: true
                  - entity: sensor.sem_battery_cheap_interval_1a_2
                    yaxis_id: charge/expensive
                    name: Vilol√§ge
                    opacity: 0.7
                    color: "#D3D3D3"
                    type: area
                    data_generator: |
                      const data = [];
                      const sensorData = entity.state.split(' - ');
                      function parseLocalTime(str) {
                        const parts = str.split(/[- :T]/).map(Number);
                        const date = new Date(parts[0], parts[1] - 1, parts[2], parts[3], parts[4]);
                        return date.getTime();
                      }
                      const startTime = parseLocalTime(sensorData[0]);
                      const endTime = parseLocalTime(sensorData[1]);
                      data.push([startTime, 0.8]);
                      data.push([startTime, 0.8]);
                      data.push([endTime, 0.8]);
                      data.push([endTime, 0]);
                      return data;
                    show:
                      legend_value: false
                      datalabels: false
                      extremas: false
                      in_brush: false
                      in_legend: false
                  - entity: sensor.sem_export_limit
                    yaxis_id: charge/expensive
                    name: Begr√§nsar solexport
                    opacity: 0.7
                    color: BBCDDD
                    type: area
                    data_generator: |
                      const data = [];
                      const sensorData = entity.state.split(' - ');
                      function parseLocalTime(str) {
                        const parts = str.split(/[- :T]/).map(Number);
                        const date = new Date(parts[0], parts[1] - 1, parts[2], parts[3], parts[4]);
                        return date.getTime();
                      }
                      const startTime = parseLocalTime(sensorData[0]);
                      const endTime = parseLocalTime(sensorData[1]);
                      data.push([startTime, 0.6]);
                      data.push([startTime, 0.6]);
                      data.push([endTime, 0.6]);
                      data.push([endTime, 0]);
                      return data;
                    show:
                      legend_value: false
                      datalabels: false
                      extremas: false
                      in_brush: false
                      in_legend: true
                  - entity: sensor.sem_battery_use_interval_1
                    yaxis_id: charge/expensive
                    name: Prioterad batteridrift
                    opacity: 0.4
                    color: lime
                    type: area
                    data_generator: |
                      const data = [];
                      const sensorData = entity.state.split(' - ');
                      function parseLocalTime(str) {
                        const parts = str.split(/[- :T]/).map(Number);
                        const date = new Date(parts[0], parts[1] - 1, parts[2], parts[3], parts[4]);
                        return date.getTime();
                      }
                      const startTime = parseLocalTime(sensorData[0]);
                      const endTime = parseLocalTime(sensorData[1]);
                      data.push([startTime, 0.4]);
                      data.push([startTime, 0.4]);
                      data.push([endTime, 0.4]);
                      data.push([endTime, 0]);
                      return data;
                    show:
                      legend_value: false
                      datalabels: false
                      extremas: false
                      in_brush: false
                      in_legend: true
                  - entity: sensor.sem_battery_use_interval_2
                    yaxis_id: charge/expensive
                    name: Prioterad batteridrift
                    opacity: 0.4
                    color: lime
                    type: area
                    data_generator: |
                      const data = [];
                      const sensorData = entity.state.split(' - ');
                      function parseLocalTime(str) {
                        const parts = str.split(/[- :T]/).map(Number);
                        const date = new Date(parts[0], parts[1] - 1, parts[2], parts[3], parts[4]);
                        return date.getTime();
                      }
                      const startTime = parseLocalTime(sensorData[0]);
                      const endTime = parseLocalTime(sensorData[1]);
                      data.push([startTime, 0.4]);
                      data.push([startTime, 0.4]);
                      data.push([endTime, 0.4]);
                      data.push([endTime, 0]);
                      return data;
                    show:
                      legend_value: false
                      datalabels: false
                      extremas: false
                      in_brush: false
                      in_legend: false
                  - entity: sensor.sem_nordpool_active
                    yaxis_id: spotpris
                    type: line
                    name: Elpris
                    opacity: 0.7
                    color: black
                    extend_to: false
                    data_generator: >
                      const data = entity.attributes.raw_today.map((start,
                      index) => {
                        return [new Date(start["start"]).getTime(), start["value"]];
                      });

                      const last = entity.attributes.raw_today.slice(-1)[0];

                      const lastTime = new Date(last["start"]).getTime();

                      data.push([lastTime + 3600000, last["value"]]); // 

                      return data;
                    show:
                      legend_value: false
                      datalabels: false
                      extremas: true
                      in_brush: false
                      in_legend: true
                  - entity: sensor.sem_nordpool_active
                    yaxis_id: spotpris
                    name: Imorgon
                    type: line
                    opacity: 0.7
                    color: black
                    data_generator: >
                      const data = entity.attributes.raw_tomorrow.map((start,
                      index) => {
                        return [new Date(start["start"]).getTime(), start["value"]];
                      });

                      const last = entity.attributes.raw_tomorrow.slice(-1)[0];
                      const lastTime = new Date(last["start"]).getTime();

                      data.push([lastTime + 3600000, last["value"]]);

                      return data;
                    show:
                      legend_value: false
                      datalabels: false
                      extremas: true
                      in_brush: false
                      in_legend: false
              - type: custom:vertical-stack-in-card
                cards: []
          - type: custom:vertical-stack-in-card
            cards:
              - type: conditional
                conditions:
                  - condition: state
                    entity: sensor.sem_system_plan
                    state: "2"
                card:
                  type: markdown
                  content: >+
                    üìä **Aktuella beslut av systemet** 

                    *Nya beslut kommer klockan 04:00*


                    üîã **Laddning:{% set raw =
                    states('sensor.sem_battery_charge_window_cheapest_2') %} {%
                    if ' - ' in raw %} {% set start = as_datetime(raw.split(' -
                    ')[0]) %} {% set end = as_datetime(raw.split(' - ')[1]) %}
                    {{ start.strftime('%H:%M') }}‚Äì{{ end.strftime('%H:%M') }}{%
                    else %} Ej tillg√§nglig{% endif %}**   


                    {% set profit =
                    state_attr('sensor.sem_battery_charge_energy_2_1b',
                    'profit') | float(-1) %}

                    {% set profit_threshold =
                    states('input_number.sem_charge_profit_threshold') |
                    float(0.20) %}

                    {% set avg_price =
                    state_attr('sensor.sem_battery_charge_energy_2_1b',
                    'avg_window') | float(999) %}

                    {% set supercheap =
                    states('input_number.sem_price_limit_supercheap') |
                    float(0.20) %}


                    {% set should_charge = (profit >= profit_threshold) or
                    (avg_price <= supercheap) %} - **Laddningspris:** ~{{
                    avg_price | round(2) }} kr/kWh  

                    - **Ditt vinstkrav:** >{{ profit_threshold | round(2) }}
                    kr/kWh  

                    - **Ber√§knad vinst:** {{ profit | round(2) }} kr/kWh

                    - **Beslut:** {% if should_charge %}Ladda{% else %}Ladda
                    ej{% endif %} 

                     
                    {% set raw = states('sensor.sem_relative_expensive_price_1')
                    %} {% if ' - ' in raw %}
                      {% set start = as_datetime(raw.split(' - ')[0]) %} {% set end   = as_datetime(raw.split(' - ')[1]) %}{% set hours = (end - start).total_seconds() / 3600 %} {% set need   = state_attr('sensor.sem_relative_expensive_price_1','kwh_required') | float(0) %} {% set batt   = state_attr('sensor.sem_battery_charge_energy_2_1b','battery_capacity') | float(0) %} {% set buffer = states('input_number.sem_battery_total_capacity_kwh') | float(0) * 0.10 %} {% set per_h = hours > 0 and need / hours or 0 %} {% set usable = batt - buffer %} {% if usable > 0 and hours > 0 %} {% set max_hours = usable / per_h %} {% set delta = max_hours - hours %} {% set shift = delta / 2 %} {% set new_start = start - timedelta(hours=shift) %} {% set new_end   = end + timedelta(hours=shift) %} {% else %} {% set new_start = start %} {% set new_end   = end %} {% endif %}

                    üîã **Prioriterad batteridrift: {{new_start.strftime('%H:%M')
                    }}‚Äì{{ new_end.strftime('%H:%M') }}** 

                    - **Energibehov:** {{ need | round(2) }} kWh

                    - **Batterikapacitet:** {{ batt | round(2) }} kWh

                    - **Energi per timme:** ~{{ per_h | round(2) }} kWh/h{% else
                    %}Ej tillg√§nglig{% endif %}

                    - **Dyrt prisintervall:** {% set raw =
                    states('sensor.sem_relative_expensive_price_1') %} {% if ' -
                    ' in raw %} {% set start = as_datetime(raw.split(' - ')[0])
                    %} {% set end   = as_datetime(raw.split(' - ')[1]) %}{{
                    start.strftime('%H:%M') }}‚Äì{{ end.strftime('%H:%M') }}

                    {% else %}

                    Ej tillg√§nglig

                    {% endif %}


                    üåû **Begr√§nsa solexport:** {% set raw =
                    states('sensor.sem_export_limit') %} {% if raw not in ['',
                    'unknown', 'unavailable'] and ' - ' in raw %} {% set start =
                    as_datetime(raw.split(' - ')[0]) %} {% set end =
                    as_datetime(raw.split(' - ')[1]) %} {{
                    start.strftime('%H:%M') }}‚Äì{{ end.strftime('%H:%M') }} {%
                    else %} **Ingen planerat** {% endif %}

                    {% set price_threshold = 0 %}

                    {% set all_prices =
                    (state_attr('sensor.sem_nordpool_active', 'raw_today') or
                    []) +
                                        (state_attr('sensor.sem_nordpool_active', 'raw_tomorrow') or []) %}

                    {% set start = namespace(value=None) %}

                    {% set end = namespace(value=None) %}

                    {% set hours = namespace(count=0) %}

                    {% set lowest = namespace(value=999) %}


                    {% for entry in all_prices %}
                      {% set price = entry['value'] | float %}
                      {% set time_start = entry['start'] %}
                      {% set time_end = entry['end'] %}

                      {% if price < lowest.value %}
                        {% set lowest.value = price %}
                      {% endif %}

                      {% if price <= price_threshold %}
                        {% if start.value is none %}
                          {% set start.value = time_start %}
                        {% endif %}
                        {% set end.value = time_end %}
                        {% set hours.count = hours.count + 1 %}
                      {% endif %}
                    {% endfor %}


                    {% if start.value is not none and end.value is not none %}

                    Aktiv {{ as_datetime(start.value).strftime('%H:%M') }}‚Äì{{
                    as_datetime(end.value).strftime('%H:%M') }}

                    - **Prisgr√§ns:** ‚â§ {{ price_threshold }} kr/kWh

                    - **Timmar under gr√§ns:** {{ hours.count }} h

                    - **L√§gsta pris:** {{ lowest.value | round(2) }} kr/kWh

                    {% else %}

                    - **Period under ‚â§ {{ price_threshold }} kr/kWh:** Ingen

                    - **L√§gsta pris idag/imorgon:** {{ lowest.value | round(2)
                    }} kr/kWh

                    {% endif %}





                    üí§ **Vilol√§ge (l√•gt elpris):** {% set raw =
                    states('sensor.sem_battery_cheap_interval_1a_2') %} {% if '
                    - ' in raw %} {% set start = as_datetime(raw.split(' -
                    ')[0]) %} {% set end = as_datetime(raw.split(' - ')[1]) %}
                    {% if start.year == 1970 %} **Inget planerat** {% else %} {{
                    start.strftime('%H:%M') }}‚Äì{{ end.strftime('%H:%M') }} {%
                    endif %} {% else %}**Inget planerat**{% endif %} 


                    {% set threshold =
                    states('input_number.sem_low_price_threshold') | float %}

                    {% set all_prices =
                    (state_attr('sensor.sem_nordpool_active', 'raw_today') or
                    []) +
                                        (state_attr('sensor.sem_nordpool_active', 'raw_tomorrow') or []) %}

                    {% set now_dt = now() %}

                    {% set start_ts = as_timestamp(now_dt.replace(hour=18,
                    minute=0, second=0, microsecond=0)) %}

                    {% set end_ts = as_timestamp((now_dt +
                    timedelta(days=1)).replace(hour=6, minute=0, second=0,
                    microsecond=0)) %}


                    {% set ns = namespace(lowest=999) %}


                    {% for entry in all_prices %}
                      {% if entry.start is defined and entry.value is defined %}
                        {% set entry_ts = as_timestamp(as_datetime(entry.start)) %}
                        {% if start_ts <= entry_ts <= end_ts %}
                          {% set price = entry.value | float %}
                          {% if price < ns.lowest %}
                            {% set ns.lowest = price %}
                          {% endif %}
                        {% endif %}
                      {% endif %}
                    {% endfor %}

                    - **L√§gsta pris**:{{ ns.lowest | round(3) }} kr/kWh  

                    - **Din prisgr√§ns:** ‚â§ {{ threshold }} kr/kWh


                  text_only: true
              - type: conditional
                conditions:
                  - condition: state
                    entity: sensor.sem_system_plan
                    state: "1"
                card:
                  type: markdown
                  content: >+
                    üìä **Aktuella beslut av systemet**

                    *Nya beslut kommer klockan 16:00*


                    üîã **Laddning:{% set raw =
                    states('sensor.sem_battery_charge_window_cheapest_1a') %} {%
                    if ' - ' in raw %} {% set start = as_datetime(raw.split(' -
                    ')[0]) %} {% set end = as_datetime(raw.split(' - ')[1]) %}
                    {{ start.strftime('%H:%M') }}‚Äì{{ end.strftime('%H:%M') }}{%
                    else %} Ej tillg√§nglig{% endif %}**   


                    {% set profit =
                    state_attr('sensor.sem_battery_charge_energy_1a_2',
                    'profit') | float(-1) %}

                    {% set profit_threshold =
                    states('input_number.sem_charge_profit_threshold') |
                    float(0.20) %}

                    {% set avg_price =
                    state_attr('sensor.sem_battery_charge_energy_1a_2',
                    'avg_window') | float(999) %}

                    {% set supercheap =
                    states('input_number.sem_price_limit_supercheap') |
                    float(0.20) %}


                    {% set should_charge = (profit >= profit_threshold) or
                    (avg_price <= supercheap) %} - **Laddningspris:** ~{{
                    avg_price | round(2) }} kr/kWh  

                    - **Ditt vinstkrav:** >{{ profit_threshold | round(2) }}
                    kr/kWh  

                    - **Ber√§knad vinst:** {{ profit | round(2) }} kr/kWh

                    - **Beslut:** {% if should_charge %}Ladda{% else %}Ladda
                    ej{% endif %} 

                     
                    {% set raw = states('sensor.sem_relative_expensive_price_2')
                    %} {% if ' - ' in raw %}
                      {% set start = as_datetime(raw.split(' - ')[0]) %} {% set end   = as_datetime(raw.split(' - ')[1]) %}{% set hours = (end - start).total_seconds() / 3600 %} {% set need   = state_attr('sensor.sem_relative_expensive_price_2','kwh_required') | float(0) %} {% set batt   = state_attr('sensor.sem_battery_charge_energy_2_1b','battery_capacity') | float(0) %} {% set buffer = states('input_number.sem_battery_total_capacity_kwh') | float(0) * 0.10 %} {% set per_h = hours > 0 and need / hours or 0 %} {% set usable = batt - buffer %} {% if usable > 0 and hours > 0 %} {% set max_hours = usable / per_h %} {% set delta = max_hours - hours %} {% set shift = delta / 2 %} {% set new_start = start - timedelta(hours=shift) %} {% set new_end   = end + timedelta(hours=shift) %} {% else %} {% set new_start = start %} {% set new_end   = end %} {% endif %}

                    üîã **Prioriterad batteridrift: {{new_start.strftime('%H:%M')
                    }}‚Äì{{ new_end.strftime('%H:%M') }}** 

                    - **Energibehov:** {{ need | round(2) }} kWh

                    - **Batterikapacitet:** {{ batt | round(2) }} kWh

                    - **Energi per timme:** ~{{ per_h | round(2) }} kWh/h{% else
                    %}Ej tillg√§nglig{% endif %}

                    - **Dyrt prisintervall:** {% set raw =
                    states('sensor.sem_relative_expensive_price_2') %} {% if ' -
                    ' in raw %} {% set start = as_datetime(raw.split(' - ')[0])
                    %} {% set end   = as_datetime(raw.split(' - ')[1]) %}{{
                    start.strftime('%H:%M') }}‚Äì{{ end.strftime('%H:%M') }}

                    {% else %}

                    Ej tillg√§nglig

                    {% endif %}


                    üåû **Begr√§nsa solexport:** {% set raw =
                    states('sensor.sem_export_limit') %} {% if raw not in ['',
                    'unknown', 'unavailable'] and ' - ' in raw %} {% set start =
                    as_datetime(raw.split(' - ')[0]) %} {% set end =
                    as_datetime(raw.split(' - ')[1]) %} {{
                    start.strftime('%H:%M') }}‚Äì{{ end.strftime('%H:%M') }} {%
                    else %} **Ingen planerat** {% endif %}

                    {% set price_threshold = 0 %}

                    {% set all_prices =
                    (state_attr('sensor.sem_nordpool_active', 'raw_today') or
                    []) +
                                        (state_attr('sensor.sem_nordpool_active', 'raw_tomorrow') or []) %}

                    {% set start = namespace(value=None) %}

                    {% set end = namespace(value=None) %}

                    {% set hours = namespace(count=0) %}

                    {% set lowest = namespace(value=999) %}


                    {% for entry in all_prices %}
                      {% set price = entry['value'] | float %}
                      {% set time_start = entry['start'] %}
                      {% set time_end = entry['end'] %}

                      {% if price < lowest.value %}
                        {% set lowest.value = price %}
                      {% endif %}

                      {% if price <= price_threshold %}
                        {% if start.value is none %}
                          {% set start.value = time_start %}
                        {% endif %}
                        {% set end.value = time_end %}
                        {% set hours.count = hours.count + 1 %}
                      {% endif %}
                    {% endfor %}


                    {% if start.value is not none and end.value is not none %}

                    Aktiv {{ as_datetime(start.value).strftime('%H:%M') }}‚Äì{{
                    as_datetime(end.value).strftime('%H:%M') }}

                    - **Prisgr√§ns:** ‚â§ {{ price_threshold }} kr/kWh

                    - **Timmar under gr√§ns:** {{ hours.count }} h

                    - **L√§gsta pris:** {{ lowest.value | round(2) }} kr/kWh

                    {% else %}

                    - **Period under ‚â§ {{ price_threshold }} kr/kWh:** Ingen

                    - **L√§gsta pris idag/imorgon:** {{ lowest.value | round(2)
                    }} kr/kWh

                    {% endif %}





                    üí§ **Vilol√§ge (l√•gt elpris):** {% set raw =
                    states('sensor.sem_battery_cheap_interval_2_1a') %} {% if '
                    - ' in raw %} {% set start = as_datetime(raw.split(' -
                    ')[0]) %} {% set end = as_datetime(raw.split(' - ')[1]) %}
                    {% if start.year == 1970 %} **Inget planerat** {% else %} {{
                    start.strftime('%H:%M') }}‚Äì{{ end.strftime('%H:%M') }} {%
                    endif %} {% else %}**Inget planerat**{% endif %} 


                    {% set threshold =
                    states('input_number.sem_low_price_threshold') | float %}

                    {% set all_prices =
                    (state_attr('sensor.sem_nordpool_active', 'raw_today') or
                    []) +
                                        (state_attr('sensor.sem_nordpool_active', 'raw_tomorrow') or []) %}

                    {% set now_dt = now() %}

                    {% set start_ts = as_timestamp(now_dt.replace(hour=18,
                    minute=0, second=0, microsecond=0)) %}

                    {% set end_ts = as_timestamp((now_dt +
                    timedelta(days=1)).replace(hour=6, minute=0, second=0,
                    microsecond=0)) %}


                    {% set ns = namespace(lowest=999) %}


                    {% for entry in all_prices %}
                      {% if entry.start is defined and entry.value is defined %}
                        {% set entry_ts = as_timestamp(as_datetime(entry.start)) %}
                        {% if start_ts <= entry_ts <= end_ts %}
                          {% set price = entry.value | float %}
                          {% if price < ns.lowest %}
                            {% set ns.lowest = price %}
                          {% endif %}
                        {% endif %}
                      {% endif %}
                    {% endfor %}

                    - **L√§gsta pris**:{{ ns.lowest | round(3) }} kr/kWh  

                    - **Din prisgr√§ns:** ‚â§ {{ threshold }} kr/kWh


badges:
  - type: entity
    show_name: true
    show_state: true
    show_icon: true
    visibility:
      - condition: state
        entity: input_boolean.sem_export_limit_active
        state: "on"
    entity: input_boolean.sem_max_export_active
    name: Begr√§nsar solexport
    icon: mdi:weather-sunny-off
    tap_action:
      action: none
    color: primary
    hold_action:
      action: more-info
  - type: entity
    show_name: true
    show_state: true
    show_icon: true
    visibility:
      - condition: state
        entity: input_boolean.sem_discharge_high_prices
        state: "on"
    entity: input_boolean.sem_discharge
    name: S√§ljer batteri√∂verskott
    icon: mdi:battery-negative
    tap_action:
      action: none
    color: primary
    hold_action:
      action: more-info
  - type: entity
    show_name: true
    show_state: true
    show_icon: true
    visibility:
      - condition: state
        entity: input_boolean.sem_ev_charging_protection_enabled
        state: "on"
    entity: input_boolean.sem_ev_charging_protection_status
    name: Skydd vid elbilsladdning
    icon: mdi:ev-plug-type2
    color: primary
    tap_action:
      action: none
    hold_action:
      action: more-info
  - type: entity
    show_name: true
    show_state: true
    show_icon: true
    entity: timer.sem_manual_charge_time
    name: Manuell laddning
    visibility:
      - condition: state
        entity: input_boolean.sem_manual_charge
        state: "on"
    color: primary
    tap_action:
      action: none
    hold_action:
      action: more-info
  - type: entity
    show_name: true
    show_state: true
    show_icon: true
    entity: input_boolean.sem_battery_cheap_mode
    name: Vilol√§ge (L√•gt elpris)
    icon: mdi:sleep
    tap_action:
      action: none
    color: primary
    hold_action:
      action: more-info
  - type: entity
    show_name: true
    show_state: true
    show_icon: true
    entity: input_boolean.sem_battery_save
    name: Vilol√§ge (Innan pristopp)
    icon: mdi:sleep
    tap_action:
      action: none
    color: primary
    hold_action:
      action: more-info
  - type: entity
    show_name: true
    show_state: true
    show_icon: false
    entity: sensor.sem_update_status
    icon: mdi:database
    tap_action:
      action: navigate
      navigation_path: "#settings"
    name: Mitt system
