template:
  - sensor:

# CHECK IF THE SYSTEM IS UP TO DATE
      - name: "sem_update_status"
        state: >
          {% set local = states('sensor.sem_version') %}
          {% set remote = states('sensor.sem_github_latest_release') %}

          {% if local in ['unknown','unavailable'] or remote in ['unknown','unavailable'] %}
            ‚ùî Ok√§nt
          {% elif local == remote %}
            ‚úÖ Uppdaterat
          {% else %}
            üéâ Uppdatering tillg√§nglig
          {% endif %}

####################################### WALLBOX ####################################################
#SHOWS CHARGEBOX STATE 1
      - name: "sem_ev_sensor_state"
        unique_id: sem_ev_sensor_state
        state: >
          {% set sensor_name = states('input_text.sem_ev_sensor_state') %}
          {% if sensor_name and states(sensor_name) not in ['unknown', 'unavailable', None, ''] %}
            {{ states(sensor_name) }}
          {% else %}
            unknown
          {% endif %}

# SHOWS CHARGEBOX STATE 2
      - name: "sem_ev_sensor_state_2"
        unique_id: sem_ev_sensor_state_2
        state: >
          {% set sensor_name = states('input_text.sem_ev_sensor_state_2') %}
          {% if sensor_name and states(sensor_name) not in ['unknown', 'unavailable', None, ''] %}
            {{ states(sensor_name) }}
          {% else %}
            unknown
          {% endif %}


# SHOWS WALLBOX POWER (kW)
      - name: "sem_ev_sensor_power"
        unique_id: sem_ev_sensor_power
        unit_of_measurement: "kW"
        device_class: power
        state_class: measurement
        state: >
          {% set multi = is_state('input_boolean.sem_ev_wallbox_multi', 'on') %}
          {% set sn1 = states('input_text.sem_ev_sensor') %}
          {% set sn2 = states('input_text.sem_ev_sensor_2') %}

          {% macro get_kw(name) %}
            {% if not name or name in ['unknown','unavailable',''] %}
              0
            {% else %}
              {% set val = states(name) | float(0) %}
              {% set unit = (state_attr(name, 'unit_of_measurement') or '') | lower %}
              {% if unit == 'w' %}
                {% set val = val / 1000 %}
              {% endif %}
              {{ val }}
            {% endif %}
          {% endmacro %}

          {% set v1 = get_kw(sn1) | float %}

          {% if multi %}
            {% set v2 = get_kw(sn2) | float %}
          {% else %}
            {% set v2 = 0 %}
          {% endif %}

          {% set total = v1 + v2 %}

          {% if total < 0 %}
            0
          {% else %}
            {{ total | round(2) }}
          {% endif %}

# CHECK IF USER HAS A WALLBOX
      - name: "sem_wallbox_check"
        unique_id: sem_wallboc_check
        state: >
          {% set v = states('input_text.sem_ev_sensor') %}
          {{ v not in ['unknown', 'unavailable', ''] and v.startswith('sensor.') }}








################################ ELECTRICITY ####################################################
#SHOWS NORDPOOL STATE (KOLLA OM DEN FINNS MED I KODEN - BYT D√Ö TILL sem_nordpool_active)
      - name: "sem_nordpool_sensor_state"
        unique_id: sem_nordpool_sensor_state
        unit_of_measurement: "SEK/kWh"
        state: >
          {% set sensor_name = states('sensor.sem_nordpool_sensor_id') %}
          {% if sensor_name and states(sensor_name) not in ['unknown', 'unavailable', None, ''] %}
            {{ states(sensor_name) }}
          {% else %}
            unknown
          {% endif %}

# CHOOSES IF OFFICIAL OR INOFFICIAL NORDPOOL SENSOR IS IN USE
      - name: "sem_nordpool_sensor_id"
        unique_id: sem_nordpool_sensor_id
        state: >
          {%- if is_state('input_boolean.sem_use_official_nordpool', 'on') -%}
            sensor.sem_nordpool_sensor_official
          {%- else -%}
            {{ states('input_text.sem_nordpool_sensor_inofficial') }}
          {%- endif -%}

#SHOWS ELECTRICPRICE FOR HACS OR OFFICIAL NORDPOOL
      - name: "sem_nordpool_active"
        unique_id: sem_nordpool_active
        unit_of_measurement: "SEK/kWh"
        device_class: monetary
        state_class: measurement
        state: >
          {% set sensor_id = (states('sensor.sem_nordpool_sensor_id') or '') | trim %}
          {% set source = expand(sensor_id) %}
          {% if source | count > 0 %}
            {{ source[0].state | float }}
          {% else %}
            unknown
          {% endif %}
        attributes:
          source_sensor: >
            {{ (states('sensor.sem_nordpool_sensor_id') or '') | trim }}
          debug_sensor_exists: >
            {% set sensor_id = (states('sensor.sem_nordpool_sensor_id') or '') | trim %}
            {{ (expand(sensor_id) | count) > 0 }}
          raw_today: >
            {% set sensor_id = (states('sensor.sem_nordpool_sensor_id') or '') | trim %}
            {% set source = expand(sensor_id) %}
            {% if source | count > 0 %}
              [
              {%- for e in source[0].attributes.get('raw_today', []) %}
                {
                  "start": "{{ e.start.isoformat() if e.start is not string else e.start }}",
                  "end": "{{ e.end.isoformat() if e.end is not string else e.end }}",
                  "value": {{ e.value }}
                }{% if not loop.last %},{% endif %}
              {%- endfor %}
              ]
            {% else %}
              []
            {% endif %}
          raw_tomorrow: >
            {% set sensor_id = (states('sensor.sem_nordpool_sensor_id') or '') | trim %}
            {% set source = expand(sensor_id) %}
            {% if source | count > 0 %}
              [
              {%- for e in source[0].attributes.get('raw_tomorrow', []) %}
                {
                  "start": "{{ e.start.isoformat() if e.start is not string else e.start }}",
                  "end": "{{ e.end.isoformat() if e.end is not string else e.end }}",
                  "value": {{ e.value }}
                }{% if not loop.last %},{% endif %}
              {%- endfor %}
              ]
            {% else %}
              []
            {% endif %}
          today: >
            {% set sensor_id = (states('sensor.sem_nordpool_sensor_id') or '') | trim %}
            {% set source = expand(sensor_id) %}
            {% if source | count > 0 %}
              {{ source[0].attributes.get('today', []) }}
            {% else %}
              []
            {% endif %}
          tomorrow: >
            {% set sensor_id = (states('sensor.sem_nordpool_sensor_id') or '') | trim %}
            {% set source = expand(sensor_id) %}
            {% if source | count > 0 %}
              {{ source[0].attributes.get('tomorrow', []) }}
            {% else %}
              []
            {% endif %}
          currency: >
            {% set sensor_id = (states('sensor.sem_nordpool_sensor_id') or '') | trim %}
            {% set source = expand(sensor_id) %}
            {% if source | count > 0 %}
              {{ source[0].attributes.get('currency', 'SEK') }}
            {% else %}
              'SEK'
            {% endif %}
          tomorrow_valid: >
            {% set sensor_id = (states('sensor.sem_nordpool_sensor_id') or '') | trim %}
            {% set source = expand(sensor_id) %}
            {% if source | count > 0 %}
              {{ source[0].attributes.get('raw_tomorrow') | length > 0 }}
            {% else %}
              false
            {% endif %}

# N√ÑTIMPORT ‚Äì effekt i kW
      - name: "sem_import_power"
        unique_id: sem_import_power
        unit_of_measurement: "kW"
        device_class: power
        state_class: measurement
        state: >
          {% macro to_kw(entity_id) %}
            {% set value = states(entity_id) | float(0) %}
            {% set unit = state_attr(entity_id, 'unit_of_measurement') | default('') | lower %}
            {% if 'w' in unit and 'kw' not in unit %}
              {{ value / 1000 }}
            {% else %}
              {{ value }}
            {% endif %}
          {% endmacro %}
          {% set p = to_kw('sensor.power_meter_active_power') | float(0) %}
          {{ (-p if p < 0 else 0) | round(2) }}

# N√ÑTEXPORT ‚Äì effekt i kW
      - name: "sem_export_power"
        unique_id: sem_export_power
        unit_of_measurement: "kW"
        device_class: power
        state_class: measurement
        state: >
          {% macro to_kw(entity_id) %}
            {% set value = states(entity_id) | float(0) %}
            {% set unit = state_attr(entity_id, 'unit_of_measurement') | default('') | lower %}
            {% if 'w' in unit and 'kw' not in unit %}
              {{ value / 1000 }}
            {% else %}
              {{ value }}
            {% endif %}
          {% endmacro %}
          {% set p = to_kw('sensor.power_meter_active_power') | float(0) %}
          {{ (p if p > 0 else 0) | round(2) }}


# SOLAR POWER
      - name: "sem_input_power_with_efficiency_loss_kW"
        unique_id: "sem_input_power_with_efficiency_loss_kW"
        unit_of_measurement: "kW"
        device_class: power
        state_class: measurement
        state: >-
          {% set inverter_rating = 10000 %}
          {% set inpower = states('sensor.inverter_input_power') | float(0) %}
          {% if inpower < (inverter_rating * 0.1) %}
              {{ (inpower * 0.90 / 1000) | round(2) }}
          {% elif inpower < (inverter_rating * 0.2) %}
              {{ (inpower * 0.95 / 1000) | round(2) }}
          {% else %}
              {{ (inpower * 0.98 / 1000) | round(2) }}
          {% endif %}

# SELF CONSUMED SOLAR ENERGY TODAY
      - name: "sem_consumed_solar_energy_today"
        unique_id: "sem_consumed_solar_energy_today"
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: total
        state: >
          {% set solar_produced = states('sensor.sem_solar_production') | float(0) %}
          {% set solar_exported = states('sensor.sem_export') | float(0) %}
          {{ [solar_produced - solar_exported, 0] | max | round(2) }}

# HOUSE POWER - NO EV
      - name: "sem_house_power"
        unique_id: sem_house_power
        unit_of_measurement: "kW"
        state: >
          {# === FUNKTION F√ñR ATT KONVERTERA W ‚Üí kW === #}
          {% macro to_kw(entity_id) %}
            {% set value = states(entity_id) | float(0) %}
            {% set unit = state_attr(entity_id, 'unit_of_measurement') | default('') | lower %}
            {% if 'w' in unit and 'kw' not in unit %}
              {{ value / 1000 }}
            {% else %}
              {{ value }}
            {% endif %}
          {% endmacro %}

          {# === N√ÑTEFFEKT (Huawei integration) === #}
          {% set net_power = to_kw('sensor.power_meter_active_power') | float(0) %}
          {% set import = -net_power if net_power < 0 else 0 %}
          {% set export = net_power if net_power > 0 else 0 %}

          {# === EV-LADDNING === #}
          {% set ev_sensor_id_1 = states('input_text.sem_ev_sensor') %}
          {% set ev_sensor_id_2 = states('input_text.sem_ev_sensor_2') %}
          {% set ev_1 = to_kw(ev_sensor_id_1) | float(0) if ev_sensor_id_1 else 0 %}
          {% set ev_2 = to_kw(ev_sensor_id_2) | float(0) if ev_sensor_id_2 else 0 %}
          {% set ev = ev_1 + ev_2 %}

          {# === SOLPRODUKTION === #}
          {% set solar = to_kw('sensor.sem_input_power_with_efficiency_loss_kW') | float(0) %}

          {# === BATTERI === #}
          {% set batt = to_kw('sensor.batteries_charge_discharge_power') | float(0) %}
          {% set batt_out = -batt if batt < 0 else 0 %}
          {% set batt_in = batt if batt > 0 else 0 %}

          {# === HUSF√ñRBRUKNING === #}
          {% set house_power = (solar + import + batt_out) - (export + ev + batt_in) %}

          {{ [house_power, 0] | max | round(2) }}

################################ SOLAR FORECAST ####################################################

      - name: "sem_solar_forecast"
        unique_id: sem_solar_forecast
        state: "OK"
        attributes:
          sem: >
            {% set use_s2 = is_state('input_boolean.sem_solar_2', 'on') %}

            {% set s1 = state_attr('sensor.sem_solar_forecast_1', 'sem') or {} %}
            {% set s2 = state_attr('sensor.sem_solar_forecast_2', 'sem') if use_s2 else {} %}

            {% set attrs = ['watt_hours', 'watt_hours_day', 'watt_hours_period', 'watts'] %}

            {
            {% for attr in attrs %}
              "{{ attr }}": [

                {% set l1 = s1.get(attr, []) or [] %}
                {% set l2 = s2.get(attr, []) or [] %}

                {% set dates1 = l1 | map(attribute='date') | list %}
                {% set dates2 = l2 | map(attribute='date') | list %}
                {% set all_dates = (dates1 + dates2) | unique | sort %}

                {% for d in all_dates %}
                    {% set e1 = l1 | selectattr('date','equalto',d) | first %}
                    {% set e2 = l2 | selectattr('date','equalto',d) | first %}

                    {% set v1 = e1['values'] if e1 is mapping and 'values' in e1 else 0 %}
                    {% set v2 = e2['values'] if e2 is mapping and 'values' in e2 else 0 %}

                    {
                      "label": "{{ attr }}",
                      "date": "{{ d }}",
                      "values": {{ (v1 | float + v2 | float) | int }}
                    }{% if not loop.last %},{% endif %}
                {% endfor %}

              ]{% if not loop.last %},{% endif %}
            {% endfor %}
            }



################################################## UI ##############################################
# SHOW CHARGE DECISION 1A TO 2
      - name: "sem_charge_decision_1A"
        state: >
          {% set val = state_attr('sensor.sem_battery_charge_energy_1a_2', 'should_charge') %}
          
          {% if val in [true, 'true', 'True'] %}
            Laddning planerad
          {% elif val in [false, 'false', 'False'] %}
            Ingen laddning
          {% else %}
            Ok√§nt.
          {% endif %}

# SHOW CHARGE DECISION 2 TO 1B
      - name: "sem_charge_decision_2"
        state: >
          {% set val = state_attr('sensor.sem_battery_charge_energy_2_1b', 'should_charge') %}
          
          {% if val in [true, 'true', 'True'] %}
            Laddning planerad
          {% elif val in [false, 'false', 'False'] %}
            Ingen laddning
          {% else %}
            Ok√§nt.
          {% endif %}



# TRANSLATES WORKING MODE TO SWEDISH
      - name: "sem_battery_mode"
        unique_id: sem_battery_mode     
        state: >
          {% set mode = states('select.batteries_working_mode') %}
          {% if mode == 'adaptive' %}
            Adaptiv
          {% elif mode == 'fixed_charge_discharge' %}
            Fast
          {% elif mode == 'maximise_self_consumption' %}
            Sj√§lvf√∂rs√∂rjning
          {% elif mode == 'fully_fed_to_grid' %}
            Export
          {% elif mode == 'time_of_use_luna2000' %}
            Import
          {% else %}
            Ok√§nt l√§ge
          {% endif %}

# CHANGE CHARGING CARD IN UI
      - name: "sem_battery_charging_interval_next"
        unique_id: sem_battery_charging_interval_next
        state: >
          {% set now_dt = now() %}
          {% set raw_1a = states('sensor.sem_battery_charge_window_cheapest_1a') %}
          {% set raw_2  = states('sensor.sem_battery_charge_window_cheapest_2') %}

          {% set start_1a, end_1a = (raw_1a.split(' - ') if (raw_1a is string and ' - ' in raw_1a) else [none, none]) %}
          {% set start_2,  end_2  = (raw_2.split(' - ')  if (raw_2 is string and ' - ' in raw_2)  else [none, none]) %}

          {% set dt_start_1a = as_datetime(start_1a) if start_1a else none %}
          {% set dt_end_1a   = as_datetime(end_1a)   if end_1a   else none %}
          {% set dt_start_2  = as_datetime(start_2)  if start_2  else none %}
          {% set dt_end_2    = as_datetime(end_2)    if end_2    else none %}

          {% set upcoming = [] %}
          {% if dt_end_1a and dt_end_1a > now_dt %}
                    {% set sort_key = dt_start_1a if (dt_start_1a and dt_start_1a > now_dt) else now_dt %}
                    {% set upcoming = upcoming + [{'name':'1a','sort': sort_key}] %}
          {% endif %}
          {% if dt_end_2 and dt_end_2 > now_dt %}
                    {% set sort_key = dt_start_2 if (dt_start_2 and dt_start_2 > now_dt) else now_dt %}
                    {% set upcoming = upcoming + [{'name':'2','sort': sort_key}] %}
          {% endif %}

          {# V√§lj n√§rmast (min sort) #}
          {% set sorted_upcoming = upcoming | sort(attribute='sort') %}
          {% set next = sorted_upcoming[0] if sorted_upcoming else none %}

          {% if next and next['name'] == '1a' %}
                    1
          {% else %}
                    2
          {% endif %}


################################ SMART LOGIC ####################################################


# SHOWS INTERVAL WHEN SOLAREXPORT SHOULD BE REDUCED 
      - name: "sem_export_limit"
        unique_id: sem_export_limit
        state: >
          {% set limit_active = is_state('input_boolean.sem_export_limit_active', 'on') %}
          {% if not limit_active %}
            ""
          {% else %}
            {% set price_threshold = 0 %}
            {% set all_prices = (state_attr('sensor.sem_nordpool_active', 'raw_today') or []) +
                                (state_attr('sensor.sem_nordpool_active', 'raw_tomorrow') or []) %}
            {% set start = namespace(value=None) %}
            {% set end = namespace(value=None) %}           
            {% for entry in all_prices %}
              {% set price = entry['value'] | float %}
              {% set time_start = entry['start'] %}
              {% set time_end = entry['end'] %}
            
              {% if price <= price_threshold %}
                {% if start.value is none %}
                  {% set start.value = time_start %}
                {% endif %}
                {% set end.value = time_end %}
              {% endif %}
            {% endfor %}          
            {% if start.value is not none and end.value is not none %}
              {{ start.value }} - {{ end.value }}
            {% else %}
              ""
            {% endif %}
          {% endif %}

# CALCULATES CHARGE TIME FROM MAX kW
      - name: "sem_battery_dynamic_charge_time_window_1"
        unique_id: sem_battery_dynamic_charge_time_window_1
        unit_of_measurement: "h"
        state: >
          {# 
            Ber√§knar laddningstid f√∂r laddningsf√∂nster 1 (kl. 9‚Äì16)
            Konservativ vinterfaktor f√∂r kalla batterier (carport/f√∂rr√•d)
            Max 5 timmar.
          #}

          {% set capacity = states('input_number.sem_battery_total_capacity_kwh') | float(0) %}
          {% set max_power_kw = states('input_number.sem_max_charge_power_window_1') | float(0) %}

          {# Kraftigt justerad m√•nadsbaserad f√∂rlustfaktor #}
          {% set month = now().month %}
          {% set loss_factor =
              0.68 if month in [1, 2] else       
              0.82 if month in [3, 4] else        
              0.92 if month in [5, 6, 7, 8, 9] else
              0.75 if month in [10, 11, 12] else  
              0.9
          %}

          {% if max_power_kw > 0 %}
            {% set effective_power = max_power_kw * loss_factor %}
            {% set hours = capacity / effective_power %}
            {{ [ hours | round(1), 5 ] | min }}
          {% else %}
            0
          {% endif %}




# CALCULATES CHARGE TIME FROM MAX kW
      - name: "sem_battery_dynamic_charge_time_window_2"
        unique_id: sem_battery_dynamic_charge_time_window_2
        unit_of_measurement: "h"
        state: >
          {# 
            Ber√§knar laddningstid f√∂r laddningsf√∂nster 2 (kl. 23‚Äì05)
            Konservativ vinterfaktor f√∂r kalla batterier (carport/f√∂rr√•d)
            Max 5 timmar.
          #}

          {% set capacity = states('input_number.sem_battery_total_capacity_kwh') | float(0) %}
          {% set max_power_kw = states('input_number.sem_max_charge_power_window_2') | float(0) %}

          {% set month = now().month %}
          {% set loss_factor =
              0.68 if month in [1, 2] else        
              0.82 if month in [3, 4] else        
              0.92 if month in [5, 6, 7, 8, 9] else
              0.75 if month in [10, 11, 12] else  
              0.9
          %}

          {% if max_power_kw > 0 %}
            {% set effective_power = max_power_kw * loss_factor %}
            {% set hours = capacity / effective_power %}
            {{ [ hours | round(1), 5 ] | min }}
          {% else %}
            0
          {% endif %}



# CALCULATES ENERGY BETWEEN 1A AND 2
      - name: "sem_battery_charge_energy_1a_2"
        unique_id: sem_battery_charge_energy_1a_2
        unit_of_measurement: "kWh"
        state: >
          {% set battery_capacity = state_attr('sensor.sem_battery_charge_energy_1a_2','battery_capacity') | float(0) %} 
          {% set usable_capacity = state_attr('sensor.sem_battery_charge_energy_1a_2','usable_capacity') | float(0) %} 
          {% set weather_buffer = state_attr('sensor.sem_battery_charge_energy_1a_2','weather_buffer') | float(0) %} 
          {% set estimated_energy_sun_interval = state_attr('sensor.sem_battery_charge_energy_1a_2','estimated_energy_sun_interval') | float(0) %} 
          {% set estimated_solar_energy = state_attr('sensor.sem_battery_charge_energy_1a_2','estimated_solar_energy') | float(0) %} 
          {% set estimated_energy_no_sun_interval = state_attr('sensor.sem_battery_charge_energy_1a_2','estimated_energy_no_sun_interval') | float(0) %} 
          {% set avg_price_charge_window = state_attr('sensor.sem_battery_charge_energy_1a_2','avg_price') | float(0) %} 
          {% set price_limit_supercheap = states('input_number.sem_price_limit_supercheap') | float(0) %} 
          {% set supercheap_charge = state_attr('sensor.sem_battery_charge_energy_1a_2','supercheap_charge') | float(0) %}
          {% set extra = states('input_number.extra_1') | float(0) %}
          {% set adjustment_factor_solar_energy = state_attr('sensor.sem_battery_charge_energy_1a_2','adjustment_factor_solar_energy') | float(0) %}
          {% set ev_charge_factor = state_attr('sensor.sem_battery_charge_energy_1a_2','ev_charge_factor') | float(0) %}
          {% set battery_max = states('input_number.sem_battery_total_capacity_kwh') | float(0) %}
        

          {% set solar_diff = [estimated_energy_sun_interval - ((estimated_solar_energy * adjustment_factor_solar_energy) * ev_charge_factor) , 0] | max %}
          {% set raw_total = (estimated_energy_no_sun_interval + solar_diff + weather_buffer) - battery_capacity %}
          {% set total_energy_need = [raw_total, 0] | max %}

          {{ (total_energy_need + supercheap_charge + extra, battery_max) | min  }}      
#          {{ (total_energy_need + supercheap_charge + extra) | round(2) }}
        attributes:
            search_interval: >
                  {% set raw_start = states('sensor.sem_battery_charge_window_cheapest_1a') %}
                  {% set raw_end = states('sensor.sem_battery_charge_window_cheapest_2') %}
                  {% if ' - ' in raw_start and ' - ' in raw_end %}
                        {% set t1 = raw_start.split(' - ')[0] %}
                        {% set t2 = raw_end.split(' - ')[0] %}
                        {% set start = as_datetime(t1) %}
                        {% set end = as_datetime(t2) %}
                  {% else %}
                        {% set start = as_datetime('1970-01-01T00:00:00+00:00') %}
                        {% set end = as_datetime('1970-01-01T01:00:00+00:00') %}
                  {% endif %}
                  {{ start.isoformat() }} - {{ end.isoformat() }}
            sun_interval: >
                  {% set raw_start = states('sensor.sem_battery_charge_window_cheapest_1a') %}
                  {% set raw_end = states('sensor.sem_battery_charge_window_cheapest_2') %}

                  {% if ' - ' in raw_start and ' - ' in raw_end %}
                        {% set t1 = raw_start.split(' - ')[0] %}
                        {% set t2 = raw_end.split(' - ')[0] %}
                        {% set start = as_datetime(t1) %}
                        {% set end = as_datetime(t2) %}
                  {% else %}
                        {% set start = as_datetime('1970-01-01T00:00:00+00:00') %}
                        {% set end = as_datetime('1970-01-01T01:00:00+00:00') %}
                  {% endif %}

                  {% set forecast = state_attr('sensor.sem_solar_forecast', 'sem') %}
                  {% set solar_interval_start = none %}
                  {% set solar_interval_end = none %}

                  {% if forecast and 'watt_hours_period' in forecast %}
                        {% set start_ts = as_timestamp(start) %}
                        {% set end_ts = as_timestamp(end) %}
                        {% set today_date = start.date() %}
                        {% set entries = forecast['watt_hours_period']
                          | selectattr('date', 'defined')
                          | selectattr('date', '>=', start_ts | timestamp_local)
                          | selectattr('date', '<=', end_ts | timestamp_local)
                          | selectattr('date', 'match', '^' ~ today_date|string)
                          | list %}
                        {% set valid_entries = entries
                          | selectattr('values', 'defined')
                          | selectattr('values', '>', 0)
                          | list %}

                        {% if valid_entries | length > 0 %}
                              {% set solar_interval_start = (valid_entries[0].date | as_datetime).replace(minute=0, second=0, microsecond=0) %}
                              {% set solar_interval_end = (valid_entries[-1].date | as_datetime).replace(minute=0, second=0, microsecond=0) %}
                        {% endif %}
                  {% endif %}

                  {% if solar_interval_start and solar_interval_end %}
                        {{ solar_interval_start.isoformat() }} - {{ solar_interval_end.isoformat() }}
                  {% else %}
                        {{ '1970-01-01T00:00:00+00:00 - 1970-01-01T00:00:00+00:00' }}
                  {% endif %}
            no_sun_interval: >
                  {% set raw_end = states('sensor.sem_battery_charge_window_cheapest_2') %}
                  {% set raw_start = states('sensor.sem_battery_charge_window_cheapest_1a') %}
                  {% if ' - ' in raw_start and ' - ' in raw_end %}
                        {% set t1 = raw_start.split(' - ')[0] %}
                        {% set t2 = raw_end.split(' - ')[0] %}
                        {% set start = as_datetime(t1) %}
                        {% set end = as_datetime(t2) %}
                  {% else %}
                        {% set start = as_datetime('1970-01-01T00:00:00+00:00') %}
                        {% set end = as_datetime('1970-01-01T01:00:00+00:00') %}
                  {% endif %}
                  {% set forecast = state_attr('sensor.sem_solar_forecast', 'sem') %}
                  {% set solar_interval_end = none %}
                  {% if forecast and 'watt_hours_period' in forecast %}
                        {% set start_ts = as_timestamp(start) %}
                        {% set end_ts = as_timestamp(end) %}
                        {% set today_date = start.date() %}
                        {% set entries = forecast['watt_hours_period']
                          | selectattr('date', 'defined')
                          | selectattr('date', '>=', start_ts | timestamp_local)
                          | selectattr('date', '<=', end_ts | timestamp_local)
                          | selectattr('date', 'match', '^' ~ today_date|string)
                          | list %}
                        {% set valid_entries = entries
                          | selectattr('values', 'defined')
                          | selectattr('values', '>', 0)
                          | list %}
                        {% if valid_entries | length > 0 %}
                              {% set solar_interval_end = (valid_entries[-1].date | as_datetime).replace(minute=0, second=0, microsecond=0) %}
                        {% endif %}
                  {% endif %}
                  {% if solar_interval_end %}
                        {{ solar_interval_end.isoformat() }} - {{ end.isoformat() }}
                  {% else %}
                        1970-01-01T00:00:00+00:00 - 1970-01-01T00:00:00+00:00
                  {% endif %}
            battery_capacity: >
                  {# Visar aktuell laddning i kWh min SoC (dvs det som faktiskt √§r anv√§ndbart) #}
                  {% set capacity = states('input_number.sem_battery_total_capacity_kwh') | float(0) %}
                  {% set soc = states('sensor.batteries_state_of_capacity') | float(0) %}
                  {% set min_soc = states('number.batteries_end_of_discharge_soc') | float(0) %}
                  {% set denom = (100 - min_soc) %}
                  {% if denom <= 0 %}
                        {{ 0.0 }}
                  {% else %}
                        {% set usable_capacity = capacity * ((100 - min_soc) / 100) %}
                        {% set soc_clamped = soc %}
                        {% if soc_clamped < min_soc %}
                              {% set soc_clamped = min_soc %}
                        {% endif %}
                        {% if soc_clamped > 100 %}
                              {% set soc_clamped = 100 %}
                        {% endif %}
                        {% set current_kwh = usable_capacity * ((soc_clamped - min_soc) / denom) %}
                        {{ current_kwh | round(2) }}
                  {% endif %}
            usable_capacity: >
                  {# Total anv√§ndbar kapacitet (kWh) givet min SoC #}
                  {% set capacity = states('input_number.sem_battery_total_capacity_kwh') | float(0) %}
                  {% set min_soc = states('number.batteries_end_of_discharge_soc') | float(0) %}
                  {% set denom = (100 - min_soc) %}
                  {% if denom <= 0 %}
                        {{ 0.0 }}
                  {% else %}
                        {{ (capacity * ((100 - min_soc) / 100)) | round(2) }}
                  {% endif %}
            weather_buffer: >
                  {# --- H√§mta temperaturer med fallback --- #}
                  {% set temp_today = states('sensor.sem_temp_low') | float(0) %}
                  {% set temp_yesterday = state_attr('sensor.sem_temp_low','yesterday') | float(temp_today) %}
                  {% set temp_day_before = state_attr('sensor.sem_temp_low','day_before') | float(temp_yesterday) %}
                  {% set temp_three_days_ago = state_attr('sensor.sem_temp_low','three_days_ago') | float(temp_day_before) %}

                  {# --- StartkWh  --- #}
                  {% if temp_today < 5 %}
                    {% set start_kwh = 4 %} 
                  {% elif temp_today < 10 %}
                    {% set start_kwh = 2 %}  
                  {% elif temp_today < 12 %}
                    {% set start_kwh = 1 %}  
                  {% else %}
                    {% set start_kwh = 0 %} 
                  {% endif %}

                  {# --- Extra kWh baserat p√• temperaturskillnader --- #}
                  {% set diff_yesterday = temp_yesterday - temp_today %}
                  {% set diff_day_before = temp_day_before - temp_today %}
                  {% set diff_three_days_ago = temp_three_days_ago - temp_today %}
                  {% set extra_kwh = 0 %}
                  {% if diff_yesterday > 2 %}{% set extra_kwh = extra_kwh + diff_yesterday %}{% endif %}
                  {% if diff_day_before > 2 %}{% set extra_kwh = extra_kwh + (diff_day_before / 2) %}{% endif %}
                  {% if diff_three_days_ago > 2 %}{% set extra_kwh = extra_kwh + (diff_three_days_ago / 3) %}{% endif %}

                  {# --- Stabilisering vid stabil temperatur --- #}
                  {% set stable =
                    ((temp_today - temp_yesterday) | abs <= 1) and
                    ((temp_today - temp_day_before) | abs <= 1) and
                    ((temp_today - temp_three_days_ago) | abs <= 1)
                  %}
                  {% if stable %}
                    {% set start_kwh = start_kwh * 0.5 %}
                    {% set extra_kwh = extra_kwh * 0.5 %}
                  {% endif %}

                  {# --- Total kWh som attribut --- #}
                  {
                    {{ (start_kwh + extra_kwh) | round(1) }}
                  }
            extra: >
                  {% set extra = states('input_number.extra_1') | float(0) %}
                  {{ extra | round(2) }}
            supercheap_charge: >
                  {# --- Ber√§kna medelpris f√∂r laddningsintervallet (kvartpris) --- #}
                  {% set interval_raw = states('sensor.sem_battery_charge_window_cheapest_1a') %}
                  {% set avg_price = 99 %}
                  {% if interval_raw and ' - ' in interval_raw %}
                  {% set start_dt = as_datetime(interval_raw.split(' - ')[0]) %}
                  {% set end_dt = as_datetime(interval_raw.split(' - ')[1]) %}
                  {% set raw_today = state_attr('sensor.sem_nordpool_sensor_id','raw_today') or [] %}
                  {% set raw_tomorrow = state_attr('sensor.sem_nordpool_sensor_id','raw_tomorrow') or [] %}
                  {% set tomorrow_valid = state_attr('sensor.sem_nordpool_sensor_id','tomorrow_valid') == true %}
                  {% set ns = namespace(total=0.0, count=0) %}

                  {% set quarters = ((end_dt - start_dt).total_seconds() // 900) | int %}

                  {% for i in range(quarters) %}
                  {% set t = start_dt + timedelta(minutes=i*15) %}
                  {% set index = t.hour*4 + (t.minute // 15) %}
                  {% if t.date() == now().date() %}
                  {% set p = raw_today[index].value if raw_today|length > index else None %}
                  {% elif tomorrow_valid and t.date() == (now().date() + timedelta(days=1)) %}
                  {% set p = raw_tomorrow[index].value if raw_tomorrow|length > index else None %}
                  {% else %}
                  {% set p = None %}
                  {% endif %}
                  {% if p is not none %}
                  {% set ns.total = ns.total + (p|string|replace(',','.')|float(0)) %}
                  {% set ns.count = ns.count + 1 %}
                  {% endif %}
                  {% endfor %}

                  {% if ns.count > 0 %}
                  {% set avg_price = ns.total / ns.count %}
                  {% endif %}
                  {% endif %}

                  {# --- V√§rden f√∂r ber√§kningen --- #}
                  {% set price_limit_supercheap = states('input_number.sem_price_limit_supercheap') | float(0) %}
                  {% set battery_capacity = state_attr('sensor.sem_battery_charge_energy_1a_2','battery_capacity') | float(0) %}
                  {% set usable_capacity = state_attr('sensor.sem_battery_charge_energy_1a_2','usable_capacity') | float(0) %}
                  {% set soc = states('sensor.batteries_state_of_capacity') | float(0) %}
                  {% set max_buffer_pct = 0.50 %}
                  {% set min_buffer_pct = 0.05 %}

                  {# --- Ber√§kning av extra kWh vid superbilligt --- #}
                  {% if soc < 80 %}
                  {% set buffer_pct = min_buffer_pct + (max_buffer_pct - min_buffer_pct) * (1 - soc/80) %}
                  {% set buffer_kwh = usable_capacity * buffer_pct %}
                  {% else %}
                  {% set buffer_kwh = 0 %}
                  {% endif %}

                  {# --- Returnera kWh att ladda vid superbilligt pris --- #}
                  {% if avg_price < price_limit_supercheap %}
                  {{ buffer_kwh | round(2) }}
                  {% else %}
                  0
                  {% endif %}
            price_limit_supercheap: >
                  {% set buffer = states('input_number.sem_price_limit_supercheap') | float(0) %}
                  {{ buffer | round(2) }}
            estimated_energy_sun_interval: >
              {% set raw_interval = state_attr('sensor.sem_battery_charge_energy_1a_2', 'sun_interval') %}
              {% if not raw_interval %}
                0
              {% else %}
                {% set t1 = raw_interval.split(' - ')[0] %}
                {% set t2 = raw_interval.split(' - ')[1] %}
                {% set start = as_datetime(t1).replace(minute=0, second=0, microsecond=0) %}
                {% set end   = as_datetime(t2).replace(minute=0, second=0, microsecond=0) %}
                {% if end <= start %}
                  {% set end = end + timedelta(days=1) %}
                {% endif %}

                {% set k_morning = states('sensor.sem_energy_avg_morning') | float(0) %}
                {% set k_day     = states('sensor.sem_energy_avg_day') | float(0) %}
                {% set k_evening = states('sensor.sem_energy_avg_evening') | float(0) %}
                {% set k_night   = states('sensor.sem_energy_avg_night') | float(0) %}

                {% set ns = namespace(total_kwh=0, current=start) %}
                {% set max_hours = 24 %}

                {% for i in range(max_hours) %}
                  {% if ns.current > end %}
                    {% break %}
                  {% endif %}
                  {% set hour = ns.current.hour %}
                  {% if 5 <= hour < 10 %}
                    {% set kwh = k_morning %}
                  {% elif 10 <= hour < 15 %}
                    {% set kwh = k_day %}
                  {% elif 15 <= hour < 21 %}
                    {% set kwh = k_evening %}
                  {% else %}
                    {% set kwh = k_night %}
                  {% endif %}
                  {% set ns.total_kwh = ns.total_kwh + kwh %}
                  {% set ns.current = ns.current + timedelta(hours=1) %}
                {% endfor %}

                {{ ns.total_kwh | round(2) }}
              {% endif %}

            estimated_solar_energy: >
                  {% set raw_start = states('sensor.sem_battery_charge_window_cheapest_1a') %}
                  {% set raw_end = states('sensor.sem_battery_charge_window_cheapest_2') %}
                  {% if ' - ' in raw_start and ' - ' in raw_end %}
                        {% set t1 = raw_start.split(' - ')[0] %}
                        {% set t2 = raw_end.split(' - ')[1] %}
                        {% set start = as_datetime(t1) %}
                        {% set end = as_datetime(t2) %}
                  {% else %}
                        {% set start = as_datetime('1970-01-01T00:00:00+00:00') %}
                        {% set end = as_datetime('1970-01-01T01:00:00+00:00') %}
                  {% endif %}
                  {% set forecast = state_attr('sensor.sem_solar_forecast', 'sem') %}
                  {% set solar_kwh = 0 %}
                  {% if forecast and 'watt_hours_period' in forecast %}
                        {% set start_ts = as_timestamp(start) %}
                        {% set end_ts = as_timestamp(end) %}
                        {% set today_date = start.date() %}
                        {% set entries = forecast['watt_hours_period']
                              | selectattr('date', 'defined')
                              | selectattr('date', '>=', start_ts | timestamp_local)
                              | selectattr('date', '<=', end_ts | timestamp_local)
                              | selectattr('date', 'match', '^' ~ today_date|string)
                              | list %}
                        {% set valid_entries = entries
                              | selectattr('values', 'defined')
                              | selectattr('values', '>', 0)
                              | list %}
                        {% if valid_entries | length > 0 %}
                              {% set solar_kwh = (valid_entries | map(attribute='values') | sum | default(0)) / 1000 * 0.9 %}
                        {% endif %}
                  {% endif %}
                  {{ solar_kwh | round(2) }}
            ev_charge_factor: >
                  {% if is_state('input_boolean.sem_ev_charged_today', 'on') %}
                    0.5
                  {% else %}
                    1.0
                  {% endif %}
            adjustment_factor_solar_energy: >
                  {% set forecast = state_attr('sensor.sem_weather_forecasts_hourly', 'forecast') %}
                  {% set interval_str = state_attr('sensor.sem_battery_charge_energy_1a_2','sun_interval') %}
                  {% if forecast and interval_str %}
                    {% set start_str = interval_str.split(' - ')[0] %}
                    {% set end_str   = interval_str.split(' - ')[1] %}
                    {% set future = forecast
                      | selectattr('datetime', 'defined')
                      | selectattr('datetime', '!=', None)
                      | selectattr('datetime', '>=', start_str)
                      | selectattr('datetime', '<=', end_str)
                      | list %}
              
                    {% if future | length > 0 %}
                      {% set avg_clouds = (future | map(attribute='cloud_coverage') | select('defined') | map('float') | list | average(0)) %}
                      {% set conditions = future | map(attribute='condition') | list %}
                     {% set cloud_factor = 1 - (avg_clouds / 100 * 0.7) %}
                
                      {% set rain = conditions | select('search', 'rain') | list | count %}
                      {% set snow = conditions | select('search', 'snow') | list | count %}
                    {% set cloudy = conditions | select('search', 'cloudy') | list | count %}
                      {% set partly = conditions | select('search', 'partlycloudy') | list | count %}
                
                      {% if rain > 0 %}
                        {% set weather_factor = 0.6 %}
                      {% elif snow > 0 %}
                        {% set weather_factor = 0.5 %}
                      {% elif partly > 0 %}
                        {% set weather_factor = 0.9 %}
                      {% elif cloudy > 0 %}
                        {% set weather_factor = 0.8 %}
                      {% else %}
                      {% set weather_factor = 1.0 %}
                      {% endif %}
                
                      {{ (cloud_factor * weather_factor) | round(2) }}
                    {% else %}
                      1
                    {% endif %}
                  {% else %}
                    1
                  {% endif %}
            estimated_energy_no_sun_interval: >
              {% set raw_interval = state_attr('sensor.sem_battery_charge_energy_1a_2', 'no_sun_interval') %}
              {% if not raw_interval %}
                0
              {% else %}
                {% set t1 = raw_interval.split(' - ')[0] %}
                {% set t2 = raw_interval.split(' - ')[1] %}
                {% set start = as_datetime(t1).replace(minute=0, second=0, microsecond=0) %}
                {% set end   = as_datetime(t2).replace(minute=0, second=0, microsecond=0) %}
                {% if end <= start %}
                  {% set end = end + timedelta(days=1) %}
                {% endif %}

                {% set k_morning = states('sensor.sem_energy_avg_morning') | float(0) %}
                {% set k_day     = states('sensor.sem_energy_avg_day') | float(0) %}
                {% set k_evening = states('sensor.sem_energy_avg_evening') | float(0) %}
                {% set k_night   = states('sensor.sem_energy_avg_night') | float(0) %}

                {% set ns = namespace(total_kwh=0, current=start) %}
                {% set max_hours = 24 %}

                {% for i in range(max_hours) %}
                  {% if ns.current > end %}
                    {% break %}
                  {% endif %}
                  {% set hour = ns.current.hour %}
                  {% if 5 <= hour < 10 %}
                    {% set kwh = k_morning %}
                  {% elif 10 <= hour < 15 %}
                    {% set kwh = k_day %}
                  {% elif 15 <= hour < 21 %}
                    {% set kwh = k_evening %}
                  {% else %}
                    {% set kwh = k_night %}
                  {% endif %}
                  {% set ns.total_kwh = ns.total_kwh + kwh %}
                  {% set ns.current = ns.current + timedelta(hours=1) %}
                {% endfor %}

                {{ ns.total_kwh | round(2) }}
              {% endif %}
            profit: >
              {% set raw = states('sensor.sem_nordpool_active') %}
              {% if raw in ['unknown','unavailable','none'] %}
                -1
              {% else %}
                {% set win_str = states('sensor.sem_battery_charge_window_cheapest_1a') %}
                {% set next_win_str = states('sensor.sem_battery_charge_window_cheapest_2') %}

                {% if win_str in ['none','unknown',''] or next_win_str in ['none','unknown',''] %}
                  -1
                {% else %}
                  {% set win_start_str, win_end_str = win_str.split(' - ') %}
                  {% set next_start_str, next_end_str = next_win_str.split(' - ') %}

                  {% set end_1 = as_datetime(win_end_str) %}
                  {% set start_2 = as_datetime(next_start_str) %}

                  {% set diff_hours = (start_2 - end_1).total_seconds() / 3600 %}

                  {% set extended_end = end_1.replace(hour=22, minute=0, second=0, microsecond=0) %}

                  {% if diff_hours < 3 %}
                    {% if extended_end < end_1 %}
                      {% set extended_end = extended_end + timedelta(days=1) %}
                    {% endif %}
                    {% set final_end = extended_end %}
                  {% else %}
                    {% set final_end = start_2 %}
                  {% endif %}

                  {% set final_end_str = final_end.isoformat() %}

                  {% set prices_today = state_attr('sensor.sem_nordpool_active','raw_today') or [] %}
                  {% set prices_tomorrow = state_attr('sensor.sem_nordpool_active','raw_tomorrow') or [] %}
                  {% set all_prices = prices_today + prices_tomorrow %}

                  {% set in_window = all_prices
                    | selectattr('start','>=', win_start_str)
                    | selectattr('end','<=', win_end_str)
                    | map(attribute='value')
                    | list
                  %}

                  {% if in_window | length == 0 %}
                    -1
                  {% else %}
                    {% set avg_window = (in_window | sum) / (in_window | length) %}

                    {% set after_window = all_prices
                      | selectattr('start','>=', win_end_str)
                      | selectattr('start','<=', final_end_str)
                      | map(attribute='value')
                      | list
                    %}

                    {% if after_window | length == 0 %}
                      -1
                    {% else %}
                      {% set max_after = after_window | max %}
                      {{ (max_after - avg_window) | round(3) }}
                    {% endif %}
                  {% endif %}
                {% endif %}
              {% endif %}




            avg_window: >
              {% set win_str = states('sensor.sem_battery_charge_window_cheapest_1a') %}
              {% if win_str in ['none','unknown',''] %}
                none
              {% else %}
                {% set win_start_str, win_end_str = win_str.split(' - ') %}

                {% set prices_today = state_attr('sensor.sem_nordpool_active','raw_today') or [] %}
                {% set prices_tomorrow = state_attr('sensor.sem_nordpool_active','raw_tomorrow') or [] %}
                {% set all_prices = prices_today + prices_tomorrow %}

                {% set in_window = all_prices
                  | selectattr('start','>=', win_start_str)
                  | selectattr('end','<=', win_end_str)
                  | map(attribute='value')
                  | list %}

                {% if in_window | length > 0 %}
                  {{ ((in_window | sum) / (in_window | length)) }}
                {% else %}
                  none
                {% endif %}
              {% endif %}

            max_after_window: >
              {% set raw = states('sensor.sem_nordpool_active') %}
              {% if raw in ['unknown','unavailable','none'] %}
                none
              {% else %}
                {% set win_str = states('sensor.sem_battery_charge_window_cheapest_1a') %}
                {% set next_win_str = states('sensor.sem_battery_charge_window_cheapest_2') %}

                {% if win_str in ['none','unknown',''] or next_win_str in ['none','unknown',''] %} 
                  none
                {% else %}
                  {% set win_start_str, win_end_str = win_str.split(' - ') %}
                  {% set next_start_str, next_end_str = next_win_str.split(' - ') %}

                  {% set end_1 = as_datetime(win_end_str) %}
                  {% set start_2 = as_datetime(next_start_str) %}

                  {% set diff_hours = (start_2 - end_1).total_seconds() / 3600 %}

                  {% set extended_end = end_1.replace(hour=22, minute=0, second=0, microsecond=0) %}

                  {% if diff_hours < 3 %}
                    {% if extended_end < end_1 %}
                      {% set extended_end = extended_end + timedelta(days=1) %}
                    {% endif %}
                    {% set final_end = extended_end %}
                  {% else %}
                    {% set final_end = start_2 %}
                  {% endif %}

                  {% set final_end_str = final_end.isoformat() %}

                  {% set prices_today = state_attr('sensor.sem_nordpool_active','raw_today') or [] %}
                  {% set prices_tomorrow = state_attr('sensor.sem_nordpool_active','raw_tomorrow') or [] %}
                  {% set all_prices = prices_today + prices_tomorrow %}

                  {% set interval_prices = all_prices
                    | selectattr('start','>=', win_end_str)
                    | selectattr('start','<=', final_end_str)
                    | map(attribute='value')
                    | list
                  %}

                  {% if interval_prices | length > 0 %}
                    {{ interval_prices | max }}
                  {% else %}
                    none
                  {% endif %}
                {% endif %}
              {% endif %}




            should_charge: >
              {% set profit = state_attr('sensor.sem_battery_charge_energy_1a_2', 'profit') | float(-1) %}
              {% set profit_threshold = states('input_number.sem_charge_profit_threshold') | float(0.20) %}

              {% set avg_price = state_attr('sensor.sem_battery_charge_energy_1a_2', 'avg_window') | float(999) %}
              {% set supercheap = states('input_number.sem_price_limit_supercheap') | float(0.20) %}

              {{ profit >= profit_threshold or avg_price <= supercheap }}

#              {% set diff = state_attr('sensor.sem_battery_charge_energy_1a_2', 'profit') | float(-1) %}
#              {% set threshold = states('input_number.sem_charge_profit_threshold') | float(0.20) %}
#              {{ diff >= threshold }}



# CALCULATES ENERGY BETWEEN 2 AND 1B
      - name: "sem_battery_charge_energy_2_1b"
        unique_id: sem_battery_charge_energy_2_1b
        unit_of_measurement: "kWh"
        state: >
            {% set battery_capacity = state_attr('sensor.sem_battery_charge_energy_2_1b','battery_capacity') | float(0) %} 
            {% set usable_capacity = state_attr('sensor.sem_battery_charge_energy_2_1b','usable_capacity ') | float(0) %} 
            {% set weather_buffer = state_attr('sensor.sem_battery_charge_energy_2_1b','weather_buffer ') | float(0) %} 
            {% set estimated_energy_sun_interval = state_attr('sensor.sem_battery_charge_energy_2_1b','estimated_energy_sun_interval') | float(0) %} 
            {% set estimated_solar_energy = state_attr('sensor.sem_battery_charge_energy_2_1b','estimated_solar_energy') | float(0) %} 
            {% set estimated_energy_no_sun_interval = state_attr('sensor.sem_battery_charge_energy_2_1b','estimated_energy_no_sun_interval') | float(0) %} 
            {% set avg_price_charge_window = state_attr('sensor.sem_battery_charge_energy_2_1b','avg_price') | float(0) %} 
            {% set price_limit_supercheap = states('input_number.sem_price_limit_supercheap') | float(0) %} 
            {% set supercheap_charge = state_attr('sensor.sem_battery_charge_energy_2_1b','supercheap_charge') | float(0) %}
            {% set extra = states('input_number.extra_2') | float(0) %} 
            {% set adjustment_factor_solar_energy = state_attr('sensor.sem_battery_charge_energy_2_1b','adjustment_factor_solar_energy') | float(0) %}
            {% set battery_max = states('input_number.sem_battery_total_capacity_kwh') | float(0) %}

            {% set solar_diff = [estimated_energy_sun_interval - (estimated_solar_energy * adjustment_factor_solar_energy) , 0] | max %}
            {% set raw_total = (estimated_energy_no_sun_interval + solar_diff + weather_buffer) - battery_capacity %}
            {% set total_energy_need = [raw_total, 0] | max %}


            {{ (total_energy_need + supercheap_charge + extra, battery_max) | min  }}
#            {{ (total_energy_need + supercheap_charge + extra) | round(2) }}
        attributes:
            search_interval: >
                  {% set raw_start = states('sensor.sem_battery_charge_window_cheapest_2') %}
                  {% set raw_end = states('sensor.sem_battery_charge_window_cheapest_1a') %}
                  {% if ' - ' in raw_start and ' - ' in raw_end %}
                        {% set t1 = raw_start.split(' - ')[0] %}
                        {% set t2 = raw_end.split(' - ')[0] %}
                        {% set start = as_datetime(t1) %}
                        {% set end = as_datetime(t2) %}
                  {% else %}
                        {% set start = as_datetime('1970-01-01T00:00:00+00:00') %}
                        {% set end = as_datetime('1970-01-01T01:00:00+00:00') %}
                  {% endif %}
                  {{ start.isoformat() }} - {{ end.isoformat() }}
            sun_interval: >
                  {% set raw_start = states('sensor.sem_battery_charge_window_cheapest_2') %}
                  {% set raw_end = states('sensor.sem_battery_charge_window_cheapest_1a') %}

                  {% if ' - ' in raw_start and ' - ' in raw_end %}
                        {% set t1 = raw_start.split(' - ')[0] %}
                        {% set t2 = raw_end.split(' - ')[0] %}
                        {% set start = as_datetime(t1) %}
                        {% set end = as_datetime(t2) %}
                  {% else %}
                        {% set start = as_datetime('1970-01-01T00:00:00+00:00') %}
                        {% set end = as_datetime('1970-01-01T01:00:00+00:00') %}
                  {% endif %}

                  {% set forecast = state_attr('sensor.sem_solar_forecast', 'sem') %}
                  {% set solar_interval_start = none %}
                  {% set solar_interval_end = none %}

                  {% if forecast and 'watt_hours_period' in forecast %}
                        {% set start_ts = as_timestamp(start) %}
                        {% set end_ts = as_timestamp(end) %}
                        {% set today_date = start.date() %}
                        {% set entries = forecast['watt_hours_period']
                          | selectattr('date', 'defined')
                          | selectattr('date', '>=', start_ts | timestamp_local)
                          | selectattr('date', '<=', end_ts | timestamp_local)
                          | selectattr('date', 'match', '^' ~ today_date|string)
                          | list %}
                        {% set valid_entries = entries
                          | selectattr('values', 'defined')
                          | selectattr('values', '>', 0)
                          | list %}

                        {% if valid_entries | length > 0 %}
                              {% set solar_interval_start = (valid_entries[0].date | as_datetime).replace(minute=0, second=0, microsecond=0) %}
                              {% set solar_interval_end = (valid_entries[-1].date | as_datetime).replace(minute=0, second=0, microsecond=0) %}
                        {% endif %}
                  {% endif %}

                  {% if solar_interval_start and solar_interval_end %}
                        {{ solar_interval_start.isoformat() }} - {{ solar_interval_end.isoformat() }}
                  {% else %}
                        {{ '1970-01-01T00:00:00+00:00 - 1970-01-01T00:00:00+00:00' }}
                  {% endif %}
            no_sun_interval: >
                  {% set t1 = states('sensor.sem_battery_charge_window_cheapest_2').split(' - ')[0] %}
                  {% set start = as_datetime(t1) %}
                  {% set forecast = state_attr('sensor.sem_solar_forecast', 'sem') %}
                  {% set solar_interval_start = none %}
                  {% if forecast and 'watt_hours_period' in forecast %}
                                {% set start_ts = as_timestamp(start) %}
                                {% set entries = forecast['watt_hours_period']
                                      | selectattr('date', 'defined')
                                      | selectattr('date', '>=', start_ts | timestamp_local)
                                      | list %}
                                {% set valid_entries = entries
                                      | selectattr('values', 'defined')
                                      | selectattr('values', '>', 0)
                                      | list %}
                                {% if valid_entries | length > 0 %}
                                      {% set solar_interval_start = (valid_entries[0].date | as_datetime).replace(minute=0, second=0, microsecond=0) %}
                                {% endif %}
                  {% endif %}
                  {% if solar_interval_start %}
                                {{ start.isoformat() }} - {{ solar_interval_start.isoformat() }}
                  {% else %}
                                1970-01-01T00:00:00+00:00 - 1970-01-01T00:00:00+00:00
                  {% endif %}
            battery_capacity: >
                  {# Visar aktuell laddning i kWh min SoC (dvs det som faktiskt √§r anv√§ndbart) #}
                  {% set capacity = states('input_number.sem_battery_total_capacity_kwh') | float(0) %}
                  {% set soc = states('sensor.batteries_state_of_capacity') | float(0) %}
                  {% set min_soc = states('number.batteries_end_of_discharge_soc') | float(0) %}
                  {% set denom = (100 - min_soc) %}
                  {% if denom <= 0 %}
                        {{ 0.0 }}
                  {% else %}
                        {% set usable_capacity = capacity * ((100 - min_soc) / 100) %}
                        {% set soc_clamped = soc %}
                        {% if soc_clamped < min_soc %}
                              {% set soc_clamped = min_soc %}
                        {% endif %}
                        {% if soc_clamped > 100 %}
                              {% set soc_clamped = 100 %}
                        {% endif %}
                        {% set current_kwh = usable_capacity * ((soc_clamped - min_soc) / denom) %}
                        {{ current_kwh | round(2) }}
                  {% endif %}
            usable_capacity: >
                  {# Total anv√§ndbar kapacitet (kWh) givet min SoC #}
                  {% set capacity = states('input_number.sem_battery_total_capacity_kwh') | float(0) %}
                  {% set min_soc = states('number.batteries_end_of_discharge_soc') | float(0) %}
                  {% set denom = (100 - min_soc) %}
                  {% if denom <= 0 %}
                        {{ 0.0 }}
                  {% else %}
                        {{ (capacity * ((100 - min_soc) / 100)) | round(2) }}
                  {% endif %}
            weather_buffer: >
                  {# --- H√§mta temperaturer med fallback --- #}
                  {% set temp_today = states('sensor.sem_temp_low') | float(0) %}
                  {% set temp_yesterday = state_attr('sensor.sem_temp_low','yesterday') | float(temp_today) %}
                  {% set temp_day_before = state_attr('sensor.sem_temp_low','day_before') | float(temp_yesterday) %}
                  {% set temp_three_days_ago = state_attr('sensor.sem_temp_low','three_days_ago') | float(temp_day_before) %}

                  {# --- StartkWh  --- #}
                  {% if temp_today < 5 %}
                      {% set start_kwh = 4 %}
                  {% elif temp_today < 10 %}
                      {% set start_kwh = 2 %}
                  {% elif temp_today < 12 %}
                      {% set start_kwh = 1 %}
                  {% else %}
                      {% set start_kwh = 0 %}
                  {% endif %}

                  {# --- Extra kWh --- #}
                  {% set diff_yesterday = temp_yesterday - temp_today %}
                  {% set diff_day_before = temp_day_before - temp_today %}
                  {% set diff_three_days_ago = temp_three_days_ago - temp_today %}
                  {% set extra_kwh = 0 %}
                  {% if diff_yesterday > 2 %}{% set extra_kwh = extra_kwh + diff_yesterday %}{% endif %}
                  {% if diff_day_before > 2 %}{% set extra_kwh = extra_kwh + (diff_day_before / 2) %}{% endif %}
                  {% if diff_three_days_ago > 2 %}{% set extra_kwh = extra_kwh + (diff_three_days_ago / 3) %}{% endif %}

                  {# --- Stabilisering --- #}
                  {% set stable =
                      ((temp_today - temp_yesterday) | abs <= 1) and
                      ((temp_today - temp_day_before) | abs <= 1) and
                      ((temp_today - temp_three_days_ago) | abs <= 1)
                  %}
                  {% if stable %}
                      {% set start_kwh = start_kwh * 0.5 %}
                      {% set extra_kwh = extra_kwh * 0.5 %}
                  {% endif %}

                  {# --- Total kWh som attribut --- #}
                  {
                      {{ (start_kwh + extra_kwh) | round(1) }}
                  }
            extra: >
                  {% set extra = states('input_number.extra_2') | float(0) %}
                  {{ extra | round(2) }}
            supercheap_charge: >
                  {# --- Ber√§kna medelpris f√∂r laddningsintervallet (kvartpris) --- #}
                  {% set interval_raw = states('sensor.sem_battery_charge_window_cheapest_2') %}
                  {% set avg_price = 99 %}
                  {% if interval_raw and ' - ' in interval_raw %}
                  {% set start_dt = as_datetime(interval_raw.split(' - ')[0]) %}
                  {% set end_dt = as_datetime(interval_raw.split(' - ')[1]) %}
                  {% set raw_today = state_attr('sensor.sem_nordpool_sensor_id','raw_today') or [] %}
                  {% set raw_tomorrow = state_attr('sensor.sem_nordpool_sensor_id','raw_tomorrow') or [] %}
                  {% set tomorrow_valid = state_attr('sensor.sem_nordpool_sensor_id','tomorrow_valid') == true %}
                  {% set ns = namespace(total=0.0, count=0) %}

                  {% set quarters = ((end_dt - start_dt).total_seconds() // 900) | int %}

                  {% for i in range(quarters) %}
                  {% set t = start_dt + timedelta(minutes=i*15) %}
                  {% set index = t.hour*4 + (t.minute // 15) %}
                  {% if t.date() == now().date() %}
                  {% set p = raw_today[index].value if raw_today|length > index else None %}
                  {% elif tomorrow_valid and t.date() == (now().date() + timedelta(days=1)) %}
                  {% set p = raw_tomorrow[index].value if raw_tomorrow|length > index else None %}
                  {% else %}
                  {% set p = None %}
                  {% endif %}
                  {% if p is not none %}
                  {% set ns.total = ns.total + (p|string|replace(',','.')|float(0)) %}
                  {% set ns.count = ns.count + 1 %}
                  {% endif %}
                  {% endfor %}

                  {% if ns.count > 0 %}
                  {% set avg_price = ns.total / ns.count %}
                  {% endif %}
                  {% endif %}

                  {# --- V√§rden f√∂r ber√§kningen --- #}
                  {% set price_limit_supercheap = states('input_number.sem_price_limit_supercheap') | float(0) %}
                  {% set battery_capacity = state_attr('sensor.sem_battery_charge_energy_2_1b','battery_capacity') | float(0) %}
                  {% set usable_capacity = state_attr('sensor.sem_battery_charge_energy_2_1b','usable_capacity') | float(0) %}
                  {% set soc = states('sensor.batteries_state_of_capacity') | float(0) %}
                  {% set max_buffer_pct = 0.50 %}
                  {% set min_buffer_pct = 0.05 %}

                  {# --- Ber√§kning av extra kWh vid superbilligt --- #}
                  {% if soc < 80 %}
                  {% set buffer_pct = min_buffer_pct + (max_buffer_pct - min_buffer_pct) * (1 - soc/80) %}
                  {% set buffer_kwh = usable_capacity * buffer_pct %}
                  {% else %}
                  {% set buffer_kwh = 0 %}
                  {% endif %}

                  {# --- Returnera kWh att ladda vid superbilligt pris --- #}
                  {% if avg_price < price_limit_supercheap %}
                  {{ buffer_kwh | round(2) }}
                  {% else %}
                  0
                  {% endif %}
            price_limit_supercheap: >
                  {% set buffer = states('input_number.sem_price_limit_supercheap') | float(0) %}
                  {{ buffer | round(2) }}
            estimated_energy_sun_interval: >
              {% set raw_interval = state_attr('sensor.sem_battery_charge_energy_2_1b', 'sun_interval') %}
              {% if not raw_interval %}
                0
              {% else %}
                {% set t1 = raw_interval.split(' - ')[0] %}
                {% set t2 = raw_interval.split(' - ')[1] %}
                {% set start = as_datetime(t1).replace(minute=0, second=0, microsecond=0) %}
                {% set end   = as_datetime(t2).replace(minute=0, second=0, microsecond=0) %}
                {% if end <= start %}
                  {% set end = end + timedelta(days=1) %}
                {% endif %}

                {% set k_morning = states('sensor.sem_energy_avg_morning') | float(0) %}
                {% set k_day     = states('sensor.sem_energy_avg_day') | float(0) %}
                {% set k_evening = states('sensor.sem_energy_avg_evening') | float(0) %}
                {% set k_night   = states('sensor.sem_energy_avg_night') | float(0) %}

                {% set ns = namespace(total_kwh=0, current=start) %}
                {% set max_hours = 24 %}

                {% for i in range(max_hours) %}
                  {% if ns.current > end %}
                    {% break %}
                  {% endif %}
                  {% set hour = ns.current.hour %}
                  {% if 5 <= hour < 10 %}
                    {% set kwh = k_morning %}
                  {% elif 10 <= hour < 15 %}
                    {% set kwh = k_day %}
                  {% elif 15 <= hour < 21 %}
                    {% set kwh = k_evening %}
                  {% else %}
                    {% set kwh = k_night %}
                  {% endif %}
                  {% set ns.total_kwh = ns.total_kwh + kwh %}
                  {% set ns.current = ns.current + timedelta(hours=1) %}
                {% endfor %}

                {{ ns.total_kwh | round(2) }}
              {% endif %}
            estimated_solar_energy: >
                  {% set forecast = state_attr('sensor.sem_solar_forecast', 'sem') %}
                  {% set t1 = states('sensor.sem_battery_charge_window_cheapest_2').split(' - ')[0] %}
                  {% set t2 = states('sensor.sem_battery_charge_window_cheapest_1a').split(' - ')[0] %}
                  {% set start = as_datetime(t1) %}
                  {% set end = as_datetime(t2) %}
                  {% set solar_kwh = 0 %}
                  {% if forecast and 'watt_hours_period' in forecast %}
                                {% set start_ts = as_timestamp(start) %}
                                {% set end_ts = as_timestamp(end) %}
                                {% set entries = forecast['watt_hours_period']
                                      | selectattr('date', 'defined')
                                      | selectattr('date', '>=', start_ts | timestamp_local)
                                      | selectattr('date', '<=', end_ts | timestamp_local)
                                      | list %}
                                {% set valid_entries = entries
                                      | selectattr('values', 'defined')
                                      | selectattr('values', '>', 0)
                                      | list %}
                                {% if valid_entries | length > 0 %}
                                          {% set solar_kwh = (valid_entries | map(attribute='values') | sum | default(0)) / 1000 * 0.9 %}
                                {% endif %}
                  {% endif %}
                  {{ solar_kwh | round(2) }}
            adjustment_factor_solar_energy: >
                  {% set forecast = state_attr('sensor.sem_weather_forecasts_hourly', 'forecast') %}
                  {% set interval_str = state_attr('sensor.sem_battery_charge_energy_2_1b','sun_interval') %}
                  {% if forecast and interval_str %}
                    {% set start_str = interval_str.split(' - ')[0] %}
                    {% set end_str   = interval_str.split(' - ')[1] %}
                    {% set future = forecast
                      | selectattr('datetime', 'defined')
                      | selectattr('datetime', '!=', None)
                      | selectattr('datetime', '>=', start_str)
                      | selectattr('datetime', '<=', end_str)
                      | list %}
              
                    {% if future | length > 0 %}
                      {% set avg_clouds = (future | map(attribute='cloud_coverage') | select('defined') | map('float') | list | average(0)) %}
                      {% set conditions = future | map(attribute='condition') | list %}
                      {% set cloud_factor = 1 - (avg_clouds / 100 * 0.7) %}
                
                      {% set rain = conditions | select('search', 'rain') | list | count %}
                      {% set snow = conditions | select('search', 'snow') | list | count %}
                      {% set cloudy = conditions | select('search', 'cloudy') | list | count %}
                      {% set partly = conditions | select('search', 'partlycloudy') | list | count %}
                
                      {% if rain > 0 %}
                        {% set weather_factor = 0.6 %}
                      {% elif snow > 0 %}
                        {% set weather_factor = 0.5 %}
                      {% elif partly > 0 %}
                        {% set weather_factor = 0.9 %}
                      {% elif cloudy > 0 %}
                        {% set weather_factor = 0.8 %}
                      {% else %}
                        {% set weather_factor = 1.0 %}
                      {% endif %}
                
                      {{ (cloud_factor * weather_factor) | round(2) }}
                    {% else %}
                      1
                    {% endif %}
                  {% else %}
                    1
                  {% endif %}
            estimated_energy_no_sun_interval: >
              {% set raw_interval = state_attr('sensor.sem_battery_charge_energy_2_1b', 'no_sun_interval') %}
              {% if not raw_interval %}
                0
              {% else %}
                {% set t1 = raw_interval.split(' - ')[0] %}
                {% set t2 = raw_interval.split(' - ')[1] %}
                {% set start = as_datetime(t1).replace(minute=0, second=0, microsecond=0) %}
                {% set end   = as_datetime(t2).replace(minute=0, second=0, microsecond=0) %}
                {% if end <= start %}
                  {% set end = end + timedelta(days=1) %}
                {% endif %}

                {% set k_morning = states('sensor.sem_energy_avg_morning') | float(0) %}
                {% set k_day     = states('sensor.sem_energy_avg_day') | float(0) %}
                {% set k_evening = states('sensor.sem_energy_avg_evening') | float(0) %}
                {% set k_night   = states('sensor.sem_energy_avg_night') | float(0) %}

                {% set ns = namespace(total_kwh=0, current=start) %}
                {% set max_hours = 24 %}

                {% for i in range(max_hours) %}
                  {% if ns.current > end %}
                    {% break %}
                  {% endif %}
                  {% set hour = ns.current.hour %}
                  {% if 5 <= hour < 10 %}
                    {% set kwh = k_morning %}
                  {% elif 10 <= hour < 15 %}
                    {% set kwh = k_day %}
                  {% elif 15 <= hour < 21 %}
                    {% set kwh = k_evening %}
                  {% else %}
                    {% set kwh = k_night %}
                  {% endif %}
                  {% set ns.total_kwh = ns.total_kwh + kwh %}
                  {% set ns.current = ns.current + timedelta(hours=1) %}
                {% endfor %}

                {{ ns.total_kwh | round(2) }}
              {% endif %}
            profit: >
              {% set raw = states('sensor.sem_nordpool_active') %}
              {% if raw in ['unknown','unavailable','none'] %}
                -1
              {% else %}
                {% set win2_str = states('sensor.sem_battery_charge_window_cheapest_2') %}
                {% set win1_str = states('sensor.sem_battery_charge_window_cheapest_1a') %}

                {% if win2_str in ['none','unknown',''] or win1_str in ['none','unknown',''] %}
                  -1
                {% else %}

                  {# --- Dela intervallen --- #}
                  {% set w2_start_str, w2_end_str = win2_str.split(' - ') %}
                  {% set w1_start_str, w1_end_str = win1_str.split(' - ') %}

                  {% set w2_end = as_datetime(w2_end_str) %}
                  {% set w1_start = as_datetime(w1_start_str) %}

                  {# --- H√§mta priser --- #}
                  {% set prices_today = state_attr('sensor.sem_nordpool_active','raw_today') or [] %}
                  {% set prices_tomorrow = state_attr('sensor.sem_nordpool_active','raw_tomorrow') or [] %}
                  {% set all_prices = prices_today + prices_tomorrow %}

                  {# --- Genomsnitt under laddf√∂nster cheapest_2 --- #}
                  {% set in_window = all_prices
                    | selectattr('start','>=', w2_start_str)
                    | selectattr('end','<=', w2_end_str)
                    | map(attribute='value')
                    | list
                  %}

                  {% if in_window | length == 0 %}
                    -1
                  {% else %}
                    {% set avg_window = (in_window | sum) / (in_window | length) %}

                    {# --- R√§kna hur l√•ngt det √§r till n√§sta f√∂nster --- #}
                    {% set gap_hours = (w1_start - w2_end).total_seconds() / 3600 %}
                    {% set min_gap = 3 %}

                    {# --- V√§lj prim√§rt intervall eller fallback --- #}
                    {% if gap_hours >= min_gap %}
                      {% set search_end = w1_start.isoformat() %}
                    {% else %}
                      {% set tmp_0500 = w2_end.replace(hour=5, minute=0, second=0) %}
                      {% if tmp_0500 <= w2_end %}
                        {% set search_end_dt = tmp_0500 + timedelta(days=1) %}
                      {% else %}
                        {% set search_end_dt = tmp_0500 %}
                      {% endif %}
                      {% set search_end = search_end_dt.isoformat() %}
                    {% endif %}

                    {# --- Priser i s√∂kintervallet --- #}
                    {% set after_window = all_prices
                      | selectattr('start','>=', w2_end_str)
                      | selectattr('start','<=', search_end)
                      | map(attribute='value')
                      | list
                    %}

                    {% if after_window | length == 0 %}
                      -1
                    {% else %}
                      {% set max_after = after_window | max %}
                      {{ (max_after - avg_window) | round(3) }}
                    {% endif %}
                  {% endif %}
                {% endif %}
              {% endif %}



            avg_window: >
              {% set win_str = states('sensor.sem_battery_charge_window_cheapest_2') %}
              {% if win_str in ['none','unknown',''] %}
                none
              {% else %}
                {% set win_start_str, win_end_str = win_str.split(' - ') %}

                {% set prices_today = state_attr('sensor.sem_nordpool_active','raw_today') or [] %}
                {% set prices_tomorrow = state_attr('sensor.sem_nordpool_active','raw_tomorrow') or [] %}
                {% set all_prices = prices_today + prices_tomorrow %}

                {% set in_window = all_prices
                  | selectattr('start','>=', win_start_str)
                  | selectattr('end','<=', win_end_str)
                  | map(attribute='value')
                  | list %}

                {% if in_window | length > 0 %}
                  {{ ((in_window | sum) / (in_window | length)) }}
                {% else %}
                  none
                {% endif %}
              {% endif %}

            max_after_window: >
              {% set raw = states('sensor.sem_nordpool_active') %}
              {% if raw in ['unknown','unavailable','none'] %}
                none
              {% else %}

                {% set win2 = states('sensor.sem_battery_charge_window_cheapest_2') %}
                {% set win1 = states('sensor.sem_battery_charge_window_cheapest_1a') %}

                {% if win2 in ['none','unknown',''] or win1 in ['none','unknown',''] %}
                  none
                {% else %}

                  {# --- Delar b√•da f√∂nstren --- #}
                  {% set w2_start_str, w2_end_str = win2.split(' - ') %}
                  {% set w1_start_str, w1_end_str = win1.split(' - ') %}

                  {% set w2_end = as_datetime(w2_end_str) %}
                  {% set w1_start = as_datetime(w1_start_str) %}

                  {# --- Prim√§rt intervall: fr√•n slutet av 2 ‚Üí b√∂rjan av 1 --- #}
                  {% set gap_hours = (w1_start - w2_end).total_seconds() / 3600 %}

                  {# --- Max-priser vi ska anv√§nda data fr√•n --- #}
                  {% set prices_today = state_attr('sensor.sem_nordpool_active','raw_today') or [] %}
                  {% set prices_tomorrow = state_attr('sensor.sem_nordpool_active','raw_tomorrow') or [] %}
                  {% set all_prices = prices_today + prices_tomorrow %}

                  {# --- Logik: om gapet √§r stort nog, anv√§nd det. Annars ‚Üí 05:00 fallback --- #}
                  {% set min_gap = 3 %}   

                  {% if gap_hours >= min_gap %}
                    {# --- BRA gap ‚Üí anv√§nd w1_start --- #}
                    {% set search_end = w1_start.isoformat() %}
                  {% else %}
                    {# --- F√ñR LITET gap ‚Üí anv√§nd n√§sta 05:00 --- #}
                    {% set candidate_0500 = w2_end.replace(hour=5, minute=0, second=0) %}
                    {% if candidate_0500 <= w2_end %}
                      {% set search_end_dt = candidate_0500 + timedelta(days=1) %}
                    {% else %}
                      {% set search_end_dt = candidate_0500 %}
                    {% endif %}
                    {% set search_end = search_end_dt.isoformat() %}
                  {% endif %}

                  {# --- H√§mta priser inom valt intervall --- #}
                  {% set prices_after = all_prices
                    | selectattr('start','>=', w2_end_str)
                    | selectattr('start','<=', search_end)
                    | map(attribute='value')
                    | list
                  %}

                  {% if prices_after | length > 0 %}
                    {{ prices_after | max }}
                  {% else %}
                    none
                  {% endif %}

                {% endif %}
              {% endif %}


            should_charge: >
              {% set profit = state_attr('sensor.sem_battery_charge_energy_2_1b', 'profit') | float(-1) %}
              {% set profit_threshold = states('input_number.sem_charge_profit_threshold') | float(0.20) %}

              {% set avg_price = state_attr('sensor.sem_battery_charge_energy_2_1b', 'avg_window') | float(999) %}
              {% set supercheap = states('input_number.sem_price_limit_supercheap') | float(0.20) %}

              {{ profit >= profit_threshold or avg_price <= supercheap }}

#              {% set diff = state_attr('sensor.sem_battery_charge_energy_2_1b', 'profit') | float(-1) %}
#              {% set threshold = states('input_number.sem_charge_profit_threshold') | float(0.20) %}
#              {{ diff >= threshold }}


######################### TRIGGERS ########################################### 
# SEARCH CHEAP INTEVALL - USE WHEN BATTERY SHOULD BE IN IDLE 6-18
  - trigger:
#      - trigger: state
#        entity_id: binary_sensor.sem_nordpool_tomorrow_prices_available
#        to: 'on'
      - trigger: time
        at: '05:45:00'
    sensor:
      - name: "sem_battery_cheap_interval_2_1a"
        unique_id: sem_battery_cheap_interval_2_1a
        state: >
          {% set threshold = states('input_number.sem_low_price_threshold') | float %}
          {% set all_prices = (state_attr('sensor.sem_nordpool_active', 'raw_today') or []) + (state_attr('sensor.sem_nordpool_active', 'raw_tomorrow') or []) %}

          {% set now_dt = now() %}
          {% set start_ts = as_timestamp(now_dt.replace(hour=6, minute=0, second=0, microsecond=0)) %}
          {% set end_ts = as_timestamp(now_dt.replace(hour=18, minute=0, second=0, microsecond=0)) %}

          {% set ns = namespace(current_start=None, current_end=None, best_start=None, best_end=None) %}

          {% for entry in all_prices %}
            {% if entry.start is defined and entry.value is defined %}
              {% set entry_ts = as_timestamp(as_datetime(entry.start)) %}
              {% if entry_ts >= start_ts and entry_ts <= end_ts %}
      
                {% if entry.value | float <= threshold %}
                  {% if ns.current_start is none %}
                    {% set ns.current_start = as_datetime(entry.start) %}
                  {% endif %}
                  {% set ns.current_end = as_datetime(entry.end) %}
                {% else %}
                  {% if ns.current_start is not none %}
                    {# Spara intervall om det √§r l√§ngre √§n det tidigare #}
                    {% if ns.best_start is none or (ns.current_end - ns.current_start).total_seconds() > (ns.best_end - ns.best_start).total_seconds() %}
                      {% set ns.best_start = ns.current_start %}
                      {% set ns.best_end = ns.current_end %}
                    {% endif %}
                    {% set ns.current_start = none %}
                    {% set ns.current_end = none %}
                  {% endif %}
                {% endif %}
      
              {% endif %}
            {% endif %}
          {% endfor %}

          {# Spara sista intervallet om det √§r det l√§ngsta #}
          {% if ns.current_start is not none %}
            {% if ns.best_start is none or (ns.current_end - ns.current_start).total_seconds() > (ns.best_end - ns.best_start).total_seconds() %}
              {% set ns.best_start = ns.current_start %}
              {% set ns.best_end = ns.current_end %}
            {% endif %}
          {% endif %}

          {% if ns.best_start is not none and ns.best_end is not none %}
            {{ ns.best_start.isoformat() }} - {{ ns.best_end.isoformat() }}
          {% else %}
            1970-01-01T00:00:00 - 1970-01-01T01:00:00
          {% endif %}



# SEARCH CHEAP INTEVALL - USE WHEN BATTERY SHOULD BE IN IDLE 18-06
  - trigger:
#      - trigger: state
#        entity_id: binary_sensor.sem_nordpool_tomorrow_prices_available
#        to: 'on'
      - trigger: time
        at: '17:45:00'
      - trigger: time
        at: '11:45:00'
    sensor:
      - name: "sem_battery_cheap_interval_1a_2"
        unique_id: sem_battery_cheap_interval_1a_2
        state: >
          {% set threshold = states('input_number.sem_low_price_threshold') | float %}
          {% set all_prices = (state_attr('sensor.sem_nordpool_active', 'raw_today') or []) + (state_attr('sensor.sem_nordpool_active', 'raw_tomorrow') or []) %}

          {% set now_dt = now() %}
          {% set start_ts = as_timestamp(now_dt.replace(hour=18, minute=0, second=0, microsecond=0)) %}
          {% set end_ts = as_timestamp((now_dt + timedelta(days=1)).replace(hour=6, minute=0, second=0, microsecond=0)) %}

          {% set ns = namespace(current_start=None, current_prices=[], best_start=None, best_end=None) %}

          {% for entry in all_prices %}
              {% if entry.start is defined and entry.value is defined %}
                  {% set entry_ts = as_timestamp(as_datetime(entry.start)) %}
                  {% if start_ts <= entry_ts <= end_ts %}
                      {% if entry.value | float <= threshold %}
                          {% if ns.current_start is none %}
                              {% set ns.current_start = as_datetime(entry.start) %}
                          {% endif %}
                          {% set ns.current_prices = ns.current_prices + [entry.value | float] %}
                      {% else %}
                          {# Avsluta nuvarande sekvens #}
                          {% if ns.current_start is not none %}
                              {% set ns.best_start = ns.current_start %}
                              {% set ns.best_end = as_datetime(entry.start) %}
                              {% set ns.current_start = none %}
                              {% set ns.current_prices = [] %}
                          {% endif %}
                      {% endif %}
                  {% endif %}
              {% endif %}
          {% endfor %}

          {% if ns.current_start is not none %}
              {% set ns.best_start = ns.current_start %}
              {% set ns.best_end = as_datetime((now_dt + timedelta(days=1)).replace(hour=6, minute=0, second=0, microsecond=0)) %}
          {% endif %}

          {% if ns.best_start is not none and ns.best_end is not none %}
              {{ ns.best_start.isoformat() }} - {{ ns.best_end.isoformat() }}
          {% else %}
              1970-01-01T00:00:00 - 1970-01-01T01:00:00
          {% endif %}







# CALCULATES RELATIVE EXPENSIVE PRICE INTERVAL BETWEEN 14-02
  - trigger:
      - trigger: state
        entity_id: binary_sensor.sem_nordpool_tomorrow_prices_available
        to: 'on'
    sensor:
      - name: "sem_relative_expensive_price_1"
        unique_id: sem_relative_expensive_price_1
        state: >
          {% set data = (state_attr('sensor.sem_nordpool_active','raw_today') or []) +
                        (state_attr('sensor.sem_nordpool_active','raw_tomorrow') or []) %}
          {% set today = now().replace(hour=0, minute=0, second=0, microsecond=0) %}
          {% set interval_start = today + timedelta(hours=14) %}
          {% set interval_end   = today + timedelta(days=1, hours=2) %}
          {% set extend_hours = 5 %}

          {% set filtered = data
            | selectattr('start', 'defined')
            | selectattr('value', 'defined')
            | selectattr('start', '>=', interval_start.isoformat())
            | selectattr('start', '<', interval_end.isoformat())
            | list %}

          {% if filtered | length == 0 %}
            none
          {% else %}
            {% set values = filtered | map(attribute='value') | map('float') | list %}
            {% set max_value = values | max %}
            {% set peak_index = values.index(max_value) %}

            {# Hitta startindex bak√•t #}
            {% set start_index = peak_index %}
            {% for i in range(peak_index, -1, -1) %}
              {% if values[i] >= max_value %}
                {% set start_index = i %}
              {% else %}
                {% break %}
              {% endif %}
            {% endfor %}
            {% set start_index = [start_index - extend_hours, 0] | max %}

            {# Hitta slutindex fram√•t #}
            {% set end_index = peak_index %}
            {% for i in range(peak_index, (values | length)) %}
              {% if values[i] >= max_value %}
                {% set end_index = i %}
              {% else %}
                {% break %}
              {% endif %}
            {% endfor %}
            {% set end_index = [end_index + extend_hours, (filtered | length) - 1] | min %}

            {% set start_dt = as_datetime(filtered[start_index].start) %}
            {% set end_dt   = as_datetime(filtered[end_index].start) + timedelta(hours=1) %}
            {{ start_dt.isoformat() }} - {{ end_dt.isoformat() }}
          {% endif %}

        attributes:
          expensive_price: >
            {% set data = (state_attr('sensor.sem_nordpool_active','raw_today') or []) +
                          (state_attr('sensor.sem_nordpool_active','raw_tomorrow') or []) %}
            {% set today = now().replace(hour=0, minute=0, second=0, microsecond=0) %}
            {% set interval_start = today + timedelta(hours=14) %}
            {% set interval_end   = today + timedelta(days=1, hours=2) %}

            {% set filtered = data
              | selectattr('start', 'defined')
              | selectattr('value', 'defined')
              | selectattr('start', '>=', interval_start.isoformat())
              | selectattr('start', '<', interval_end.isoformat())
              | list %}

            {% if filtered | length == 0 %}
              none
            {% else %}
              {% set values = filtered | map(attribute='value') | map('float') | list %}
              {% set sorted_values = values | sort %}
              {% set idx = ((sorted_values | length) * 0.65) | round(0, 'floor') %}
              {{ sorted_values[idx] }}
            {% endif %}

          kwh_required: >
            {% set raw_interval = states('sensor.sem_relative_expensive_price_1') %}
            {% if ' - ' not in raw_interval %}
              0
            {% else %}
              {% set start = as_datetime(raw_interval.split(' - ')[0]) %}
              {% set end   = as_datetime(raw_interval.split(' - ')[1]) %}

              {# Avrunda start upp√•t till heltimme #}
              {% if start.minute > 0 or start.second > 0 %}
                {% set start = start.replace(minute=0, second=0, microsecond=0) + timedelta(hours=1) %}
              {% endif %}

              {# Avrunda slut ned√•t till heltimme #}
              {% set end = end.replace(minute=0, second=0, microsecond=0) %}
              {% if end <= start %}
                {% set end = end + timedelta(days=1) %}
              {% endif %}

              {% set k_morning = states('sensor.sem_energy_avg_morning') | float(0) %}
              {% set k_day     = states('sensor.sem_energy_avg_day') | float(0) %}
              {% set k_evening = states('sensor.sem_energy_avg_evening') | float(0) %}
              {% set k_night   = states('sensor.sem_energy_avg_night') | float(0) %}

              {% set ns = namespace(total=0, current=start) %}
              {% for i in range(0, 48) %}
                {% if ns.current >= end %}
                  {% break %}
                {% endif %}
                {% set hour = ns.current.hour %}
                {% if 5 <= hour < 10 %}
                  {% set kwh = k_morning %}
                {% elif 10 <= hour < 15 %}
                  {% set kwh = k_day %}
                {% elif 15 <= hour < 21 %}
                  {% set kwh = k_evening %}
                {% else %}
                  {% set kwh = k_night %}
                {% endif %}
                {% set ns.total = ns.total + kwh %}
                {% set ns.current = ns.current + timedelta(hours=1) %}
              {% endfor %}

              {{ ns.total | round(2) }}
            {% endif %}


# CALCULATES RELATIVE EXPENSIVE PRICE INTERVAL BETWEEN 02-14
  - trigger:
      - trigger: state
        entity_id: binary_sensor.sem_nordpool_tomorrow_prices_available
        to: 'on'
    sensor:
      - name: "sem_relative_expensive_price_2"
        unique_id: sem_relative_expensive_price_2
        state: >
          {% set data = (state_attr('sensor.sem_nordpool_active','raw_today') or []) +
                        (state_attr('sensor.sem_nordpool_active','raw_tomorrow') or []) %}
          {% set today = now().replace(hour=0, minute=0, second=0, microsecond=0) %}
          {% set interval_start = today + timedelta(days=1, hours=2) %}
          {% set interval_end   = today + timedelta(days=1, hours=14) %}
          {% set extend_hours = 5 %}
          
          {% set filtered = data
            | selectattr('start', 'defined')
            | selectattr('value', 'defined')
            | selectattr('start', '>=', interval_start.isoformat())
            | selectattr('start', '<', interval_end.isoformat())
            | list %}
          
          {% if filtered | length == 0 %}
            none
          {% else %}
            {% set values = filtered | map(attribute='value') | map('float') | list %}
            {% set max_value = values | max %}
            {% set peak_index = values.index(max_value) %}
            
            {# Hitta startindex bak√•t #}
            {% set start_index = peak_index %}
            {% for i in range(peak_index, -1, -1) %}
              {% if values[i] >= max_value %}
                {% set start_index = i %}
              {% else %}
                {% break %}
              {% endif %}
            {% endfor %}
            {% set start_index = [start_index - extend_hours, 0] | max %}
            
            {# Hitta slutindex fram√•t #}
            {% set end_index = peak_index %}
            {% for i in range(peak_index, (values | length)) %}
              {% if values[i] >= max_value %}
                {% set end_index = i %}
              {% else %}
                {% break %}
              {% endif %}
            {% endfor %}
            {% set end_index = [end_index + extend_hours, (filtered | length) - 1] | min %}
            
            {% set start_dt = as_datetime(filtered[start_index].start) %}
            {% set end_dt   = as_datetime(filtered[end_index].start) + timedelta(hours=1) %}
            {{ start_dt.isoformat() }} - {{ end_dt.isoformat() }}
          {% endif %}

        attributes:
          expensive_price: >
            {% set data = (state_attr('sensor.sem_nordpool_active','raw_today') or []) +
                          (state_attr('sensor.sem_nordpool_active','raw_tomorrow') or []) %}
            {% set today = now().replace(hour=0, minute=0, second=0, microsecond=0) %}
            {% set interval_start = today + timedelta(days=1, hours=2) %}
            {% set interval_end   = today + timedelta(days=1, hours=14) %}
            
            {% set filtered = data
              | selectattr('start', 'defined')
              | selectattr('value', 'defined')
              | selectattr('start', '>=', interval_start.isoformat())
              | selectattr('start', '<', interval_end.isoformat())
              | list %}
            
            {% if filtered | length == 0 %}
              none
            {% else %}
              {% set values = filtered | map(attribute='value') | map('float') | list %}
              {% set sorted_values = values | sort %}
              {% set idx = ((sorted_values | length) * 0.65) | round(0, 'floor') %}
              {{ sorted_values[idx] }}
            {% endif %}

          kwh_required: >
            {% set raw_interval = states('sensor.sem_relative_expensive_price_2') %}
            {% if ' - ' not in raw_interval %}
              0
            {% else %}
              {% set start = as_datetime(raw_interval.split(' - ')[0]) %}
              {% set end   = as_datetime(raw_interval.split(' - ')[1]) %}
              
              {# Avrunda start upp√•t till heltimme #}
              {% if start.minute > 0 or start.second > 0 %}
                {% set start = start.replace(minute=0, second=0, microsecond=0) + timedelta(hours=1) %}
              {% endif %}
              
              {# Avrunda slut ned√•t till heltimme #}
              {% set end = end.replace(minute=0, second=0, microsecond=0) %}
              {% if end <= start %}
                {% set end = end + timedelta(days=1) %}
              {% endif %}
              
              {% set k_morning = states('sensor.sem_energy_avg_morning') | float(0) %}
              {% set k_day     = states('sensor.sem_energy_avg_day') | float(0) %}
              {% set k_evening = states('sensor.sem_energy_avg_evening') | float(0) %}
              {% set k_night   = states('sensor.sem_energy_avg_night') | float(0) %}
              
              {% set ns = namespace(total=0, current=start) %}
              {% for i in range(0, 48) %}
                {% if ns.current >= end %}
                  {% break %}
                {% endif %}
                {% set hour = ns.current.hour %}
                {% if 5 <= hour < 10 %}
                  {% set kwh = k_morning %}
                {% elif 10 <= hour < 15 %}
                  {% set kwh = k_day %}
                {% elif 15 <= hour < 21 %}
                  {% set kwh = k_evening %}
                {% else %}
                  {% set kwh = k_night %}
                {% endif %}
                {% set ns.total = ns.total + kwh %}
                {% set ns.current = ns.current + timedelta(hours=1) %}
              {% endfor %}
              
              {{ ns.total | round(2) }}
            {% endif %}


# BUILDS A NORDPOOL SENSOR WITH THE OFFICIAL INTEGRATION
  - trigger:
      - trigger: time_pattern
        minutes: /15
      - trigger: homeassistant
        event: start

    action:
      - action: nordpool.get_prices_for_date
        data:
          config_entry: "{{ states('input_text.sem_nordpool_config_entry_official') }}"
          date: "{{ now().date() }}"
          areas: "{{ states('input_text.sem_nordpool_area_official') }}"
          currency: SEK
        response_variable: today_price

      - action: nordpool.get_prices_for_date
        data:
          config_entry: "{{ states('input_text.sem_nordpool_config_entry_official') }}"
          date: "{{ now().date() + timedelta(days=1) }}"
          areas: "{{ states('input_text.sem_nordpool_area_official') }}"
          currency: SEK
        response_variable: tomorrow_price

    sensor:
      - name: "sem_nordpool_sensor_official"
        unique_id: sem_nordpool_sensor_official
        unit_of_measurement: "SEK/kWh"
        state_class: "measurement"
        state: >
          {% set region = states('input_text.sem_nordpool_area_official') %}
          {% set data = today_price.get(region) if today_price is mapping else [] %}
          {% set now_utc = utcnow().strftime('%Y-%m-%dT%H:%M:%S+00:00') %}
          {% set current = data | selectattr('start', '<=', now_utc) | list | last %}
          {{ (current.price | float / 1000) | round(4) if current is mapping and 'price' in current else 0 }}

        attributes:
          region: "{{ states('input_text.sem_nordpool_area_official') }}"
          additional_costs_current_hour: "0"
          price_in_cents: "false"
          unit: "kWh"
          currency: "SEK"
          country: "Sweden"

          average: >
            {% set region = states('input_text.sem_nordpool_area_official') %}
            {% set prices = today_price.get(region, []) | map(attribute='price') | map('float') | list %}
            {{ ((prices | sum / (prices | length)) / 1000) | round(3) if prices else 0 }}

          off_peak_1: >
            {% set region = states('input_text.sem_nordpool_area_official') %}
            {% set prices = today_price.get(region, []) | map(attribute='price') | map('float') | list %}
            {{ ((prices[0:4] | sum / 4) / 1000) | round(3) if prices | length >= 4 else 0 }}

          off_peak_2: >
            {% set region = states('input_text.sem_nordpool_area_official') %}
            {% set prices = today_price.get(region, []) | map(attribute='price') | map('float') | list %}
            {{ ((prices[-2:] | sum / 2) / 1000) | round(3) if prices | length >= 2 else 0 }}

          peak: >
            {% set region = states('input_text.sem_nordpool_area_official') %}
            {% set prices = today_price.get(region, []) | map(attribute='price') | map('float') | list %}
            {{ ((prices[4:-2] | sum / ((prices | length) - 6)) / 1000) | round(3) if prices | length > 6 else 0 }}

          min: >
            {% set region = states('input_text.sem_nordpool_area_official') %}
            {% set prices = today_price.get(region, []) | map(attribute='price') | map('float') | list %}
            {{ (prices | min / 1000) | round(3) if prices else 0 }}

          max: >
            {% set region = states('input_text.sem_nordpool_area_official') %}
            {% set prices = today_price.get(region, []) | map(attribute='price') | map('float') | list %}
            {{ (prices | max / 1000) | round(3) if prices else 0 }}

          mean: >
            {% set region = states('input_text.sem_nordpool_area_official') %}
            {% set prices = today_price.get(region, []) | map(attribute='price') | map('float') | list %}
            {{ ((prices | sum / (prices | length)) / 1000) | round(3) if prices else 0 }}

          low_price: >
            {% set region = states('input_text.sem_nordpool_area_official') %}
            {% set prices = today_price.get(region, []) | map(attribute='price') | map('float') | list %}
            {{ (prices[0] < (prices | sum / (prices | length))) if prices else false }}

          price_percent_to_average: >
            {% set region = states('input_text.sem_nordpool_area_official') %}
            {% set prices = today_price.get(region, []) | map(attribute='price') | map('float') | list %}
            {{ ((prices[0] / (prices | sum / (prices | length))) | round(2)) if prices else 0 }}

          today: >
            {% set region = states('input_text.sem_nordpool_area_official') %}
            {{ today_price.get(region, []) | map(attribute='price') | map('float') | map('multiply', 0.001) | list }}

          tomorrow: >
            {% set region = states('input_text.sem_nordpool_area_official') %}
            {{ tomorrow_price.get(region, []) | map(attribute='price') | map('float') | map('multiply', 0.001) | list }}

          raw_today: >
            {%- set region = states('input_text.sem_nordpool_area_official') -%}
            [
            {%- for p in today_price.get(region, []) -%}
              {
                "start": "{{ p.start if p.start is string else p.start.isoformat() }}",
                "end": "{{ p.end if p.end is string else p.end.isoformat() }}",
                "value": {{ (p.price | float / 1000) | round(3) }}
              }{%- if not loop.last %},{% endif %}
            {%- endfor -%}
            ]

          raw_tomorrow: >
            {%- set region = states('input_text.sem_nordpool_area_official') -%}
            [
            {%- for p in tomorrow_price.get(region, []) -%}
              {
                "start": "{{ p.start if p.start is string else p.start.isoformat() }}",
                "end": "{{ p.end if p.end is string else p.end.isoformat() }}",
                "value": {{ (p.price | float / 1000) | round(3) }}
              }{%- if not loop.last %},{% endif %}
            {%- endfor -%}
            ]

          current_price: >
            {% set region = states('input_text.sem_nordpool_area_official') %}
            {% set data = today_price.get(region) if today_price is mapping else [] %}
            {% set now_utc = utcnow().strftime('%Y-%m-%dT%H:%M:%S+00:00') %}
            {% set current = data | selectattr('start', '<=', now_utc) | list | last %}
            {{ (current.price | float / 1000) | round(4) if current is mapping and 'price' in current else 0 }}

          tomorrow_valid: >
            {% set region = states('input_text.sem_nordpool_area_official') %}
            {{ (tomorrow_price.get(region) | count > 0) if tomorrow_price is mapping else false }}










  - trigger:
    # Trigger 1: N√§r nuvarande 1A-intervall √§r slut och morgondagens priser finns
    - trigger: template
      value_template: >
        {%- set window = states('sensor.sem_battery_charge_window_cheapest_1a') -%}
        {%- set tomorrow_available = is_state('binary_sensor.sem_nordpool_tomorrow_prices_available', 'on') -%}

        {%- if window not in ['none', 'unknown', 'unavailable', ''] -%}
          {%- set parts = window.split(' - ') -%}
          {%- if parts | length == 2 -%}
            {%- set end = parts[1] | as_datetime -%}
            {{ now() > end and tomorrow_available }}
          {%- else -%}
            false
          {%- endif -%}
        {%- else -%}
          false
        {%- endif -%}
    # Trigger 2: Klockan 18:00 varje dag
    - trigger: time
      at: '18:00:00'
    sensor:
      - name: "sem_battery_charge_window_cheapest_1a"
        state: >
          {%- set duration = states('sensor.sem_battery_dynamic_charge_time_window_1') | float(0) %}
          {%- set duration_quarters = (duration * 4) | int %}
          {%- set proxy_sensor_id = 'sensor.sem_nordpool_active' %}
          {%- set prices_tomorrow = state_attr(proxy_sensor_id, 'raw_tomorrow') or [] %}

          {%- if prices_tomorrow | length >= (16-9)*4 %}
            {%- set base_date = (now() + timedelta(days=1)).replace(hour=0, minute=0, second=0, microsecond=0) %}
            {%- set start_index = 9 * 4 %}
            {%- set end_index = (16 * 4) - duration_quarters %}

            {%- set ns = namespace(min_avg=None, start_index=None) %}
            {%- for i in range(start_index, end_index + 1) %}
              {%- set slice = prices_tomorrow[i:i + duration_quarters] %}
              {%- if slice | length == duration_quarters %}
                {%- set values = slice | map(attribute='value') | list %}
                {%- set avg = (values | sum) / duration_quarters %}
                {%- if ns.min_avg is none or avg < ns.min_avg %}
                  {%- set ns.min_avg = avg %}
                  {%- set ns.start_index = i %}
                {%- endif %}
              {%- endif %}
            {%- endfor %}

            {%- if ns.start_index is not none %}
              {%- set start_str = prices_tomorrow[ns.start_index].start %}
              {%- set start_time = start_str | as_datetime %}
              {%- set end_time = start_time + timedelta(minutes=duration_quarters*15) %}
              {{ start_time.isoformat() ~ ' - ' ~ end_time.isoformat() }}
            {%- else %}
              unavailable
            {%- endif %}
          {%- else %}
            unavailable
          {%- endif %}
        
  - trigger:
    # Trigger 1: Klockan 06:00 varje dag
      - trigger: time
        at: '06:00:00'
    # Trigger 2: N√§r morgondagens priser blir tillg√§ngliga
      - trigger: state
        entity_id: binary_sensor.sem_nordpool_tomorrow_prices_available
        to: 'on'
    sensor:
      - name: "sem_battery_charge_window_cheapest_2"
        state: >
          {%- set duration = states('sensor.sem_battery_dynamic_charge_time_window_2') | float(0) %}
          {%- set numberOfSequentialQuarters = (duration * 4) | int %}
          {%- set proxy_sensor_id = 'sensor.sem_nordpool_active' %}
          {%- set tomorrow_available = state_attr(proxy_sensor_id, 'raw_tomorrow') | length > 0 %}

          {%- if not tomorrow_available %}
            {# Fast intervall 02:00-04:00 #}
            {%- set base_date = (now() + timedelta(days=1)).replace(hour=0, minute=0, second=0, microsecond=0) %}
            {%- set start_time = base_date + timedelta(hours=2) %}
            {%- set end_time = start_time + timedelta(hours=2) %}
            {{ start_time.isoformat() ~ ' - ' ~ end_time.isoformat() }}

          {%- else %}
            {# H√§mta priser fr√•n proxysensor #}
            {%- set prices_today = state_attr(proxy_sensor_id, 'raw_today') or [] %}
            {%- set prices_tomorrow = state_attr(proxy_sensor_id, 'raw_tomorrow') or [] %}

            {# Filtrera priser: idag 23:00+ och imorgon 00-05 #}
            {%- set prices_today_filtered = prices_today[23*4:] %}
            {%- set prices_tomorrow_filtered = prices_tomorrow[0:5*4] %}
            {%- set combined_prices = prices_today_filtered + prices_tomorrow_filtered %}

            {%- set ns = namespace(min_avg=None, start_index=None) %}
            {%- for i in range(0, combined_prices | length - numberOfSequentialQuarters + 1) %}
              {%- set slice = combined_prices[i:i + numberOfSequentialQuarters] %}
              {%- set values = slice | map(attribute='value') | list %}
              {%- set avg = (values | sum) / numberOfSequentialQuarters %}
              {%- if ns.min_avg is none or avg < ns.min_avg %}
                {%- set ns.min_avg = avg %}
                {%- set ns.start_index = i %}
              {%- endif %}
            {%- endfor %}

            {%- if ns.start_index is not none %}
              {# H√§mta start och end-str√§ngar fr√•n proxysensorn och konvertera till datetime #}
              {%- set start_str = combined_prices[ns.start_index].start %}
              {%- set start_time = start_str | as_datetime %}
              {%- set end_str = combined_prices[ns.start_index + numberOfSequentialQuarters -1].end %}
              {%- set end_time = end_str | as_datetime %}
              {{ start_time.isoformat() ~ ' - ' ~ end_time.isoformat() }}
            {%- else %}
              Ingen giltigt intervall hittades
            {%- endif %}
          {%- endif %}

  
  # WEATHER FORCECAST DAILY
  - trigger:
      - trigger: time_pattern
        minutes: "/5"
      - trigger: homeassistant
        event: start
    action:
      - variables:
          weather_entity: "{{ states('input_text.sem_weather_sensor') }}"
      - action: weather.get_forecasts
        data:
          type: daily
        target:
          entity_id: "{{weather_entity}}"
        response_variable: weather_home_daily
    sensor:
      - name: "sem_weather_forecasts"
        state: "{{ states(weather_entity) }}"
        attributes:
          forecast: "{{ weather_home_daily[weather_entity].forecast }}"

  # WEATHER FORCECAST HOURLY       
  - trigger:
      - trigger: time_pattern
        minutes: "/5"
      - trigger: homeassistant
        event: start
    action:
      - variables:
          weather_entity: "{{ states('input_text.sem_weather_sensor') }}"
      - action: weather.get_forecasts
        data:
          type: hourly
        target:
          entity_id: "{{weather_entity}}"
        response_variable: weather_home_hourly
    sensor:
      - name: "sem_weather_forecasts_hourly"
        state: "{{ states(weather_entity) }}"
        attributes:
          forecast: "{{ weather_home_hourly[weather_entity].forecast }}"

  # STORE LOWEST TEMP
  - trigger:
      - trigger: time
        at: "00:03:00" 
    sensor:
      - name: "sem_temp_low"
        state: >
          {# H√§mta dagens l√§gsta temperatur fr√•n SMHI #}
          {% set forecast = state_attr('sensor.sem_weather_forecasts_hourly', 'forecast') %}
          {% if forecast %}
            {% set today_low = forecast | map(attribute='templow') | map('float') | min %}
            {{ today_low }}
          {% else %}
            {{ states('sensor.sem_temp_low') }}
          {% endif %}
        attributes:
          today: >
            {% set forecast = state_attr('sensor.sem_weather_forecasts_hourly', 'forecast') %}
            {% if forecast %}
              {{ forecast | map(attribute='templow') | map('float') | min }}
            {% else %}
              {{ states('sensor.sem_temp_low') }}
            {% endif %}
          yesterday: >
            {% set yesterday = state_attr('sensor.sem_temp_low', 'today') %}
            {{ yesterday if yesterday is not none else 0 }}
          day_before_yesterday: >
            {% set db_yesterday = state_attr('sensor.sem_temp_low', 'yesterday') %}
            {{ db_yesterday if db_yesterday is not none else 0 }}
          three_days_ago: >
            {% set three_days_ago = state_attr('sensor.sem_temp_low', 'day_before_yesterday') %}
            {{ three_days_ago if three_days_ago is not none else 0 }}
          source: sensor.sem_weather_forecasts_hourly


#CHECKS IF ELECTRIC PRICES ARE AVALIBLE
  - binary_sensor:
      - name: "sem_nordpool_tomorrow_prices_available"
        unique_id: "sem_nordpool_tomorrow_prices_available"
        state: >
          {% if is_state('input_boolean.sem_use_official_nordpool', 'on') %}
            {{ state_attr('sensor.sem_nordpool_sensor_official', 'tomorrow_valid') == true }}
          {% else %}
            {% set sensor_id = states('input_text.sem_nordpool_sensor_inofficial') %}
            {% if sensor_id %}
              {{ state_attr(sensor_id, 'tomorrow_valid') == true }}
            {% else %}
              false
            {% endif %}
          {% endif %}

#CHECKS IF SENSORS ARE AVALIBLE          
      - name: sem_huawei_sensor_available_control
        state: >
          {% set entities = [
            'sensor.batteries_state_of_capacity',
            'input_number.sem_batteries_end_of_discharge_soc',
            'sensor.inverter_input_power',
            'sensor.power_meter_active_power',
            'sensor.batteries_charge_discharge_power',
            'select.batteries_working_mode'
          ] %}
          {{ entities
              | map('states')
              | reject('in', ['unavailable', 'unknown'])
              | list
              | length == entities | length }}
