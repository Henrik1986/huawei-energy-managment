template:
  - sensor:
      - name: "Solar Power (with efficiency loss)"
        unique_id: input_power_with_efficiency_loss_kW
        unit_of_measurement: "kW"
        device_class: power
        state_class: measurement
        state: >-
          {% set inverter_rating = 10000 %}  {# W #}
          {% set inpower = states('sensor.inverter_input_power') | float(0) %}

          {% if inpower < (inverter_rating * 0.1) %}
              {{ (inpower * 0.90 / 1000) | round(2) }}
          {% elif inpower < (inverter_rating * 0.2) %}
              {{ (inpower * 0.95 / 1000) | round(2) }}
          {% else %}
              {{ (inpower * 0.98 / 1000) | round(2) }}
          {% endif %}


      - name: "House Power"
        unique_id: house_power
        unit_of_measurement: "kW"
        state: >
          {% set net_power = states('sensor.power_meter_active_power') | float(0) %}
          {% set import = -net_power if net_power < 0 else 0 %}
          {% set export = net_power if net_power > 0 else 0 %}

          {% set ev_sensor_id = states('input_text.ev_sensor') %}
          {% set ev_raw = states(ev_sensor_id) | float(0) if ev_sensor_id else 0 %}
          {% set ev = ev_raw / 1000 if ev_raw > 100 else ev_raw %}

          {# Use solar sensor from above #}
          {% set solar = states('sensor.input_power_with_efficiency_loss_kW') | float(0) %}

          {% set batt = states('sensor.batteries_charge_discharge_power') | float(0) %}
          {% set batt_out = -batt if batt < 0 else 0 %}
          {% set batt_in = batt if batt > 0 else 0 %}

          {% set house_power = (solar + import + batt_out) - (export + ev + batt_in) %}

          {{ [house_power, 0] | max | round(2) }}

      
      - name: "battery_dynamic_charge_time"
        unit_of_measurement: "h"
        state: >
          {%- set capacity = states('input_number.battery_total_capacity_kwh') | float(0) -%}
          {%- set charge_power_w = states('number.batteries_maximum_charging_power') | float(0) -%}
          {%- set charge_power_kw = charge_power_w / 1000 -%}
          {%- set required_hours = (capacity / charge_power_kw) | round(1) -%}
          {{ required_hours }}


  - trigger:
    - platform: state
      entity_id: input_button.update_battery_cheapest_charge
  - sensor:
    - name: "battery_charge_window_cheapest_1a"
      state: >
        {%- set duration = states('sensor.battery_dynamic_charge_time') | float(0) %}
        {%- set duration_quarters = (duration * 4) | int %}
        {%- set nordpool_sensor_id = states('input_text.nordpool_sensor') %}
        {%- set prices_today = state_attr(nordpool_sensor_id, 'raw_today') if nordpool_sensor_id else None %}

        {%- if duration >= 1 and prices_today is not none and prices_today | length >= (16*4) %}
          {%- set ns = namespace(min_avg=None, start_index=None) %}
          {%- set start_index = 14*4 %}
          {%- set end_index = (16*4) - duration_quarters %}
          {%- for i in range(start_index, end_index + 1) %}
            {%- set slice = prices_today[i:i + duration_quarters] %}
            {%- if slice | length == duration_quarters %}
              {%- set values = slice | map(attribute='value') | list %}
              {%- set avg = (values | sum) / duration_quarters %}
              {%- if ns.min_avg is none or avg < ns.min_avg %}
                {%- set ns.min_avg = avg %}
                {%- set ns.start_index = i %}
              {%- endif %}
            {%- endif %}
          {%- endfor %}
          {%- if ns.start_index is not none %}
            {%- set start_time = (now().replace(hour=0, minute=0, second=0, microsecond=0) + timedelta(minutes=ns.start_index*15)).astimezone() %}
            {%- set end_time = start_time + timedelta(minutes=duration_quarters*15) %}
            {{ start_time.isoformat() ~ ' - ' ~ end_time.isoformat() }}
          {%- else %}
            unavailable
          {%- endif %}
        {%- else %}
          unavailable
        {%- endif %}


